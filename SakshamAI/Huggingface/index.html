<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saksham Intelligence | Sahu MoE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <style>
      /* ===== iOS Keyboard & Viewport Fix ===== */
html, body {
  height: 100%;
  overflow: hidden;
}

@supports (-webkit-touch-callout: none) {
  .main-container {
    height: -webkit-fill-available;
  }
}
      @supports (padding: max(0px)) {
  .input-area,
  .sticky {
    padding-bottom: max(env(safe-area-inset-bottom), 12px);
  }
}
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
        
        :root {
            --slate-950: #020617;
            --slate-900: #0f172a;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--slate-950);
            color: #f1f5f9;
            overscroll-behavior-y: contain;
        }

        /* Mobile specific heights to prevent layout shifts */
        .main-container { height: 100dvh; display: flex; flex-direction: column; }
        .chat-area {
               flex: 1;
               overflow-y: auto;
               padding-bottom: 96px; /* space for keyboard */
               -webkit-overflow-scrolling: touch;
               overscroll-behavior: contain;
         }
        
        .sidebar-mobile {
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .sidebar-mobile.active { transform: translateX(0); }

        .message-user {
            background: #2563eb;
            color: white;
            align-self: flex-end;
            border-radius: 18px 18px 4px 18px;
            max-width: 85%;
        }

        .expert-card {
            background: #1e293b;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s;
        }

        .final-answer-box {
            background: linear-gradient(135deg, #0f172a 0%, #020617 100%);
            border: 1px solid rgba(59, 130, 246, 0.4);
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        }

        /* Markdown styling for mobile readability */
        .markdown-content { font-size: 14px; line-height: 1.6; }
        .markdown-content pre {
            background: #000;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            overflow-x: auto;
            font-size: 12px;
        }
        .markdown-content code { background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 4px; font-family: 'JetBrains Mono'; }

        .custom-scrollbar::-webkit-scrollbar { width: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-msg { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="overflow-hidden">

    <!-- Mobile Sidebar Overlay -->
    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-40 hidden"></div>

    <div class="main-container">
        <!-- Header -->
        <header class="h-16 flex items-center justify-between px-4 bg-slate-950/80 backdrop-blur-md border-b border-slate-800 shrink-0 z-30">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="p-2 hover:bg-slate-800 rounded-lg lg:hidden">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
                </button>
                <div>
                    <h1 id="header-title" class="text-sm font-bold text-white uppercase tracking-tight">Sahu 1 Agent</h1>
                    <div id="status-indicator" class="flex items-center gap-1.5 text-[10px] text-slate-500 font-semibold uppercase tracking-widest">
                        <span id="status-dot" class="w-1.5 h-1.5 rounded-full bg-red-500"></span>
                        <span id="status-text">Disconnected</span>
                    </div>
                </div>
            </div>
            <button onclick="openSettings()" class="p-2 text-slate-400 hover:text-white">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
            </button>
        </header>

        <div class="flex flex-1 overflow-hidden relative">
            <!-- Sidebar -->
            <aside id="sidebar" class="sidebar-mobile fixed inset-y-0 left-0 w-72 bg-slate-900 border-r border-slate-800 z-50 lg:relative lg:translate-x-0 lg:flex lg:flex-col">
                <div class="p-5 border-b border-slate-800 flex justify-between items-center">
                    <span class="text-xs font-black text-slate-500 uppercase tracking-widest">MoE Models</span>
                    <button onclick="toggleSidebar()" class="lg:hidden p-1 text-slate-500">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                <div id="moe-list" class="flex-1 overflow-y-auto p-3 space-y-2 custom-scrollbar">
                    <!-- JS Injected -->
                </div>
            </aside>

            <!-- Chat Area -->
            <div class="flex-1 flex flex-col min-w-0 bg-slate-950">
                <div id="chat-window" class="chat-area p-4 md:p-8 flex flex-col gap-6 custom-scrollbar">
                    <!-- Messages will be injected here -->
                    <div id="welcome-msg" class="my-auto text-center max-w-xs mx-auto space-y-4">
                        <div class="w-12 h-12 bg-blue-600/20 text-blue-500 rounded-2xl flex items-center justify-center mx-auto">
                            <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                        </div>
                        <h2 class="text-lg font-bold">Saksham Intelligence</h2>
                        <p class="text-xs text-slate-500 leading-relaxed">Select a Sahu 1 MoE model from the menu and start your multi-expert conversation.</p>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="p-3 bg-slate-950 border-t border-slate-800/50 sticky bottom-0 z-30">
                    <div class="max-w-4xl mx-auto">
                        <div id="typing-indicator" class="hidden h-6 text-[10px] text-blue-400 font-bold px-2 animate-pulse uppercase tracking-widest">Experts are thinking...</div>
                        <div class="flex gap-2 items-end bg-slate-900 rounded-2xl p-2 border border-slate-800 focus-within:border-blue-500/50 transition-all shadow-xl">
                            <textarea 
                                id="user-input" 
                                placeholder="Message Sahu 1..." 
                                rows="1"
                                class="flex-1 bg-transparent border-none focus:ring-0 px-3 py-2.5 text-sm resize-none custom-scrollbar min-h-[44px]"
                                oninput="autoGrow(this)"
                            ></textarea>
                            <button 
                                id="send-btn"
                                onclick="handleOrchestration()"
                                class="w-10 h-10 shrink-0 bg-blue-600 hover:bg-blue-500 rounded-xl flex items-center justify-center transition-all disabled:opacity-30 disabled:grayscale shadow-lg shadow-blue-500/20"
                            >
                                <svg width="18" height="18" fill="white" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/90 backdrop-blur-md z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-slate-900 w-full max-w-sm rounded-3xl border border-slate-800 p-6 shadow-2xl">
            <h3 class="text-lg font-bold mb-2">HF Token Config</h3>
            <p class="text-xs text-slate-500 mb-6">Required for multi-expert model routing.</p>
            <input type="password" id="hf-token-input" placeholder="hf_..." class="w-full bg-slate-950 border border-slate-800 rounded-xl px-4 py-3 text-sm mb-4 outline-none focus:ring-1 focus:ring-blue-500">
            <button onclick="saveToken()" class="w-full bg-blue-600 py-3.5 rounded-xl font-bold text-sm shadow-xl shadow-blue-500/10">Connect Gateway</button>
            <button onclick="closeSettings()" class="w-full mt-2 py-2 text-xs text-slate-500 font-medium">Cancel</button>
        </div>
    </div>
  <script>
let startX = 0;

document.addEventListener("touchstart", e => {
  startX = e.touches[0].clientX;
});

document.addEventListener("touchend", e => {
  const endX = e.changedTouches[0].clientX;
  if (startX < 40 && endX > 120) toggleSidebar();      // swipe open
  if (startX > 200 && endX < 80) toggleSidebar();      // swipe close
});

/* =========================================================
   SAHU 1-SERIES â€” OFFICIAL HF MODEL IDS
   ========================================================= */

const SAHU_MOE = {

  /* ==================== DEEP THINK ==================== */
  "Sahu 1 DeepThink": {
    tools: ["thinking"],
    experts: [
      "deepseek-ai/DeepSeek-R1",
      "openai/gpt-oss-120b",
      "deepseek-ai/DeepSeek-V3.2",
      "moonshotai/Kimi-K2-Thinking",
      "Qwen/Qwen3-235B-A22B-Thinking-2507-FP8",
      "zai-org/GLM-4.7",
      "mistralai/Ministral-3-14B-Reasoning-2512",
      "microsoft/Phi-4-reasoning-plus",
      "google/gemma-3n-E4B-it",
      "minimax/m2.1-preview" // logical alias if you add later
    ],
    aggregator: "zai-org/GLM-4.7",
    behavior: "extended-thinking"
  },

  /* ==================== DEEP RESEARCH ==================== */
  "Sahu 1 Deep Research": {
    tools: ["searching"],
    experts: [
      "openai/gpt-oss-20b",
      "deepseek-ai/DeepSeek-V3.2",
      "moonshotai/Kimi-K2-Instruct",
      "zai-org/GLM-4.7",
      "mistralai/Mistral-Small-3.2-24B-Instruct-2506",
      "mistralai/Mistral-7B-Instruct-v0.3",
      "XiaomiMiMo/MiMo-V2-Flash",
      "google/gemma-3n-E4B-it"
    ],
    aggregator: "XiaomiMiMo/MiMo-V2-Flash",
    behavior: "search-and-synthesize"
  },

  /* ==================== CODE ==================== */
  "Sahu Code 1": {
    tools: ["thinking", "searching", "planning"],
    experts: [
      "openai/gpt-oss-120b",
      "deepseek-ai/DeepSeek-V3.2",
      "moonshotai/Kimi-K2-Thinking",
      "Qwen/Qwen3-Coder-480B-A35B-Instruct",
      "Qwen/Qwen3-235B-A22B-Thinking-2507-FP8",
      "deepseek-ai/DeepSeek-Coder-V2-Lite-Instruct",
      "zai-org/GLM-4.7",
      "mistralai/Devstral-2-123B-Instruct-2512",
      "mistralai/Codestral-22B-v0.1"
    ],
    aggregator: "zai-org/GLM-4.7",
    behavior: "code-reason-plan"
  },

  /* ==================== FAST ==================== */
  "Sahu 1 Fast": {
    tools: [],
    experts: [
      "openai/gpt-oss-20b",
      "deepseek-ai/DeepSeek-V3.2",
      "moonshotai/Kimi-K2-Instruct",
      "zai-org/GLM-4.7-Flash",
      "mistralai/Mistral-Small-3.2-24B-Instruct-2506",
      "deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B",
      "XiaomiMiMo/MiMo-V2-Flash",
      "google/gemma-3n-E4B-it"
    ],
    aggregator: "XiaomiMiMo/MiMo-V2-Flash",
    behavior: "no-thinking"
  },

  /* ==================== CHAT ==================== */
  "Sahu 1 Chat": {
    tools: [],
    experts: [
      "openai/gpt-oss-20b",
      "deepseek-ai/DeepSeek-V3.2",
      "moonshotai/Kimi-K2-Instruct",
      "zai-org/GLM-4.7",
      "mistralai/Mistral-Small-3.2-24B-Instruct-2506",
      "mistralai/Mistral-7B-Instruct-v0.3",
      "XiaomiMiMo/MiMo-V2-Flash",
      "google/gemma-3n-E4B-it"
    ],
    aggregator: "XiaomiMiMo/MiMo-V2-Flash",
    behavior: "general-chat"
  },

  /* ==================== AGENT (MoE of MoEs) ==================== */
  "Sahu 1 Agent": {
    tools: [],
    experts: [
      "Sahu 1 DeepThink",
      "Sahu Code 1",
      "Sahu 1 Deep Research",
      "Sahu 1 Chat",
      "Sahu 1 Fast"
    ],
    aggregator: "auto",
    behavior: "auto-routing"
  }

};

        let selectedMoe = MOE_CONFIG[0];
        let hfToken = localStorage.getItem('HF_ACCESS_TOKEN') || "";

        function init() {
            const list = document.getElementById('moe-list');
            list.innerHTML = MOE_CONFIG.map(m => `
                <button onclick="selectMoe('${m.id}')" id="btn-${m.id}" class="w-full text-left p-4 rounded-xl transition-all border border-transparent ${selectedMoe.id === m.id ? 'bg-blue-600/10 border-blue-500/30 text-white' : 'text-slate-400 hover:bg-slate-800/50'}">
                    <div class="text-[13px] font-bold">${m.name}</div>
                    <div class="text-[10px] opacity-60">${m.desc}</div>
                </button>
            `).join('');
            
            updateConnectionStatus();
            if (!hfToken) openSettings();
        }

        function selectMoe(id) {
            selectedMoe = MOE_CONFIG.find(m => m.id === id);
            document.getElementById('header-title').textContent = selectedMoe.name;
            init();
            if (window.innerWidth < 1024) toggleSidebar();
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('sidebar-overlay').classList.toggle('hidden');
        }

        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
        function saveToken() {
            hfToken = document.getElementById('hf-token-input').value.trim();
            localStorage.setItem('HF_ACCESS_TOKEN', hfToken);
            updateConnectionStatus();
            closeSettings();
        }

        function updateConnectionStatus() {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            if (hfToken) {
                dot.className = "w-1.5 h-1.5 rounded-full bg-green-500 shadow-[0_0_8px_#22c55e]";
                text.textContent = "Gateway Ready";
                text.classList.replace('text-slate-500', 'text-green-500');
            } else {
                dot.className = "w-1.5 h-1.5 rounded-full bg-red-500";
                text.textContent = "Disconnected";
                text.classList.replace('text-green-500', 'text-slate-500');
            }
        }

        function autoGrow(el) {
            el.style.height = 'auto';
            el.style.height = (el.scrollHeight) + 'px';
        }

        function appendUserMsg(text) {
            const win = document.getElementById('chat-window');
            const msg = document.createElement('div');
            msg.className = "message-user p-4 text-sm animate-msg";
            msg.textContent = text;
            win.appendChild(msg);
            win.scrollTo({ top: win.scrollHeight, behavior: 'smooth' });
        }

        async function handleOrchestration() {
            const input = document.getElementById('user-input');
            const query = input.value.trim();
            if (!query || !hfToken) return;

            document.getElementById('welcome-msg')?.remove();
            input.value = "";
            input.style.height = 'auto';
            appendUserMsg(query);

            let activeMoe = selectedMoe;
            if (selectedMoe.type === 'agent') {
                activeMoe = autoRoute(query);
                appendSystemBadge(`Agent Routed to ${activeMoe.name}`);
              if (window.innerWidth < 1024) {
                document.getElementById('sidebar')?.classList.remove('active');
                document.getElementById('sidebar-overlay')?.classList.add('hidden');
            }

            document.getElementById('typing-indicator').classList.remove('hidden');
            const sessionID = Date.now();
            const container = createSessionUI(sessionID, activeMoe);

            // Parallel Expert Execution
            const expertPromises = activeMoe.experts.map((model, idx) => 
                runExpert(model, query, sessionID, idx + 1)
            );

            const expertAnswers = await Promise.all(expertPromises);
            
            // Final Synthesis
            const synthesisPrompt = `You are a high-capable master model for Saksham Intelligence. 
            Synthesize the following expert contributions into a final, comprehensive answer for the user query: "${query}"
            
            Contributions:
            ${expertAnswers.map((a, i) => `Expert ${i+1}: ${a}`).join('\n\n')}`;

            await runFinalSynthesis(activeMoe.final, synthesisPrompt, sessionID);
            document.getElementById('typing-indicator').classList.add('hidden');
        }

        function autoRoute(q) {
            const l = q.toLowerCase();
            if (l.includes('code') || l.includes('function') || l.includes('script')) return MOE_CONFIG.find(m => m.id === 'sahu-code-1');
            if (l.includes('think') || l.includes('math') || l.includes('why')) return MOE_CONFIG.find(m => m.id === 'sahu-1-deepthink');
            if (l.includes('search') || l.includes('who is') || l.includes('news')) return MOE_CONFIG.find(m => m.id === 'sahu-1-deepresearch');
            return MOE_CONFIG.find(m => m.id === 'sahu-1-chat');
        }

        function createSessionUI(id, moe) {
            const win = document.getElementById('chat-window');
            const wrap = document.createElement('div');
            wrap.className = "flex flex-col gap-4 mb-10";
            wrap.innerHTML = `
                <div class="flex items-center gap-2 opacity-40">
                    <div class="h-px flex-1 bg-slate-700"></div>
                    <span class="text-[9px] font-black uppercase tracking-[0.2em]">${moe.name}</span>
                    <div class="h-px flex-1 bg-slate-700"></div>
                </div>
                <div id="experts-grid-${id}" class="flex flex-col gap-3"></div>
                <div id="final-box-${id}" class="final-answer-box p-5 hidden animate-msg">
                    <div class="flex items-center gap-2 mb-4 text-blue-400">
                        <div class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></div>
                        <span class="text-[10px] font-black uppercase">Final Synthesis</span>
                    </div>
                    <div class="markdown-content text-slate-200" id="final-text-${id}">Generating...</div>
                </div>
            `;
            win.appendChild(wrap);
            win.scrollTo({ top: win.scrollHeight, behavior: 'smooth' });
            return wrap;
        }

        async function runExpert(model, q, sessionID, idx) {
            const grid = document.getElementById(`experts-grid-${sessionID}`);
            const card = document.createElement('div');
            card.className = "expert-card p-4 animate-msg";
            card.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                    <span class="text-[9px] font-black text-slate-500 uppercase tracking-tighter">Expert ${idx} (Saksham Intelligence)</span>
                    <span class="text-[8px] text-slate-600 font-mono">${model.split('/')[1]}</span>
                </div>
                <div class="text-[13px] text-slate-400 loading-pulse">Consulting expert...</div>
                <div class="expert-res hidden markdown-content text-slate-300"></div>
            `;
            grid.appendChild(card);
            document.getElementById('chat-window').scrollTo({ top: document.getElementById('chat-window').scrollHeight, behavior: 'smooth' });

            // Identity check logic
            const lq = q.toLowerCase();
            if (lq.includes('who are you') || lq.includes('creator') || lq.includes('developer')) {
                const identity = `Expert ${idx} Developed by Saksham Intelligence. Part of the Sahu 1-series MoE infrastructure.`;
                updateCard(card, identity);
                return identity;
            }

            try {
                const res = await fetch("https://router.huggingface.co/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${hfToken}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: "user", content: q }],
                        max_tokens: 800
                    })
                });
                const data = await res.json();
                const output = data.choices?.[0]?.message?.content || "Expert unavailable.";
                updateCard(card, output);
                return output;
            } catch (e) {
                updateCard(card, "Gateway connection error.");
                return "Expert Offline";
            }
        }

        function updateCard(card, text) {
            card.querySelector('.loading-pulse')?.remove();
            const res = card.querySelector('.expert-res');
            res.classList.remove('hidden');
            res.innerHTML = marked.parse(text);
        }

        async function runFinalSynthesis(model, prompt, sessionID) {
            const box = document.getElementById(`final-box-${sessionID}`);
            const target = document.getElementById(`final-text-${sessionID}`);
            box.classList.remove('hidden');
            
            try {
                const res = await fetch("https://router.huggingface.co/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${hfToken}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: "user", content: prompt }],
                        max_tokens: 1500
                    })
                });
                const data = await res.json();
                target.innerHTML = marked.parse(data.choices?.[0]?.message?.content || "Could not synthesize experts.");
            } catch (e) {
                target.innerHTML = "Final synthesis failed due to network error.";
            }
            document.getElementById('chat-window').scrollTo({ top: document.getElementById('chat-window').scrollHeight, behavior: 'smooth' });
        }

        function appendSystemBadge(txt) {
            const win = document.getElementById('chat-window');
            const b = document.createElement('div');
            b.className = "text-[9px] text-center text-slate-600 font-black uppercase tracking-[0.3em] py-2";
            b.textContent = txt;
            win.appendChild(b);
        }

        init();
    </script>
</body>
</html>
