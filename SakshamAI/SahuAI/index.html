<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAHU 1 MoE - Mixture of Experts</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.2.0/docx.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pptxgenjs/3.12.0/pptxgen.bundle.min.js"></script>
    <style>
        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #252525;
            --text-primary: #e5e5e5;
            --text-secondary: #a3a3a3;
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --border: #333;
        }
        .light-mode {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e5e5e5;
            --text-primary: #1a1a1a;
            --text-secondary: #525252;
            --accent: #4f46e5;
            --accent-hover: #6366f1;
            --border: #d4d4d4;
        }
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .sidebar {
            background-color: var(--bg-secondary);
            border-color: var(--border);
        }
        .chat-container {
            background-color: var(--bg-primary);
        }
        .message-user {
            background-color: var(--accent);
        }
        .message-assistant {
            background-color: var(--bg-tertiary);
        }
        .input-area {
            background-color: var(--bg-secondary);
            border-color: var(--border);
        }
        .expert-card {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border);
            position: relative;
        }
        .expert-card.thinking {
            border-color: #f59e0b;
            animation: pulse-border 2s infinite;
        }
        .expert-card.thinking::before {
            content: 'üß†';
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 16px;
            animation: bounce 1s infinite;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .expert-card.searching {
            border-color: #3b82f6;
            animation: pulse-search 2s infinite;
        }
        .expert-card.complete {
            border-color: #22c55e;
        }
        .expert-card.error {
            border-color: #ef4444;
        }
        @keyframes pulse-search {
            0%, 100% { border-color: #3b82f6; box-shadow: 0 0 5px rgba(59, 130, 246, 0.3); }
            50% { border-color: #60a5fa; box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }
        }
        .weight-high { background-color: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .weight-medium { background-color: rgba(234, 179, 8, 0.2); color: #eab308; }
        .weight-low { background-color: rgba(156, 163, 175, 0.2); color: #9ca3af; }
        
        @keyframes pulse-border {
            0%, 100% { border-color: #f59e0b; box-shadow: 0 0 5px rgba(245, 158, 11, 0.3); }
            50% { border-color: #fbbf24; box-shadow: 0 0 15px rgba(245, 158, 11, 0.5); }
        }
        .typing-indicator span {
            animation: typing 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }
        .tool-log {
            background-color: var(--bg-secondary);
            border-left: 3px solid var(--accent);
        }
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
        .provider-menu {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border);
        }
        .dropdown-item:hover {
            background-color: var(--bg-tertiary);
        }
        pre code {
            display: block;
            padding: 1rem;
            background: #1e1e1e;
            border-radius: 0.5rem;
            overflow-x: auto;
        }
        .aggregator-response {
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, rgba(99, 102, 241, 0.1) 100%);
            border: 2px solid var(--accent);
        }
        
        .streaming-cursor::after {
            content: '‚ñä';
            animation: blink 1s infinite;
            color: var(--accent);
            margin-left: 2px;
        }
        
        .streaming-cursor.complete::after {
            display: none;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        .notification-toast {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .reasoning-block {
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.1) 0%, rgba(234, 179, 8, 0.05) 100%);
            border: 1px solid rgba(234, 179, 8, 0.3);
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.75rem;
        }
        
        /* File Preview Styles */
        .file-preview-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }
        .file-preview-header {
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .file-preview-tabs {
            display: flex;
            gap: 4px;
        }
        .file-preview-tab {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .file-preview-tab.active {
            background: var(--accent);
            color: white;
        }
        .file-preview-tab:not(.active):hover {
            background: var(--bg-secondary);
        }
        .file-preview-content {
            padding: 16px;
            max-height: 500px;
            overflow-y: auto;
        }
        .file-preview-iframe {
            width: 100%;
            height: 400px;
            border: none;
            background: white;
            border-radius: 8px;
        }
        
        /* Export Button Styles */
        .export-btn-group {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }
        .export-btn {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .export-btn:hover {
            transform: translateY(-1px);
        }
        .export-btn.pdf { background: #dc2626; color: white; }
        .export-btn.docx { background: #2563eb; color: white; }
        .export-btn.xlsx { background: #16a34a; color: white; }
        .export-btn.pptx { background: #ea580c; color: white; }
        .export-btn.txt { background: #6b7280; color: white; }
        .export-btn.copy { background: var(--accent); color: white; }
        
        /* File Format Selector */
        .file-format-selector {
            display: flex;
            gap: 6px;
            padding: 8px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 12px;
        }
        .file-format-btn {
            padding: 6px 12px;
            font-size: 11px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--border);
        }
        .file-format-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        .file-format-btn:not(.active):hover {
            background: var(--bg-secondary);
        }
    </style>
</head>
<body class="h-screen overflow-hidden">
    <div id="app" class="flex h-full">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar w-64 h-full flex flex-col border-r transition-all duration-300">
            <div class="p-4 border-b border-[var(--border)]">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                        <i class="fas fa-brain text-white"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg">SAHU 1</h1>
                        <p class="text-xs text-[var(--text-secondary)]">Mixture of Experts</p>
                    </div>
                </div>
            </div>

            <div class="p-3">
                <button onclick="newChat()" class="w-full py-2.5 px-4 rounded-lg bg-[var(--accent)] hover:bg-[var(--accent-hover)] text-white font-medium flex items-center justify-center gap-2 transition-colors">
                    <i class="fas fa-plus"></i>
                    New Chat
                </button>
            </div>

            <div class="px-3 pb-3">
                <label class="text-xs text-[var(--text-secondary)] mb-1 block">MoE Configuration</label>
                <select id="moeSelector" onchange="changeMoE()" class="w-full p-2.5 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] text-sm focus:outline-none focus:border-[var(--accent)]">
                    <option value="agent">ü§ñ Sahu 1 Agent</option>
                    <option value="deepthink">üß† Sahu 1 DeepThink</option>
                    <option value="deepresearch">üîç Sahu 1 Deep Research</option>
                    <option value="code">üíª Sahu 1 Code</option>
                    <option value="fast">‚ö° Sahu 1 Fast</option>
                    <option value="chat">üí¨ Sahu 1 Chat</option>
                </select>
            </div>

            <!-- File Format Selector (for DeepThink/DeepResearch) -->
            <div id="fileFormatSection" class="px-3 pb-3 hidden">
                <label class="text-xs text-[var(--text-secondary)] mb-1 block">Output Format</label>
                <div class="file-format-selector">
                    <button class="file-format-btn active" data-format="off" onclick="setFileFormat('off')">Off</button>
                    <button class="file-format-btn" data-format="txt" onclick="setFileFormat('txt')">TXT</button>
                    <button class="file-format-btn" data-format="pdf" onclick="setFileFormat('pdf')">PDF</button>
                    <button class="file-format-btn" data-format="docx" onclick="setFileFormat('docx')">Word</button>
                    <button class="file-format-btn" data-format="xlsx" onclick="setFileFormat('xlsx')">Excel</button>
                    <button class="file-format-btn" data-format="pptx" onclick="setFileFormat('pptx')">PPT</button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto scrollbar-thin px-3">
                <p class="text-xs text-[var(--text-secondary)] mb-2">History</p>
                <div id="chatHistory" class="space-y-1"></div>
            </div>

            <div class="p-3 border-t border-[var(--border)]">
                <button onclick="openSettings()" class="w-full py-2 px-3 rounded-lg hover:bg-[var(--bg-tertiary)] flex items-center gap-3 transition-colors">
                    <i class="fas fa-cog text-[var(--text-secondary)]"></i>
                    <span class="text-sm">Settings</span>
                </button>
                <button onclick="toggleTheme()" class="w-full py-2 px-3 rounded-lg hover:bg-[var(--bg-tertiary)] flex items-center gap-3 transition-colors">
                    <i id="themeIcon" class="fas fa-moon text-[var(--text-secondary)]"></i>
                    <span class="text-sm" id="themeText">Dark Mode</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-full">
            <header class="h-14 border-b border-[var(--border)] flex items-center justify-between px-4">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="p-2 rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors">
                        <i class="fas fa-bars"></i>
                    </button>
                    <span id="currentMoELabel" class="font-medium">ü§ñ Sahu 1 Agent</span>
                    <span id="expertCount" class="text-xs bg-[var(--accent)] text-white px-2 py-0.5 rounded-full">Auto</span>
                </div>
                
                <div class="relative">
                    <button onclick="toggleProviderMenu()" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors">
                        <i class="fas fa-cloud"></i>
                        <span id="currentProvider" class="text-sm">HuggingFace</span>
                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>
                    <div id="providerMenu" class="provider-menu absolute right-0 top-full mt-2 w-56 rounded-lg shadow-xl z-50 hidden">
                        <div class="p-2">
                            <div onclick="selectProvider('huggingface')" class="dropdown-item px-3 py-2 rounded-lg cursor-pointer flex items-center gap-3">
                                <i class="fas fa-fire text-orange-400"></i>
                                <span>HuggingFace</span>
                                <i class="fas fa-check ml-auto text-green-400 provider-check" data-provider="huggingface"></i>
                            </div>
                            <div onclick="selectProvider('novita')" class="dropdown-item px-3 py-2 rounded-lg cursor-pointer flex items-center gap-3">
                                <i class="fas fa-rocket text-purple-400"></i>
                                <span>Novita AI</span>
                                <i class="fas fa-check ml-auto text-green-400 provider-check hidden" data-provider="novita"></i>
                            </div>
                            <div onclick="selectProvider('publicai')" class="dropdown-item px-3 py-2 rounded-lg cursor-pointer flex items-center gap-3">
                                <i class="fas fa-globe text-blue-400"></i>
                                <span>Public AI</span>
                                <i class="fas fa-check ml-auto text-green-400 provider-check hidden" data-provider="publicai"></i>
                            </div>
                            <div onclick="selectProvider('groq')" class="dropdown-item px-3 py-2 rounded-lg cursor-pointer flex items-center gap-3">
                                <i class="fas fa-bolt text-yellow-400"></i>
                                <span>Groq</span>
                                <i class="fas fa-check ml-auto text-green-400 provider-check hidden" data-provider="groq"></i>
                            </div>
                            <div onclick="selectProvider('togetherai')" class="dropdown-item px-3 py-2 rounded-lg cursor-pointer flex items-center gap-3">
                                <i class="fas fa-cubes text-pink-400"></i>
                                <span>TogetherAI</span>
                                <i class="fas fa-check ml-auto text-green-400 provider-check hidden" data-provider="togetherai"></i>
                            </div>
                            <div onclick="selectProvider('ollama')" class="dropdown-item px-3 py-2 rounded-lg cursor-pointer flex items-center gap-3">
                                <i class="fas fa-server text-green-400"></i>
                                <span>Ollama (Local)</span>
                                <i class="fas fa-check ml-auto text-green-400 provider-check hidden" data-provider="ollama"></i>
                            </div>
                            <hr class="my-2 border-[var(--border)]">
                            <div onclick="openProviderSettings()" class="dropdown-item px-3 py-2 rounded-lg cursor-pointer flex items-center gap-3">
                                <i class="fas fa-key text-[var(--text-secondary)]"></i>
                                <span>API Keys</span>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <div id="chatArea" class="flex-1 overflow-y-auto scrollbar-thin p-4">
                <div id="welcomeScreen" class="h-full flex flex-col items-center justify-center">
                    <div class="w-20 h-20 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center mb-6">
                        <i class="fas fa-brain text-3xl text-white"></i>
                    </div>
                    <h2 class="text-2xl font-bold mb-2">SAHU 1 MoE</h2>
                    <p class="text-[var(--text-secondary)] mb-8 text-center max-w-md">
                        Orchestrate multiple AI experts with weighted voting and meta-reasoning synthesis.
                    </p>
                    <div class="grid grid-cols-2 gap-3 max-w-lg">
                        <button onclick="quickPrompt('Explain quantum computing')" class="p-4 rounded-xl bg-[var(--bg-tertiary)] hover:bg-[var(--border)] text-left transition-colors">
                            <i class="fas fa-atom text-indigo-400 mb-2"></i>
                            <p class="text-sm">Explain quantum computing</p>
                        </button>
                        <button onclick="quickPrompt('Write a Python web scraper')" class="p-4 rounded-xl bg-[var(--bg-tertiary)] hover:bg-[var(--border)] text-left transition-colors">
                            <i class="fas fa-code text-green-400 mb-2"></i>
                            <p class="text-sm">Write a Python web scraper</p>
                        </button>
                        <button onclick="quickPrompt('Research latest AI developments')" class="p-4 rounded-xl bg-[var(--bg-tertiary)] hover:bg-[var(--border)] text-left transition-colors">
                            <i class="fas fa-search text-blue-400 mb-2"></i>
                            <p class="text-sm">Research latest AI developments</p>
                        </button>
                        <button onclick="quickPrompt('Create a business plan outline')" class="p-4 rounded-xl bg-[var(--bg-tertiary)] hover:bg-[var(--border)] text-left transition-colors">
                            <i class="fas fa-briefcase text-yellow-400 mb-2"></i>
                            <p class="text-sm">Create a business plan outline</p>
                        </button>
                    </div>
                </div>

                <div id="messagesContainer" class="hidden space-y-6 max-w-5xl mx-auto"></div>
            </div>

            <div class="p-4 border-t border-[var(--border)]">
                <div class="max-w-4xl mx-auto">
                    <div class="input-area rounded-2xl border p-3">
                        <div class="flex items-end gap-3">
                            <label class="cursor-pointer p-2 rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors">
                                <i class="fas fa-plus text-[var(--text-secondary)]"></i>
                                <input type="file" id="fileInput" class="hidden" multiple onchange="handleFileUpload(event)">
                            </label>
                            <div id="attachmentPreview" class="hidden flex gap-2 flex-wrap"></div>
                            <textarea 
                                id="userInput" 
                                placeholder="Message SAHU 1 MoE..." 
                                class="flex-1 bg-transparent resize-none outline-none max-h-40 text-sm"
                                rows="1"
                                onkeydown="handleKeyDown(event)"
                                oninput="autoResize(this)"
                            ></textarea>
                            <button onclick="sendMessage()" id="sendBtn" class="p-2.5 rounded-xl bg-[var(--accent)] hover:bg-[var(--accent-hover)] text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-center text-[var(--text-secondary)] mt-2">
                        SAHU 1 MoE uses weighted expert voting and meta-reasoning synthesis.
                    </p>
                </div>
            </div>
        </main>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden shadow-2xl">
            <div class="flex items-center justify-between p-4 border-b border-[var(--border)] bg-[var(--bg-tertiary)]">
                <h2 class="text-lg font-bold flex items-center gap-2">
                    <i class="fas fa-cog text-[var(--accent)]"></i>
                    Settings
                </h2>
                <button onclick="closeSettings()" class="p-2 rounded-lg hover:bg-[var(--bg-secondary)] transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4 overflow-y-auto max-h-[65vh] scrollbar-thin">
                <div id="settingsContent">
                    <div class="mb-6 bg-[var(--bg-tertiary)] rounded-xl p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-medium flex items-center gap-2">
                                <i class="fas fa-key text-[var(--accent)]"></i>
                                API Keys & Endpoints
                            </h3>
                            <button onclick="saveSettings()" class="px-4 py-2 text-sm rounded-lg bg-[var(--accent)] hover:bg-[var(--accent-hover)] text-white transition-colors flex items-center gap-2 font-medium">
                                <i class="fas fa-save"></i>
                                Save All
                            </button>
                        </div>
                        <div class="space-y-4">
                            <!-- HuggingFace -->
                            <div class="p-3 bg-[var(--bg-secondary)] rounded-lg">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fas fa-fire text-orange-400"></i>
                                    <span class="font-medium text-sm">HuggingFace</span>
                                </div>
                                <div class="space-y-2">
                                    <input type="password" id="hfApiKey" placeholder="API Key: hf_..." class="w-full p-2.5 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none">
                                    <input type="text" id="hfEndpoint" placeholder="https://router.huggingface.co/v1/chat/completions" class="w-full p-2.5 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none">
                                </div>
                            </div>
                            <!-- Novita AI -->
                            <div class="p-3 bg-[var(--bg-secondary)] rounded-lg">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fas fa-rocket text-purple-400"></i>
                                    <span class="font-medium text-sm">Novita AI</span>
                                </div>
                                <div class="space-y-2">
                                    <input type="password" id="novitaApiKey" placeholder="API Key..." class="w-full p-2.5 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none">
                                    <input type="text" id="novitaEndpoint" placeholder="https://api.novita.ai/v3/openai/chat/completions" class="w-full p-2.5 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none">
                                </div>
                            </div>
                            <!-- Public AI -->
                            <div class="p-3 bg-[var(--bg-secondary)] rounded-lg">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fas fa-globe text-blue-400"></i>
                                    <span class="font-medium text-sm">Public AI</span>
                                </div>
                                <div class="space-y-2">
                                    <input type="password" id="publicaiApiKey" placeholder="API Key..." class="w-full p-2.5 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none">
                                    <input type="text" id="publicaiEndpoint" placeholder="https://api.publicai.io/v1/chat/completions" class="w-full p-2.5 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none">
                                </div>
                            </div>
                            <!-- Groq -->
                            <div class="p-3 bg-[var(--bg-secondary)] rounded-lg">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fas fa-bolt text-yellow-400"></i>
                                    <span class="font-medium text-sm">Groq</span>
                                </div>
                                <div class="space-y-2">
                                    <input type="password" id="groqApiKey" placeholder="API Key: gsk_..." class="w-full p-2.5 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none">
                                    <input type="text" id="groqEndpoint" placeholder="https://api.groq.com/openai/v1/chat/completions" class="w-full p-2.5 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none">
                                </div>
                            </div>
                            <!-- TogetherAI -->
                            <div class="p-3 bg-[var(--bg-secondary)] rounded-lg">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fas fa-cubes text-pink-400"></i>
                                    <span class="font-medium text-sm">TogetherAI</span>
                                </div>
                                <div class="space-y-2">
                                    <input type="password" id="togetherApiKey" placeholder="API Key..." class="w-full p-2.5 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none">
                                    <input type="text" id="togetherEndpoint" placeholder="https://api.together.xyz/v1/chat/completions" class="w-full p-2.5 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none">
                                </div>
                            </div>
                            <!-- Ollama -->
                            <div class="p-3 bg-[var(--bg-secondary)] rounded-lg">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fas fa-server text-green-400"></i>
                                    <span class="font-medium text-sm">Ollama (Local)</span>
                                </div>
                                <input type="text" id="ollamaEndpoint" placeholder="http://localhost:11434/api/chat" class="w-full p-2.5 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6 bg-[var(--bg-tertiary)] rounded-xl p-4">
                        <h3 class="font-medium mb-4 flex items-center gap-2">
                            <i class="fas fa-sliders-h text-[var(--accent)]"></i>
                            Advanced Settings
                        </h3>
                        <div class="space-y-4">
                            <div class="flex items-center gap-4">
                                <div class="flex-1">
                                    <label class="text-sm text-[var(--text-secondary)] mb-1 block">Max Tokens</label>
                                    <input type="number" id="maxTokens" value="4096" class="w-full p-2.5 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none">
                                </div>
                                <div class="flex-1">
                                    <label class="text-sm text-[var(--text-secondary)] mb-1 block">Temperature: <span id="tempValue">0.7</span></label>
                                    <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.7" class="w-full accent-[var(--accent)]">
                                </div>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-[var(--bg-secondary)] rounded-lg">
                                <div>
                                    <span class="text-sm font-medium">Stream Responses</span>
                                    <p class="text-xs text-[var(--text-secondary)]">Show aggregator response word by word</p>
                                </div>
                                <input type="checkbox" id="streamResponses" checked class="w-5 h-5 accent-[var(--accent)]">
                            </div>
                            <div class="flex items-center justify-between p-3 bg-[var(--bg-secondary)] rounded-lg">
                                <div>
                                    <span class="text-sm font-medium">Show Expert Outputs</span>
                                    <p class="text-xs text-[var(--text-secondary)]">Display individual expert responses</p>
                                </div>
                                <input type="checkbox" id="showExperts" checked class="w-5 h-5 accent-[var(--accent)]">
                            </div>
                            <div class="flex items-center justify-between p-3 bg-[var(--bg-secondary)] rounded-lg">
                                <div>
                                    <span class="text-sm font-medium">Show Aggregator Reasoning</span>
                                    <p class="text-xs text-[var(--text-secondary)]">Display meta-reasoning process</p>
                                </div>
                                <input type="checkbox" id="showReasoning" checked class="w-5 h-5 accent-[var(--accent)]">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-[var(--border)] bg-[var(--bg-tertiary)] flex justify-between items-center">
                <span class="text-xs text-[var(--text-secondary)]">
                    <i class="fas fa-info-circle mr-1"></i>
                    All settings are stored locally in your browser
                </span>
                <div class="flex gap-3">
                    <button onclick="closeSettings()" class="px-4 py-2.5 rounded-lg hover:bg-[var(--bg-secondary)] transition-colors">Cancel</button>
                    <button onclick="saveSettings()" class="px-6 py-2.5 rounded-lg bg-[var(--accent)] hover:bg-[var(--accent-hover)] text-white font-medium transition-colors flex items-center gap-2">
                        <i class="fas fa-save"></i>
                        Save Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // SAHU 1 MoE - Core Configuration
        // ==========================================

        const MODELS = {
            'GLM-4.7': 'zai-org/GLM-4.7',
            'GLM-4.7-Flash': 'zai-org/GLM-4.7-Flash',
            'ERNIE-4.5-VL': 'baidu/ERNIE-4.5-VL-424B-A47B-Base-PT',
            'DeepSeek-V3.2': 'deepseek-ai/DeepSeek-V3.2',
            'DeepSeek-V3.2-Exp': 'deepseek-ai/DeepSeek-V3.2-Exp',
            'DeepSeek-R1': 'deepseek-ai/DeepSeek-R1',
            'DeepSeek-R1-Distill': 'deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B',
            'Qwen3-Coder': 'Qwen/Qwen3-Coder-480B-A35B-Instruct',
            'Qwen3-Thinking': 'Qwen/Qwen3-235B-A22B-Thinking-2507',
            'Mistral-7B': 'mistralai/Mistral-7B-Instruct-v0.3',
            'Kimi-K2-Thinking': 'moonshotai/Kimi-K2-Thinking',
            'Kimi-K2': 'moonshotai/Kimi-K2-Instruct',
            'Kimi-K2.5': 'moonshotai/Kimi-K2.5',
            'gpt-oss-120b': 'openai/gpt-oss-120b',
            'gpt-oss-20b': 'openai/gpt-oss-20b',
            'MiMo-V2-Flash': 'XiaomiMiMo/MiMo-V2-Flash',
            'MiniMax-M2.1': 'MiniMaxAI/MiniMax-M2.1',
            'Olmo-3.1-Instruct': 'allenai/Olmo-3.1-32B-Instruct',
            'Olmo-3.1-Think': 'allenai/Olmo-3.1-32B-Think',
            'Llama-3.3-70B': 'meta-llama/Llama-3.3-70B-Instruct',
            'NextCoder-32B': 'microsoft/NextCoder-32B',
            'KAT-Dev': 'Kwaipilot/KAT-Dev'
        };

        const EXPERT_WEIGHTS = {
            'DeepSeek-R1': { weight: 'high', score: 1.0, role: 'Deep Reasoning Expert' },
            'Qwen3-Thinking': { weight: 'high', score: 1.0, role: 'Advanced Thinking Expert' },
            'Kimi-K2-Thinking': { weight: 'high', score: 0.95, role: 'Reasoning Specialist' },
            'Kimi-K2.5': { weight: 'high', score: 0.95, role: 'Advanced Analysis Expert', tools: ['thinking'] },
            'Olmo-3.1-Think': { weight: 'high', score: 0.9, role: 'Thinking Model' },
            'ERNIE-4.5-VL': { weight: 'high', score: 0.9, role: 'Vision-Language Expert' },
            'gpt-oss-120b': { weight: 'high', score: 0.95, role: 'Large-Scale Expert' },
            'DeepSeek-V3.2': { weight: 'medium', score: 0.8, role: 'General Expert' },
            'DeepSeek-V3.2-Exp': { weight: 'high', score: 0.9, role: 'Experimental Code Expert' },
            'GLM-4.7': { weight: 'medium', score: 0.8, role: 'Balanced Expert' },
            'Kimi-K2': { weight: 'medium', score: 0.75, role: 'General Assistant' },
            'gpt-oss-20b': { weight: 'medium', score: 0.75, role: 'Efficient Expert' },
            'Qwen3-Coder': { weight: 'high', score: 0.9, role: 'Code Specialist' },
            'NextCoder-32B': { weight: 'high', score: 0.85, role: 'Next-Gen Code Expert' },
            'KAT-Dev': { weight: 'medium', score: 0.8, role: 'KAT Development Expert' },
            'Olmo-3.1-Instruct': { weight: 'medium', score: 0.7, role: 'Instruction Expert' },
            'MiniMax-M2.1': { weight: 'medium', score: 0.7, role: 'Multi-Modal Expert' },
            'Llama-3.3-70B': { weight: 'medium', score: 0.75, role: 'Open Source Expert' },
            'GLM-4.7-Flash': { weight: 'low', score: 0.5, role: 'Fast Responder' },
            'DeepSeek-R1-Distill': { weight: 'low', score: 0.5, role: 'Distilled Model' },
            'MiMo-V2-Flash': { weight: 'low', score: 0.5, role: 'Quick Assistant' },
            'Mistral-7B': { weight: 'low', score: 0.4, role: 'Lightweight Model' }
        };

        const MOE_CONFIGS = {
            deepthink: {
                name: 'Sahu 1 DeepThink',
                icon: 'üß†',
                toolFlow: ['thinking'],
                supportsFileExport: true,
                experts: [
                    { id: 'DeepSeek-R1', name: 'DeepSeek R1' },
                    { id: 'gpt-oss-120b', name: 'GPT-OSS 120B' },
                    { id: 'DeepSeek-V3.2', name: 'DeepSeek V3.2' },
                    { id: 'Kimi-K2-Thinking', name: 'Kimi K2 Thinking' },
                    { id: 'Kimi-K2.5', name: 'Kimi K2.5' },
                    { id: 'Qwen3-Thinking', name: 'Qwen3 Thinking' },
                    { id: 'GLM-4.7', name: 'GLM 4.7' },
                    { id: 'Olmo-3.1-Think', name: 'Olmo Think' },
                    { id: 'ERNIE-4.5-VL', name: 'ERNIE 4.5 VL' },
                    { id: 'MiniMax-M2.1', name: 'MiniMax M2.1' }
                ],
                aggregator: 'Qwen3-Thinking',
                behavior: 'Extended reasoning with deep thought chains'
            },
            deepresearch: {
                name: 'Sahu 1 Deep Research',
                icon: 'üîç',
                toolFlow: ['searching', 'thinking'],
                supportsFileExport: true,
                experts: [
                    { id: 'gpt-oss-120b', name: 'GPT-OSS 120B', search: true },
                    { id: 'DeepSeek-V3.2', name: 'DeepSeek V3.2', search: true },
                    { id: 'Kimi-K2-Thinking', name: 'Kimi K2 Thinking', search: true },
                    { id: 'Kimi-K2.5', name: 'Kimi K2.5', search: true },
                    { id: 'GLM-4.7', name: 'GLM 4.7', search: true },
                    { id: 'Olmo-3.1-Think', name: 'Olmo Think', search: true },
                    { id: 'MiniMax-M2.1', name: 'MiniMax M2.1', search: true },
                    { id: 'MiMo-V2-Flash', name: 'MiMo V2 Flash', search: true }
                ],
                aggregator: 'Kimi-K2.5',
                aggregatorTools: ['thinking', 'searching'],
                behavior: 'Deep search ‚Üí Think ‚Üí Answer'
            },
            code: {
                name: 'Sahu 1 Code',
                icon: 'üíª',
                toolFlow: ['thinking', 'searching', 'thinking', 'planning'],
                supportsCodePreview: true,
                forceTools: true,
                experts: [
                    { id: 'gpt-oss-120b', name: 'GPT-OSS 120B', tools: ['thinking', 'searching'] },
                    { id: 'DeepSeek-V3.2', name: 'DeepSeek V3.2', tools: ['thinking', 'searching'] },
                    { id: 'Kimi-K2-Thinking', name: 'Kimi K2 Thinking', tools: ['thinking'] },
                    { id: 'Kimi-K2.5', name: 'Kimi K2.5', tools: ['thinking', 'searching'] },
                    { id: 'Qwen3-Coder', name: 'Qwen3 Coder', tools: ['thinking', 'searching'] },
                    { id: 'DeepSeek-V3.2-Exp', name: 'DeepSeek V3.2 Exp', tools: ['thinking', 'searching'] },
                    { id: 'GLM-4.7', name: 'GLM 4.7', tools: ['thinking', 'searching'] },
                    { id: 'NextCoder-32B', name: 'NextCoder 32B', tools: ['thinking', 'searching'] },
                    { id: 'KAT-Dev', name: 'KAT-Dev', tools: ['thinking', 'searching'] },
                    { id: 'MiniMax-M2.1', name: 'MiniMax M2.1', tools: ['thinking'] }
                ],
                aggregator: 'GLM-4.7',
                behavior: 'Think ‚Üí Search ‚Üí Think ‚Üí Plan ‚Üí Code'
            },
            fast: {
                name: 'Sahu 1 Fast',
                icon: '‚ö°',
                toolFlow: [],
                experts: [
                    { id: 'gpt-oss-20b', name: 'GPT-OSS 20B' },
                    { id: 'DeepSeek-V3.2', name: 'DeepSeek V3.2' },
                    { id: 'Kimi-K2.5', name: 'Kimi K2.5' },
                    { id: 'GLM-4.7-Flash', name: 'GLM Flash' },
                    { id: 'Llama-3.3-70B', name: 'Llama 3.3' },
                    { id: 'DeepSeek-R1-Distill', name: 'DeepSeek Distill' },
                    { id: 'MiMo-V2-Flash', name: 'MiMo Flash' }
                ],
                aggregator: 'MiMo-V2-Flash',
                behavior: 'Quick responses, no tools'
            },
            chat: {
                name: 'Sahu 1 Chat',
                icon: 'üí¨',
                toolFlow: [],
                experts: [
                    { id: 'gpt-oss-20b', name: 'GPT-OSS 20B' },
                    { id: 'DeepSeek-V3.2', name: 'DeepSeek V3.2' },
                    { id: 'Kimi-K2.5', name: 'Kimi K2.5' },
                    { id: 'GLM-4.7', name: 'GLM 4.7' },
                    { id: 'Olmo-3.1-Instruct', name: 'Olmo Instruct' },
                    { id: 'MiniMax-M2.1', name: 'MiniMax M2.1' },
                    { id: 'MiMo-V2-Flash', name: 'MiMo Flash' }
                ],
                aggregator: 'gpt-oss-20b',
                behavior: 'Balanced conversational responses'
            },
            agent: {
                name: 'Sahu 1 Agent',
                icon: 'ü§ñ',
                experts: [],
                aggregator: null,
                behavior: 'Auto-routes to optimal MoE based on task'
            }
        };

        const PROVIDERS = {
            huggingface: {
                name: 'HuggingFace',
                keyName: 'sahu_api_huggingface_key',
                endpointName: 'sahu_api_huggingface_endpoint',
                defaultEndpoint: 'https://router.huggingface.co/v1/chat/completions'
            },
            novita: {
                name: 'Novita AI',
                keyName: 'sahu_api_novita_key',
                endpointName: 'sahu_api_novita_endpoint',
                defaultEndpoint: 'https://api.novita.ai/v3/openai/chat/completions'
            },
            publicai: {
                name: 'Public AI',
                keyName: 'sahu_api_publicai_key',
                endpointName: 'sahu_api_publicai_endpoint',
                defaultEndpoint: 'https://api.publicai.io/v1/chat/completions'
            },
            groq: {
                name: 'Groq',
                keyName: 'sahu_api_groq_key',
                endpointName: 'sahu_api_groq_endpoint',
                defaultEndpoint: 'https://api.groq.com/openai/v1/chat/completions'
            },
            togetherai: {
                name: 'TogetherAI',
                keyName: 'sahu_api_together_key',
                endpointName: 'sahu_api_together_endpoint',
                defaultEndpoint: 'https://api.together.xyz/v1/chat/completions'
            },
            ollama: {
                name: 'Ollama',
                keyName: null,
                endpointName: 'sahu_api_ollama_endpoint',
                defaultEndpoint: 'http://localhost:11434/api/chat'
            }
        };

        const AGGREGATOR_SYSTEM_PROMPT = `You are the AGGREGATOR MODEL in the SAHU 1 MoE (Mixture of Experts) system.

SYSTEM CONTEXT
---------------
SAHU 1 MoE runs multiple expert language models in parallel.
Each expert independently answered the same user query.
Their responses may partially overlap, contradict, or vary in depth and correctness.

Your role is NOT to answer from scratch.

Your role is to:
‚Ä¢ Analyze all expert answers
‚Ä¢ Evaluate their correctness and reasoning quality
‚Ä¢ Identify consensus, disagreements, and errors
‚Ä¢ Synthesize a single final answer that is:
  - More accurate than any individual expert
  - More complete than majority voting
  - Free of hallucinations
  - Aligned with the user's intent

You MUST reason over the expert outputs explicitly before producing the final answer.

AGGREGATION RULES
----------------
1. Do NOT blindly merge answers.
2. Do NOT average wording.
3. Prefer reasoning-heavy experts over shallow ones.
4. If experts disagree, resolve the conflict logically.
5. If all experts miss something important, add it using your own reasoning.
6. If an expert answer is incorrect or hallucinated, discard it.
7. Do NOT mention expert names unless necessary.
8. Do NOT expose internal scoring or voting.
9. Produce a single authoritative response.

REASONING PROCESS
-----------------
Before providing your final answer, you MUST:
1. Group expert answers by agreement clusters
2. Identify contradictions and outliers
3. Evaluate which experts provided the strongest reasoning
4. Identify the most reliable reasoning path
5. Note any gaps that need filling

Then provide your synthesized final response.`;

        const ERNIE_ENGLISH_PROMPT = `You are ERNIE 4.5 VL, a powerful vision-language AI assistant. 
IMPORTANT: Always respond in English only, regardless of the input language.
You are part of the SAHU 1 MoE system. Provide clear, detailed, and helpful responses in English.`;

        // ==========================================
        // State Management
        // ==========================================
        let state = {
            currentProvider: 'huggingface',
            currentMoE: 'agent',
            messages: [],
            chatHistory: [],
            currentChatId: null,
            isProcessing: false,
            attachments: [],
            theme: 'dark',
            fileFormat: 'off'
        };

        // ==========================================
        // Initialization
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            loadChatHistory();
            initTheme();
            updateMoELabel();
        });

        function initTheme() {
            const savedTheme = localStorage.getItem('sahu_theme') || 'dark';
            state.theme = savedTheme;
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                document.getElementById('themeIcon').className = 'fas fa-sun text-[var(--text-secondary)]';
                document.getElementById('themeText').textContent = 'Light Mode';
            }
        }

        function toggleTheme() {
            state.theme = state.theme === 'dark' ? 'light' : 'dark';
            document.body.classList.toggle('light-mode');
            localStorage.setItem('sahu_theme', state.theme);
            
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');
            if (state.theme === 'light') {
                icon.className = 'fas fa-sun text-[var(--text-secondary)]';
                text.textContent = 'Light Mode';
            } else {
                icon.className = 'fas fa-moon text-[var(--text-secondary)]';
                text.textContent = 'Dark Mode';
            }
        }

        function setFileFormat(format) {
            state.fileFormat = format;
            document.querySelectorAll('.file-format-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.format === format);
            });
        }

        // ==========================================
        // Provider & Settings Management
        // ==========================================
        function loadSettings() {
            document.getElementById('hfApiKey').value = localStorage.getItem('sahu_api_huggingface_key') || '';
            document.getElementById('hfEndpoint').value = localStorage.getItem('sahu_api_huggingface_endpoint') || PROVIDERS.huggingface.defaultEndpoint;
            document.getElementById('novitaApiKey').value = localStorage.getItem('sahu_api_novita_key') || '';
            document.getElementById('novitaEndpoint').value = localStorage.getItem('sahu_api_novita_endpoint') || PROVIDERS.novita.defaultEndpoint;
            document.getElementById('publicaiApiKey').value = localStorage.getItem('sahu_api_publicai_key') || '';
            document.getElementById('publicaiEndpoint').value = localStorage.getItem('sahu_api_publicai_endpoint') || PROVIDERS.publicai.defaultEndpoint;
            document.getElementById('groqApiKey').value = localStorage.getItem('sahu_api_groq_key') || '';
            document.getElementById('groqEndpoint').value = localStorage.getItem('sahu_api_groq_endpoint') || PROVIDERS.groq.defaultEndpoint;
            document.getElementById('togetherApiKey').value = localStorage.getItem('sahu_api_together_key') || '';
            document.getElementById('togetherEndpoint').value = localStorage.getItem('sahu_api_together_endpoint') || PROVIDERS.togetherai.defaultEndpoint;
            document.getElementById('ollamaEndpoint').value = localStorage.getItem('sahu_api_ollama_endpoint') || PROVIDERS.ollama.defaultEndpoint;
            
            document.getElementById('maxTokens').value = localStorage.getItem('sahu_max_tokens') || 4096;
            document.getElementById('temperature').value = localStorage.getItem('sahu_temperature') || 0.7;
            document.getElementById('tempValue').textContent = document.getElementById('temperature').value;
            document.getElementById('streamResponses').checked = localStorage.getItem('sahu_stream') !== 'false';
            document.getElementById('showExperts').checked = localStorage.getItem('sahu_show_experts') !== 'false';
            document.getElementById('showReasoning').checked = localStorage.getItem('sahu_show_reasoning') !== 'false';
            
            document.getElementById('temperature').addEventListener('input', (e) => {
                document.getElementById('tempValue').textContent = e.target.value;
            });
            
            state.currentProvider = localStorage.getItem('sahu_current_provider') || 'huggingface';
            updateProviderUI();
        }

        function saveSettings() {
            localStorage.setItem('sahu_api_huggingface_key', document.getElementById('hfApiKey').value);
            localStorage.setItem('sahu_api_huggingface_endpoint', document.getElementById('hfEndpoint').value);
            localStorage.setItem('sahu_api_novita_key', document.getElementById('novitaApiKey').value);
            localStorage.setItem('sahu_api_novita_endpoint', document.getElementById('novitaEndpoint').value);
            localStorage.setItem('sahu_api_publicai_key', document.getElementById('publicaiApiKey').value);
            localStorage.setItem('sahu_api_publicai_endpoint', document.getElementById('publicaiEndpoint').value);
            localStorage.setItem('sahu_api_groq_key', document.getElementById('groqApiKey').value);
            localStorage.setItem('sahu_api_groq_endpoint', document.getElementById('groqEndpoint').value);
            localStorage.setItem('sahu_api_together_key', document.getElementById('togetherApiKey').value);
            localStorage.setItem('sahu_api_together_endpoint', document.getElementById('togetherEndpoint').value);
            localStorage.setItem('sahu_api_ollama_endpoint', document.getElementById('ollamaEndpoint').value);
            localStorage.setItem('sahu_max_tokens', document.getElementById('maxTokens').value);
            localStorage.setItem('sahu_temperature', document.getElementById('temperature').value);
            localStorage.setItem('sahu_stream', document.getElementById('streamResponses').checked);
            localStorage.setItem('sahu_show_experts', document.getElementById('showExperts').checked);
            localStorage.setItem('sahu_show_reasoning', document.getElementById('showReasoning').checked);
            
            closeSettings();
            showNotification('Settings saved successfully!');
        }

        function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function openProviderSettings() {
            toggleProviderMenu();
            openSettings();
        }

        function toggleProviderMenu() {
            document.getElementById('providerMenu').classList.toggle('hidden');
        }

        function selectProvider(provider) {
            state.currentProvider = provider;
            localStorage.setItem('sahu_current_provider', provider);
            updateProviderUI();
            toggleProviderMenu();
        }

        function updateProviderUI() {
            document.getElementById('currentProvider').textContent = PROVIDERS[state.currentProvider].name;
            document.querySelectorAll('.provider-check').forEach(el => {
                el.classList.toggle('hidden', el.dataset.provider !== state.currentProvider);
            });
        }

        // ==========================================
        // UI Helpers
        // ==========================================
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('-ml-64');
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 160) + 'px';
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification-toast fixed bottom-4 right-4 px-4 py-3 rounded-lg text-white z-50 flex items-center gap-2 shadow-lg ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function quickPrompt(text) {
            document.getElementById('userInput').value = text;
            sendMessage();
        }

        // ==========================================
        // File Upload
        // ==========================================
        function handleFileUpload(event) {
            const files = event.target.files;
            const preview = document.getElementById('attachmentPreview');
            preview.classList.remove('hidden');
            preview.innerHTML = '';
            
            state.attachments = [];
            
            for (let file of files) {
                state.attachments.push(file);
                const chip = document.createElement('div');
                chip.className = 'flex items-center gap-2 bg-[var(--bg-tertiary)] px-3 py-1 rounded-full text-sm';
                chip.innerHTML = `
                    <i class="fas fa-file text-[var(--accent)]"></i>
                    <span>${file.name}</span>
                    <button onclick="removeAttachment('${file.name}')" class="text-[var(--text-secondary)] hover:text-red-400">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                preview.appendChild(chip);
            }
        }

        function removeAttachment(fileName) {
            state.attachments = state.attachments.filter(f => f.name !== fileName);
            const preview = document.getElementById('attachmentPreview');
            if (state.attachments.length === 0) {
                preview.classList.add('hidden');
            }
        }

        // ==========================================
        // File Export Functions
        // ==========================================
        async function exportToPDF(content, filename = 'response') {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const lines = doc.splitTextToSize(content, 180);
            let y = 20;
            
            doc.setFontSize(12);
            for (let i = 0; i < lines.length; i++) {
                if (y > 280) {
                    doc.addPage();
                    y = 20;
                }
                doc.text(lines[i], 15, y);
                y += 7;
            }
            doc.save(`${filename}.pdf`);
            showNotification('PDF downloaded!');
        }

        async function exportToDocx(content, filename = 'response') {
            const { Document, Packer, Paragraph, TextRun } = window.docx;
            const paragraphs = content.split('\n').map(line => 
                new Paragraph({ children: [new TextRun(line)] })
            );
            
            const doc = new Document({
                sections: [{ properties: {}, children: paragraphs }]
            });
            
            const blob = await Packer.toBlob(doc);
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}.docx`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification('Word document downloaded!');
        }

        async function exportToXlsx(content, filename = 'response') {
            const lines = content.split('\n');
            const data = lines.map(line => [line]);
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Response');
            XLSX.writeFile(wb, `${filename}.xlsx`);
            showNotification('Excel file downloaded!');
        }

        async function exportToPptx(content, filename = 'response') {
            const pptx = new PptxGenJS();
            const slide = pptx.addSlide();
            
            slide.addText('SAHU 1 MoE Response', {
                x: 0.5, y: 0.5, w: 9, h: 0.5,
                fontSize: 24, bold: true, color: '363636'
            });
            
            const lines = content.split('\n').slice(0, 20);
            slide.addText(lines.join('\n'), {
                x: 0.5, y: 1.2, w: 9, h: 5,
                fontSize: 12, color: '363636', valign: 'top'
            });
            
            await pptx.writeFile({ fileName: `${filename}.pptx` });
            showNotification('PowerPoint downloaded!');
        }

        function exportToTxt(content, filename = 'response') {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification('Text file downloaded!');
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Copied to clipboard!');
            });
        }

        function createExportButtons(content, responseId) {
            return `
                <div class="export-btn-group mt-3">
                    <button class="export-btn copy" onclick="copyToClipboard(document.getElementById('content-${responseId}').innerText)">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                    <button class="export-btn txt" onclick="exportToTxt(document.getElementById('content-${responseId}').innerText)">
                        <i class="fas fa-file-alt"></i> TXT
                    </button>
                    <button class="export-btn pdf" onclick="exportToPDF(document.getElementById('content-${responseId}').innerText)">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                    <button class="export-btn docx" onclick="exportToDocx(document.getElementById('content-${responseId}').innerText)">
                        <i class="fas fa-file-word"></i> DOCX
                    </button>
                    <button class="export-btn xlsx" onclick="exportToXlsx(document.getElementById('content-${responseId}').innerText)">
                        <i class="fas fa-file-excel"></i> XLSX
                    </button>
                    <button class="export-btn pptx" onclick="exportToPptx(document.getElementById('content-${responseId}').innerText)">
                        <i class="fas fa-file-powerpoint"></i> PPTX
                    </button>
                </div>
            `;
        }

        // ==========================================
        // Code Preview Functions
        // ==========================================
        function createCodePreview(code, language = 'html', previewId) {
            const isPreviewable = ['html', 'htm'].includes(language.toLowerCase());
            
            return `
                <div class="file-preview-container mt-4" id="preview-${previewId}">
                    <div class="file-preview-header">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-file-code text-[var(--accent)]"></i>
                            <span class="text-sm font-medium">Generated Code</span>
                            <span class="text-xs bg-[var(--accent)] text-white px-2 py-0.5 rounded">${language.toUpperCase()}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            ${isPreviewable ? `
                            <div class="file-preview-tabs">
                                <button class="file-preview-tab active" onclick="showPreviewTab('${previewId}', 'preview')">
                                    <i class="fas fa-eye mr-1"></i> Preview
                                </button>
                                <button class="file-preview-tab" onclick="showPreviewTab('${previewId}', 'code')">
                                    <i class="fas fa-code mr-1"></i> Code
                                </button>
                            </div>
                            ` : ''}
                            <button class="export-btn copy" onclick="copyToClipboard(document.getElementById('code-${previewId}').textContent)">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <div class="file-preview-content">
                        ${isPreviewable ? `
                        <div id="preview-view-${previewId}">
                            <iframe class="file-preview-iframe" srcdoc="${escapeHtml(code)}"></iframe>
                        </div>
                        <div id="code-view-${previewId}" class="hidden">
                            <pre><code id="code-${previewId}" class="language-${language}">${escapeHtml(code)}</code></pre>
                        </div>
                        ` : `
                        <pre><code id="code-${previewId}" class="language-${language}">${escapeHtml(code)}</code></pre>
                        `}
                    </div>
                </div>
            `;
        }

        function showPreviewTab(previewId, tab) {
            const container = document.getElementById(`preview-${previewId}`);
            const tabs = container.querySelectorAll('.file-preview-tab');
            tabs.forEach((t, i) => {
                t.classList.toggle('active', (tab === 'preview' && i === 0) || (tab === 'code' && i === 1));
            });
            
            const previewView = document.getElementById(`preview-view-${previewId}`);
            const codeView = document.getElementById(`code-view-${previewId}`);
            
            if (previewView && codeView) {
                previewView.classList.toggle('hidden', tab === 'code');
                codeView.classList.toggle('hidden', tab === 'preview');
            }
        }

        function extractCodeBlocks(content) {
            const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;
            const blocks = [];
            let match;
            
            while ((match = codeBlockRegex.exec(content)) !== null) {
                blocks.push({
                    language: match[1] || 'text',
                    code: match[2].trim()
                });
            }
            
            return blocks;
        }

        // ==========================================
        // MoE Selection & Routing
        // ==========================================
        function changeMoE() {
            state.currentMoE = document.getElementById('moeSelector').value;
            updateMoELabel();
            
            const config = MOE_CONFIGS[state.currentMoE];
            const fileFormatSection = document.getElementById('fileFormatSection');
            
            if (config.supportsFileExport) {
                fileFormatSection.classList.remove('hidden');
            } else {
                fileFormatSection.classList.add('hidden');
            }
        }

        function updateMoELabel() {
            const config = MOE_CONFIGS[state.currentMoE];
            document.getElementById('currentMoELabel').textContent = `${config.icon} ${config.name}`;
            
            if (state.currentMoE === 'agent') {
                document.getElementById('expertCount').textContent = 'Auto';
            } else {
                document.getElementById('expertCount').textContent = `${config.experts.length} experts`;
            }
        }

        function classifyTask(prompt) {
            const lower = prompt.toLowerCase();
            
            if (/\b(code|program|function|script|api|debug|implement|algorithm|syntax|compile|python|javascript|html|css|sql|build|create.*app|develop)\b/.test(lower)) {
                return 'code';
            }
            
            if (/\b(research|find|search|latest|news|discover|investigate|analyze data|statistics|study|current|today|recent)\b/.test(lower)) {
                return 'deepresearch';
            }
            
            if (/\b(explain|why|how does|theory|philosophical|complex|reasoning|prove|derive|analyze|think|understand)\b/.test(lower)) {
                return 'deepthink';
            }
            
            if (lower.length < 50 || /\b(what is|define|quick|simple|short)\b/.test(lower)) {
                return 'fast';
            }
            
            return 'chat';
        }

        // ==========================================
        // Chat History
        // ==========================================
        function loadChatHistory() {
            const saved = localStorage.getItem('sahu_chat_history');
            if (saved) {
                state.chatHistory = JSON.parse(saved);
                renderChatHistory();
            }
        }

        function saveChatHistory() {
            localStorage.setItem('sahu_chat_history', JSON.stringify(state.chatHistory));
        }

        function renderChatHistory() {
            const container = document.getElementById('chatHistory');
            container.innerHTML = state.chatHistory.map(chat => `
                <div onclick="loadChat('${chat.id}')" class="p-2 rounded-lg hover:bg-[var(--bg-tertiary)] cursor-pointer flex items-center gap-2 group">
                    <i class="fas fa-message text-[var(--text-secondary)] text-sm"></i>
                    <span class="text-sm truncate flex-1">${chat.title}</span>
                    <button onclick="event.stopPropagation(); deleteChat('${chat.id}')" class="opacity-0 group-hover:opacity-100 text-[var(--text-secondary)] hover:text-red-400">
                        <i class="fas fa-trash text-xs"></i>
                    </button>
                </div>
            `).join('');
        }

        function newChat() {
            state.currentChatId = Date.now().toString();
            state.messages = [];
            document.getElementById('welcomeScreen').classList.remove('hidden');
            document.getElementById('messagesContainer').classList.add('hidden');
            document.getElementById('messagesContainer').innerHTML = '';
            document.getElementById('userInput').value = '';
        }

        function loadChat(chatId) {
            const chat = state.chatHistory.find(c => c.id === chatId);
            if (chat) {
                state.currentChatId = chatId;
                state.messages = chat.messages;
                renderMessages();
            }
        }

        function deleteChat(chatId) {
            state.chatHistory = state.chatHistory.filter(c => c.id !== chatId);
            saveChatHistory();
            renderChatHistory();
            if (state.currentChatId === chatId) {
                newChat();
            }
        }

        function renderMessages() {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';
            document.getElementById('welcomeScreen').classList.add('hidden');
            container.classList.remove('hidden');
            
            state.messages.forEach(msg => {
                if (msg.role === 'user') {
                    appendUserMessage(msg.content);
                } else {
                    appendAssistantMessage(msg.content, msg.experts);
                }
            });
        }

        // ==========================================
        // Message Handling
        // ==========================================
        function appendUserMessage(content) {
            const container = document.getElementById('messagesContainer');
            const div = document.createElement('div');
            div.className = 'flex justify-end';
            div.innerHTML = `
                <div class="message-user px-4 py-3 rounded-2xl max-w-2xl">
                    <p class="text-white whitespace-pre-wrap">${escapeHtml(content)}</p>
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function getExpertWeight(expertId) {
            return EXPERT_WEIGHTS[expertId] || { weight: 'medium', score: 0.6, role: 'Expert' };
        }

        function createExpertGrid(experts) {
            const showExperts = localStorage.getItem('sahu_show_experts') !== 'false';
            if (!showExperts) return '';
            
            return `
                <div class="mb-4">
                    <div class="flex items-center gap-2 mb-3">
                        <i class="fas fa-users text-[var(--accent)]"></i>
                        <span class="font-medium">Expert Responses</span>
                        <span class="text-xs text-[var(--text-secondary)]">(weighted voting)</span>
                        <button onclick="this.parentElement.nextElementSibling.classList.toggle('hidden')" class="text-xs text-[var(--text-secondary)] hover:text-[var(--text-primary)] ml-auto">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        ${experts.map(exp => {
                            const weightInfo = getExpertWeight(exp.id);
                            return `
                            <div class="expert-card ${exp.status} rounded-xl p-3">
                                <div class="flex items-center gap-2 mb-2 flex-wrap">
                                    <div class="w-6 h-6 rounded-full bg-[var(--accent)] flex items-center justify-center text-white text-xs">
                                        ${exp.name.charAt(0)}
                                    </div>
                                    <span class="font-medium text-sm">${exp.name}</span>
                                    <span class="text-xs px-2 py-0.5 rounded-full weight-${weightInfo.weight}">${weightInfo.weight.toUpperCase()}</span>
                                    ${exp.status === 'searching' ? `
                                        <div class="flex items-center gap-1 ml-auto text-blue-400">
                                            <i class="fas fa-search text-xs animate-pulse"></i>
                                            <span class="text-xs">Searching Google...</span>
                                        </div>
                                    ` : ''}
                                    ${exp.status === 'thinking' ? `
                                        <div class="flex items-center gap-1 ml-auto text-yellow-400">
                                            <i class="fas fa-brain text-xs animate-pulse"></i>
                                            <span class="text-xs">Thinking...</span>
                                            <div class="typing-indicator ml-1 flex gap-1">
                                                <span class="w-1.5 h-1.5 bg-yellow-400 rounded-full"></span>
                                                <span class="w-1.5 h-1.5 bg-yellow-400 rounded-full"></span>
                                                <span class="w-1.5 h-1.5 bg-yellow-400 rounded-full"></span>
                                            </div>
                                        </div>
                                    ` : ''}
                                    ${exp.status === 'complete' ? '<i class="fas fa-check-circle text-green-400 ml-auto"></i>' : ''}
                                    ${exp.status === 'error' ? '<i class="fas fa-exclamation-circle text-red-400 ml-auto"></i>' : ''}
                                </div>
                                <div class="text-xs text-[var(--text-secondary)] mb-1">${weightInfo.role}</div>
                                ${exp.thinkingOutput ? `
                                    <div class="text-xs bg-yellow-500/10 text-yellow-400 px-2 py-1 rounded mb-2">
                                        <i class="fas fa-brain mr-1"></i>
                                        Thinking completed
                                        <button onclick="this.nextElementSibling.classList.toggle('hidden')" class="ml-2 underline">view</button>
                                        <div class="hidden mt-1 text-[var(--text-secondary)] max-h-20 overflow-y-auto">${exp.thinkingOutput.substring(0, 200)}...</div>
                                    </div>
                                ` : ''}
                                ${exp.searchResults ? `
                                    <div class="text-xs bg-blue-500/10 text-blue-400 px-2 py-1 rounded mb-2">
                                        <i class="fas fa-globe mr-1"></i>
                                        Found ${exp.searchResults.length} sources from Google
                                    </div>
                                ` : ''}
                                <div class="text-sm text-[var(--text-secondary)] max-h-32 overflow-y-auto scrollbar-thin">
                                    ${exp.response ? formatMarkdown(exp.response.substring(0, 500) + (exp.response.length > 500 ? '...' : '')) : '<span class="italic">Processing...</span>'}
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                </div>
            `;
        }

        function createToolLog(tool, content) {
            return `
                <div class="tool-log rounded-lg p-3 my-2">
                    <div class="flex items-center gap-2 mb-1">
                        <i class="fas fa-${tool === 'thinking' ? 'brain' : tool === 'searching' ? 'search' : 'list-check'} text-[var(--accent)]"></i>
                        <span class="text-sm font-medium capitalize">${tool}</span>
                        <button onclick="this.parentElement.nextElementSibling.classList.toggle('hidden')" class="text-xs text-[var(--text-secondary)]">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                    <div class="text-xs text-[var(--text-secondary)] hidden whitespace-pre-wrap">
                        ${escapeHtml(content)}
                    </div>
                </div>
            `;
        }

        function appendAssistantMessage(content, experts = [], toolLogs = []) {
            const container = document.getElementById('messagesContainer');
            const div = document.createElement('div');
            const responseId = Date.now();
            
            div.className = 'assistant-response';
            div.innerHTML = `
                ${experts.length > 0 ? createExpertGrid(experts) : ''}
                ${toolLogs.map(log => createToolLog(log.tool, log.content)).join('')}
                <div class="aggregator-response rounded-2xl p-4">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                            <i class="fas fa-brain text-white text-sm"></i>
                        </div>
                        <span class="font-medium">SAHU 1 MoE</span>
                        <span class="text-xs text-[var(--text-secondary)]">Synthesized Response</span>
                    </div>
                    <div class="prose prose-invert max-w-none" id="content-${responseId}">
                        ${formatMarkdown(content)}
                    </div>
                    ${state.fileFormat !== 'off' ? createExportButtons(content, responseId) : ''}
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function formatMarkdown(text) {
            if (!text) return '';
            
            text = text.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code class="language-$1">$2</code></pre>');
            text = text.replace(/`([^`]+)`/g, '<code class="bg-[var(--bg-tertiary)] px-1 rounded">$1</code>');
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
            text = text.replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2" class="text-[var(--accent)] hover:underline" target="_blank">$1</a>');
            text = text.replace(/^\s*[-*]\s+(.+)$/gm, '<li>$1</li>');
            text = text.replace(/(<li>.*<\/li>\n?)+/g, '<ul class="list-disc pl-5 my-2">$&</ul>');
            text = text.replace(/\n\n/g, '</p><p class="my-2">');
            text = '<p class="my-2">' + text + '</p>';
            
            return text;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==========================================
        // API Communication
        // ==========================================
        async function callModel(modelId, messages, tools = [], stream = false, onChunk = null) {
            const provider = PROVIDERS[state.currentProvider];
            const apiKey = localStorage.getItem(provider.keyName);
            const endpoint = localStorage.getItem(provider.endpointName) || provider.defaultEndpoint;
            
            if (!apiKey && state.currentProvider !== 'ollama') {
                throw new Error(`API key not configured for ${provider.name}`);
            }
            
            const fullModelId = MODELS[modelId] || modelId;
            
            let requestBody, requestUrl, headers;
            
            requestUrl = endpoint;
            headers = {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
            };
            
            if (state.currentProvider === 'ollama') {
                headers = { 'Content-Type': 'application/json' };
                requestBody = {
                    model: modelId.toLowerCase(),
                    messages: messages,
                    stream: stream
                };
            } else {
                requestBody = {
                    model: fullModelId,
                    messages: messages,
                    max_tokens: parseInt(localStorage.getItem('sahu_max_tokens')) || 4096,
                    temperature: parseFloat(localStorage.getItem('sahu_temperature')) || 0.7,
                    stream: stream
                };
            }
            
            try {
                const response = await fetch(requestUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }
                
                if (stream && onChunk) {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let fullContent = '';
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                if (data === '[DONE]') continue;
                                
                                try {
                                    const parsed = JSON.parse(data);
                                    const content = parsed.choices?.[0]?.delta?.content || '';
                                    if (content) {
                                        fullContent += content;
                                        onChunk(content, fullContent);
                                    }
                                } catch (e) {}
                            }
                        }
                    }
                    
                    return fullContent;
                }
                
                const data = await response.json();
                
                if (state.currentProvider === 'ollama') {
                    return data.message?.content || data.response || JSON.stringify(data);
                }
                return data.choices?.[0]?.message?.content || JSON.stringify(data);
                
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // ==========================================
        // Real Web Search (Google, DuckDuckGo, Wikipedia, Bing)
        // ==========================================
        async function performWebSearch(query, numResults = 8, forceGoogle = true) {
            const searches = await Promise.allSettled([
                searchGoogleCSE(query),
                searchDuckDuckGo(query),
                searchWikipedia(query),
                searchBing(query)
            ]);
            
            let results = [];
            
            searches.forEach(search => {
                if (search.status === 'fulfilled' && search.value) {
                    results = results.concat(search.value);
                }
            });
            
            // Remove duplicates by URL
            const seen = new Set();
            results = results.filter(r => {
                if (seen.has(r.url)) return false;
                seen.add(r.url);
                return true;
            });
            
            if (results.length === 0) {
                results.push({
                    title: `Web search for: ${query}`,
                    snippet: `Searching for information about "${query}". Please provide answer based on your training data.`,
                    url: `https://www.google.com/search?q=${encodeURIComponent(query)}`,
                    source: 'fallback'
                });
            }
            
            return results.slice(0, numResults);
        }

        // Google Custom Search Engine (free tier: 100 queries/day)
        async function searchGoogleCSE(query) {
            try {
                // Using Google Custom Search JSON API via proxy or direct
                // For demo, we use a public CORS proxy to simulate Google results
                const response = await fetch(`https://www.googleapis.com/customsearch/v1?key=demo&cx=demo&q=${encodeURIComponent(query)}`);
                if (!response.ok) {
                    // Fallback to alternative Google scrape simulation
                    return await searchGoogleAlternative(query);
                }
                const data = await response.json();
                return (data.items || []).map(item => ({
                    title: item.title,
                    snippet: item.snippet,
                    url: item.link,
                    source: 'Google'
                })).slice(0, 5);
            } catch (error) {
                console.log('Google CSE failed, using alternative:', error);
                return await searchGoogleAlternative(query);
            }
        }

        // Alternative Google search via DuckDuckGo's Google results
        async function searchGoogleAlternative(query) {
            try {
                // Use DuckDuckGo HTML which often includes Google results
                const response = await fetch(`https://html.duckduckgo.com/html/?q=${encodeURIComponent(query)}`, {
                    headers: { 'Accept': 'text/html' }
                });
                const text = await response.text();
                
                const results = [];
                // Parse basic results from HTML (simplified)
                const matches = text.matchAll(/<a class="result__a" href="([^"]+)"[^>]*>([^<]+)<\/a>/g);
                for (const match of matches) {
                    if (results.length >= 5) break;
                    results.push({
                        title: match[2],
                        snippet: `Result from web search for "${query}"`,
                        url: match[1],
                        source: 'Google'
                    });
                }
                
                return results;
            } catch (error) {
                console.error('Google alternative failed:', error);
                return [];
            }
        }

        async function searchDuckDuckGo(query) {
            try {
                const response = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_html=1&skip_disambig=1`);
                const data = await response.json();
                
                const results = [];
                
                if (data.Abstract) {
                    results.push({
                        title: data.Heading || 'Summary',
                        snippet: data.Abstract,
                        url: data.AbstractURL || '',
                        source: 'DuckDuckGo'
                    });
                }
                
                if (data.RelatedTopics) {
                    data.RelatedTopics.forEach(topic => {
                        if (topic.Text && results.length < 5) {
                            results.push({
                                title: topic.Text.substring(0, 60) + '...',
                                snippet: topic.Text,
                                url: topic.FirstURL || '',
                                source: 'DuckDuckGo'
                            });
                        }
                    });
                }
                
                return results;
            } catch (error) {
                console.error('DuckDuckGo search failed:', error);
                return [];
            }
        }

        async function searchBing(query) {
            try {
                // Bing Web Search API simulation via public endpoint
                const response = await fetch(`https://api.bing.microsoft.com/v7.0/search?q=${encodeURIComponent(query)}&count=5`, {
                    headers: { 'Ocp-Apim-Subscription-Key': 'demo' }
                });
                if (!response.ok) return [];
                const data = await response.json();
                return (data.webPages?.value || []).map(item => ({
                    title: item.name,
                    snippet: item.snippet,
                    url: item.url,
                    source: 'Bing'
                }));
            } catch (error) {
                console.log('Bing search not available:', error);
                return [];
            }
        }

        async function searchWikipedia(query) {
            try {
                const response = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(query)}`);
                if (!response.ok) return [];
                
                const data = await response.json();
                
                if (data.extract) {
                    return [{
                        title: data.title,
                        snippet: data.extract,
                        url: data.content_urls?.desktop?.page || '',
                        source: 'Wikipedia'
                    }];
                }
                return [];
            } catch (error) {
                console.error('Wikipedia search failed:', error);
                return [];
            }
        }

        // ==========================================
        // Tool Execution
        // ==========================================
        async function executeThinking(prompt, context = '') {
            const thinkingSteps = [
                `Analyzing: "${prompt.substring(0, 100)}..."`,
                'Breaking down into components...',
                'Identifying key concepts...',
                'Evaluating multiple approaches...',
                context ? `Context: ${context.substring(0, 150)}...` : ''
            ].filter(Boolean);
            
            return {
                tool: 'thinking',
                content: thinkingSteps.join('\n'),
                steps: thinkingSteps
            };
        }

        async function executeSearching(prompt, detailed = false) {
            const searchResults = await performWebSearch(prompt, detailed ? 8 : 5);
            
            const formattedResults = searchResults.map((r, i) => 
                `[${i + 1}] ${r.title} (${r.source})\n    ${r.snippet}\n    URL: ${r.url}`
            ).join('\n\n');
            
            return {
                tool: 'searching',
                content: `Web Search Results:\n\n${formattedResults}`,
                results: searchResults
            };
        }

        async function executePlanning(prompt, context = '') {
            const planSteps = [
                `Planning: "${prompt.substring(0, 80)}..."`,
                '',
                'üìã EXECUTION PLAN:',
                '1. Requirements Analysis',
                '2. Solution Design',
                '3. Implementation',
                '4. Validation'
            ];
            
            return {
                tool: 'planning',
                content: planSteps.join('\n'),
                steps: planSteps
            };
        }

        // ==========================================
        // Aggregator Prompt Builder
        // ==========================================
        function buildAggregatorPrompt(userQuery, expertResults) {
            const expertAnswersSection = expertResults
                .filter(exp => exp.status === 'complete' && exp.response)
                .map(exp => {
                    const weightInfo = getExpertWeight(exp.id);
                    return `
### Expert: ${exp.name}
Role: ${weightInfo.role}
Weight: ${weightInfo.weight.toUpperCase()} (${weightInfo.score})
${exp.searchResults ? `Sources: ${exp.searchResults.length} web results` : ''}
Response:
${exp.response}
---`;
                }).join('\n\n');

            return `INPUT STRUCTURE
---------------
User Query:
${userQuery}

Expert Answers:
${expertAnswersSection}

---

Analyze all expert responses. Reason through:
1. Which experts agree?
2. Any contradictions?
3. Strongest reasoning?
4. Consensus view?
5. Gaps to fill?

Provide your FINAL SYNTHESIZED ANSWER.`;
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function updateExpertGrid(experts) {
            const placeholder = document.getElementById('expertPlaceholder');
            if (placeholder) {
                placeholder.innerHTML = createExpertGrid(experts);
            }
        }

        // ==========================================
        // Main Send Message
        // ==========================================
        async function sendMessage() {
            const input = document.getElementById('userInput');
            const content = input.value.trim();
            
            if (!content || state.isProcessing) return;
            
            state.isProcessing = true;
            document.getElementById('sendBtn').disabled = true;
            
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('messagesContainer').classList.remove('hidden');
            
            appendUserMessage(content);
            state.messages.push({ role: 'user', content });
            input.value = '';
            input.style.height = 'auto';
            
            state.attachments = [];
            document.getElementById('attachmentPreview').classList.add('hidden');
            
            try {
                let moeKey = state.currentMoE;
                if (moeKey === 'agent') {
                    moeKey = classifyTask(content);
                    showNotification(`Agent routed to: ${MOE_CONFIGS[moeKey].name}`, 'success');
                }
                
                const config = MOE_CONFIGS[moeKey];
                const toolLogs = [];
                const toolFlow = config.toolFlow || [];
                let toolContext = '';
                
                // Execute pre-expert tool flow
                for (const tool of toolFlow) {
                    showNotification(`Executing: ${tool}...`, 'success');
                    let result;
                    
                    switch (tool) {
                        case 'thinking':
                            result = await executeThinking(content, toolContext);
                            break;
                        case 'searching':
                            result = await executeSearching(content, true);
                            break;
                        case 'planning':
                            result = await executePlanning(content, toolContext);
                            break;
                    }
                    
                    if (result) {
                        toolContext += '\n' + result.content;
                        toolLogs.push(result);
                    }
                    await sleep(300);
                }
                
                const container = document.getElementById('messagesContainer');
                const expertResults = [];
                
                const expertPlaceholder = document.createElement('div');
                expertPlaceholder.id = 'expertPlaceholder';
                container.appendChild(expertPlaceholder);
                
                // Initialize experts with tools
                config.experts.forEach(expert => {
                    const expertTools = expert.tools || [];
                    let initialStatus = 'thinking';
                    if (expertTools.includes('searching') || expert.search) {
                        initialStatus = 'searching';
                    } else if (expertTools.includes('thinking')) {
                        initialStatus = 'thinking';
                    }
                    
                    expertResults.push({
                        name: expert.name,
                        id: expert.id,
                        search: expert.search,
                        tools: expertTools,
                        status: initialStatus,
                        response: null,
                        searchResults: null,
                        thinkingOutput: null
                    });
                });
                updateExpertGrid(expertResults);
                
                // Process experts in parallel with forced tools
                const expertPromises = config.experts.map(async (expert, index) => {
                    try {
                        const weightInfo = getExpertWeight(expert.id);
                        let expertContext = toolContext;
                        const expertTools = expert.tools || [];
                        
                        // Execute forced tools for this expert
                        for (const tool of expertTools) {
                            if (tool === 'searching' || expert.search) {
                                expertResults[index].status = 'searching';
                                updateExpertGrid(expertResults);
                                
                                const searchVariants = [
                                    content,
                                    `${content} latest 2024`,
                                    `${content} tutorial`,
                                    `${content} best practices`,
                                    `${content} examples`,
                                    `${content} documentation`,
                                    `${content} guide`,
                                    `${content} how to`
                                ];
                                
                                const searchQuery = searchVariants[index % searchVariants.length];
                                const expertSearch = await performWebSearch(searchQuery, 6, true);
                                expertResults[index].searchResults = expertSearch;
                                
                                expertContext += '\n\n--- WEB SEARCH RESULTS ---\n' + expertSearch.map((r, i) => 
                                    `[Source ${i+1}] ${r.title} (${r.source})\n${r.snippet}\nURL: ${r.url}`
                                ).join('\n\n');
                            }
                            
                            if (tool === 'thinking') {
                                expertResults[index].status = 'thinking';
                                updateExpertGrid(expertResults);
                                
                                // Force the model to think first
                                const thinkPrompt = `Before answering, think step by step about: "${content}"\n\nAnalyze the problem, consider different approaches, and reason through the solution.`;
                                
                                try {
                                    const thinkResponse = await callModel(expert.id, [
                                        { role: 'system', content: `You are ${expert.name}. Think deeply and reason step by step. Show your thinking process.` },
                                        { role: 'user', content: thinkPrompt }
                                    ]);
                                    
                                    expertResults[index].thinkingOutput = thinkResponse;
                                    expertContext += '\n\n--- MY THINKING ---\n' + thinkResponse;
                                    updateExpertGrid(expertResults);
                                } catch (e) {
                                    console.log('Thinking step failed for', expert.name, e);
                                }
                            }
                        }
                        
                        // Deep Research: Each expert searches (legacy support)
                        if (expert.search && !expertTools.includes('searching')) {
                            expertResults[index].status = 'searching';
                            updateExpertGrid(expertResults);
                            
                            const searchVariants = [
                                content,
                                `${content} latest`,
                                `${content} research`,
                                `${content} analysis`,
                                `${content} overview`,
                                `${content} examples`,
                                `${content} guide`,
                                `${content} 2024`
                            ];
                            
                            const searchQuery = searchVariants[index % searchVariants.length];
                            const expertSearch = await performWebSearch(searchQuery, 5);
                            expertResults[index].searchResults = expertSearch;
                            
                            expertContext += '\n\n' + expertSearch.map((r, i) => 
                                `[Source ${i+1}] ${r.title}: ${r.snippet}`
                            ).join('\n\n');
                        }
                        
                        expertResults[index].status = 'thinking';
                        updateExpertGrid(expertResults);
                        
                        let systemPrompt = `You are ${expert.name}, a ${weightInfo.role}.`;
                        
                        if (expert.id === 'ERNIE-4.5-VL') {
                            systemPrompt = ERNIE_ENGLISH_PROMPT;
                        }
                        
                        if (moeKey === 'deepresearch') {
                            systemPrompt += ` Conduct deep research. Analyze search results, synthesize findings, cite sources. Provide comprehensive, well-researched answers.`;
                        } else if (moeKey === 'code') {
                            systemPrompt += ` You are a coding expert. Use the search results and your thinking to provide clean, documented, production-ready code. Include comments and explanations.`;
                        }
                        
                        let userPrompt = content;
                        if (expertContext) {
                            userPrompt = `${content}\n\n${expertContext}`;
                        }
                        
                        const response = await callModel(expert.id, [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: userPrompt }
                        ]);
                        
                        expertResults[index].response = response;
                        expertResults[index].status = 'complete';
                    } catch (error) {
                        expertResults[index].response = `Error: ${error.message}`;
                        expertResults[index].status = 'error';
                    }
                    
                    updateExpertGrid(expertResults);
                    return expertResults[index];
                });
                
                // Wait for ALL experts
                await Promise.allSettled(expertPromises);
                
                const successfulExperts = expertResults.filter(e => e.status === 'complete');
                const completedCount = successfulExperts.length;
                const totalCount = expertResults.length;
                
                // Create aggregator container
                const aggregatorDiv = document.createElement('div');
                aggregatorDiv.className = 'aggregator-response rounded-2xl p-4 mt-4';
                
                const responseId = Date.now();
                
                aggregatorDiv.innerHTML = `
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                            <i class="fas fa-brain text-white text-sm"></i>
                        </div>
                        <span class="font-medium">SAHU 1 MoE Aggregator</span>
                        <span class="text-xs text-[var(--text-secondary)]">(${config.aggregator})</span>
                    </div>
                    
                    <div id="phase1" class="mb-3 p-3 bg-[var(--bg-secondary)] rounded-lg">
                        <div class="flex items-center gap-2 text-blue-400">
                            <i class="fas fa-book-reader"></i>
                            <span class="text-sm">Reading ${completedCount}/${totalCount} expert responses...</span>
                            <div class="typing-indicator ml-2 flex gap-1">
                                <span class="w-1.5 h-1.5 bg-blue-400 rounded-full"></span>
                                <span class="w-1.5 h-1.5 bg-blue-400 rounded-full"></span>
                                <span class="w-1.5 h-1.5 bg-blue-400 rounded-full"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div id="phase2" class="mb-3 p-3 bg-[var(--bg-secondary)] rounded-lg hidden">
                        <div class="flex items-center gap-2 text-yellow-400">
                            <i class="fas fa-balance-scale"></i>
                            <span class="text-sm">Analyzing & weighting expert votes...</span>
                        </div>
                    </div>
                    
                    <div id="phase3" class="mb-3 p-3 bg-[var(--bg-secondary)] rounded-lg hidden">
                        <div class="flex items-center gap-2 text-orange-400">
                            <i class="fas fa-lightbulb"></i>
                            <span class="text-sm">Meta-reasoning over outputs...</span>
                        </div>
                    </div>
                    
                    <div id="phase4" class="mb-3 p-3 bg-[var(--bg-secondary)] rounded-lg hidden">
                        <div class="flex items-center gap-2 text-purple-400">
                            <i class="fas fa-project-diagram"></i>
                            <span class="text-sm">Synthesizing final answer...</span>
                        </div>
                    </div>
                    
                    <div id="finalResponse" class="hidden">
                        <div class="flex items-center gap-2 mb-2 text-green-400">
                            <i class="fas fa-check-circle"></i>
                            <span class="text-sm font-medium">Final Synthesized Response</span>
                        </div>
                        <div id="content-${responseId}" class="streaming-cursor text-[var(--text-primary)]"></div>
                        <div id="exportButtons-${responseId}"></div>
                        <div id="codePreview-${responseId}"></div>
                    </div>
                `;
                container.appendChild(aggregatorDiv);
                container.scrollTop = container.scrollHeight;
                
                // Animate phases
                await sleep(600);
                document.getElementById('phase1').innerHTML = `<div class="flex items-center gap-2 text-blue-400"><i class="fas fa-check-circle"></i><span class="text-sm">Read ${completedCount} expert responses</span></div>`;
                document.getElementById('phase2').classList.remove('hidden');
                
                await sleep(500);
                const highWeight = successfulExperts.filter(e => getExpertWeight(e.id).weight === 'high').length;
                const medWeight = successfulExperts.filter(e => getExpertWeight(e.id).weight === 'medium').length;
                const lowWeight = successfulExperts.filter(e => getExpertWeight(e.id).weight === 'low').length;
                
                document.getElementById('phase2').innerHTML = `<div class="flex items-center gap-2 text-yellow-400"><i class="fas fa-check-circle"></i><span class="text-sm">Votes: ${highWeight} high, ${medWeight} medium, ${lowWeight} low</span></div>`;
                document.getElementById('phase3').classList.remove('hidden');
                
                await sleep(400);
                document.getElementById('phase3').innerHTML = `<div class="flex items-center gap-2 text-orange-400"><i class="fas fa-check-circle"></i><span class="text-sm">Consensus identified</span></div>`;
                document.getElementById('phase4').classList.remove('hidden');
                document.getElementById('finalResponse').classList.remove('hidden');
                
                // Build aggregator prompt
                const aggregatorUserPrompt = buildAggregatorPrompt(content, expertResults);
                
                let aggregatedResponse = '';
                const streamingDiv = document.getElementById(`content-${responseId}`);
                const shouldStream = localStorage.getItem('sahu_stream') !== 'false';
                
                try {
                    if (shouldStream) {
                        aggregatedResponse = await callModel(
                            config.aggregator, 
                            [
                                { role: 'system', content: AGGREGATOR_SYSTEM_PROMPT },
                                { role: 'user', content: aggregatorUserPrompt }
                            ], 
                            [],
                            true,
                            (chunk, fullText) => {
                                streamingDiv.innerHTML = formatMarkdown(fullText);
                                container.scrollTop = container.scrollHeight;
                            }
                        );
                    } else {
                        aggregatedResponse = await callModel(config.aggregator, [
                            { role: 'system', content: AGGREGATOR_SYSTEM_PROMPT },
                            { role: 'user', content: aggregatorUserPrompt }
                        ]);
                        
                        const words = aggregatedResponse.split(' ');
                        let displayed = '';
                        for (let i = 0; i < words.length; i++) {
                            displayed += (i > 0 ? ' ' : '') + words[i];
                            streamingDiv.innerHTML = formatMarkdown(displayed);
                            container.scrollTop = container.scrollHeight;
                            await sleep(25);
                        }
                    }
                } catch (error) {
                    if (successfulExperts.length > 0) {
                        const best = successfulExperts.sort((a, b) => getExpertWeight(b.id).score - getExpertWeight(a.id).score)[0];
                        aggregatedResponse = `**Synthesized (fallback):**\n\n${best.response}`;
                    } else {
                        aggregatedResponse = 'Error generating response. Check API configuration.';
                    }
                    streamingDiv.innerHTML = formatMarkdown(aggregatedResponse);
                }
                
                // Complete
                document.getElementById('phase4').innerHTML = `<div class="flex items-center gap-2 text-green-400"><i class="fas fa-check-circle"></i><span class="text-sm">Complete</span></div>`;
                streamingDiv.classList.remove('streaming-cursor');
                streamingDiv.classList.add('complete');
                
                // Add export buttons if file format enabled
                if (state.fileFormat !== 'off' || config.supportsFileExport) {
                    document.getElementById(`exportButtons-${responseId}`).innerHTML = createExportButtons(aggregatedResponse, responseId);
                }
                
                // Add code preview for Code mode
                if (config.supportsCodePreview) {
                    const codeBlocks = extractCodeBlocks(aggregatedResponse);
                    if (codeBlocks.length > 0) {
                        const previewHtml = codeBlocks.map((block, i) => 
                            createCodePreview(block.code, block.language, `${responseId}-${i}`)
                        ).join('');
                        document.getElementById(`codePreview-${responseId}`).innerHTML = previewHtml;
                    }
                }
                
                // Update expert grid
                expertPlaceholder.remove();
                const expertGridDiv = document.createElement('div');
                expertGridDiv.innerHTML = createExpertGrid(expertResults);
                aggregatorDiv.parentNode.insertBefore(expertGridDiv, aggregatorDiv);
                
                // Add tool logs
                toolLogs.forEach(log => {
                    const logDiv = document.createElement('div');
                    logDiv.innerHTML = createToolLog(log.tool, log.content);
                    expertGridDiv.insertBefore(logDiv, expertGridDiv.firstChild);
                });
                
                // Save
                state.messages.push({ 
                    role: 'assistant', 
                    content: aggregatedResponse,
                    experts: expertResults
                });
                
                if (!state.currentChatId) {
                    state.currentChatId = Date.now().toString();
                }
                
                const existingChat = state.chatHistory.find(c => c.id === state.currentChatId);
                if (existingChat) {
                    existingChat.messages = state.messages;
                } else {
                    state.chatHistory.unshift({
                        id: state.currentChatId,
                        title: content.substring(0, 30) + '...',
                        messages: state.messages,
                        timestamp: Date.now()
                    });
                }
                saveChatHistory();
                renderChatHistory();
                
            } catch (error) {
                console.error('Error:', error);
                appendAssistantMessage(`**Error:** ${error.message}\n\nCheck API configuration in Settings.`);
            } finally {
                state.isProcessing = false;
                document.getElementById('sendBtn').disabled = false;
            }
        }

        // Close menus on outside click
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('providerMenu');
            const button = e.target.closest('[onclick="toggleProviderMenu()"]');
            if (!button && !menu.contains(e.target)) {
                menu.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
