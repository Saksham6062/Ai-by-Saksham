<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAHU 1 MoE - Mixture of Experts</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #252525;
            --text-primary: #e5e5e5;
            --text-secondary: #a3a3a3;
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --border: #333;
        }
        .light-mode {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e5e5e5;
            --text-primary: #1a1a1a;
            --text-secondary: #525252;
            --accent: #4f46e5;
            --accent-hover: #6366f1;
            --border: #d4d4d4;
        }
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .sidebar {
            background-color: var(--bg-secondary);
            border-color: var(--border);
        }
        .chat-container {
            background-color: var(--bg-primary);
        }
        .message-user {
            background-color: var(--accent);
        }
        .message-assistant {
            background-color: var(--bg-tertiary);
        }
        .input-area {
            background-color: var(--bg-secondary);
            border-color: var(--border);
        }
        .expert-card {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border);
        }
        .expert-card.thinking {
            border-color: #f59e0b;
            animation: pulse-border 2s infinite;
        }
        .expert-card.complete {
            border-color: #22c55e;
        }
        .expert-card.error {
            border-color: #ef4444;
        }
        @keyframes pulse-border {
            0%, 100% { border-color: #f59e0b; box-shadow: 0 0 5px rgba(245, 158, 11, 0.3); }
            50% { border-color: #fbbf24; box-shadow: 0 0 15px rgba(245, 158, 11, 0.5); }
        }
        .typing-indicator span {
            animation: typing 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }
        .tool-log {
            background-color: var(--bg-secondary);
            border-left: 3px solid var(--accent);
        }
        .scrollbar-thin::-webkit-scrollbar {
            width: 6px;
        }
        .scrollbar-thin::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        .scrollbar-thin::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }
        .provider-menu {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border);
        }
        .dropdown-item:hover {
            background-color: var(--bg-tertiary);
        }
        pre code {
            display: block;
            padding: 1rem;
            background: #1e1e1e;
            border-radius: 0.5rem;
            overflow-x: auto;
        }
        .aggregator-response {
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, rgba(99, 102, 241, 0.1) 100%);
            border: 2px solid var(--accent);
        }
        
        /* Streaming cursor effect */
        #streamingContent::after {
            content: '‚ñä';
            animation: blink 1s infinite;
            color: var(--accent);
            margin-left: 2px;
        }
        
        #streamingContent.complete::after {
            display: none;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Phase indicators */
        .aggregator-response .typing-indicator span {
            width: 6px;
            height: 6px;
        }
        
        /* Notification toast */
        .notification-toast {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body class="h-screen overflow-hidden">
    <div id="app" class="flex h-full">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar w-64 h-full flex flex-col border-r transition-all duration-300">
            <!-- Logo -->
            <div class="p-4 border-b border-[var(--border)]">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                        <i class="fas fa-brain text-white"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-lg">SAHU 1</h1>
                        <p class="text-xs text-[var(--text-secondary)]">Mixture of Experts</p>
                    </div>
                </div>
            </div>

            <!-- New Chat Button -->
            <div class="p-3">
                <button onclick="newChat()" class="w-full py-2.5 px-4 rounded-lg bg-[var(--accent)] hover:bg-[var(--accent-hover)] text-white font-medium flex items-center justify-center gap-2 transition-colors">
                    <i class="fas fa-plus"></i>
                    New Chat
                </button>
            </div>

            <!-- MoE Selector -->
            <div class="px-3 pb-3">
                <label class="text-xs text-[var(--text-secondary)] mb-1 block">MoE Configuration</label>
                <select id="moeSelector" onchange="changeMoE()" class="w-full p-2.5 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] text-sm focus:outline-none focus:border-[var(--accent)]">
                    <option value="agent">ü§ñ Sahu 1 Agent</option>
                    <option value="deepthink">üß† Sahu 1 DeepThink</option>
                    <option value="deepresearch">üîç Sahu 1 Deep Research</option>
                    <option value="code">üíª Sahu 1 Code</option>
                    <option value="fast">‚ö° Sahu 1 Fast</option>
                    <option value="chat">üí¨ Sahu 1 Chat</option>
                </select>
            </div>

            <!-- Chat History -->
            <div class="flex-1 overflow-y-auto scrollbar-thin px-3">
                <p class="text-xs text-[var(--text-secondary)] mb-2">History</p>
                <div id="chatHistory" class="space-y-1">
                    <!-- Chat history items will be inserted here -->
                </div>
            </div>

            <!-- Settings -->
            <div class="p-3 border-t border-[var(--border)]">
                <button onclick="openSettings()" class="w-full py-2 px-3 rounded-lg hover:bg-[var(--bg-tertiary)] flex items-center gap-3 transition-colors">
                    <i class="fas fa-cog text-[var(--text-secondary)]"></i>
                    <span class="text-sm">Settings</span>
                </button>
                <button onclick="toggleTheme()" class="w-full py-2 px-3 rounded-lg hover:bg-[var(--bg-tertiary)] flex items-center gap-3 transition-colors">
                    <i id="themeIcon" class="fas fa-moon text-[var(--text-secondary)]"></i>
                    <span class="text-sm" id="themeText">Dark Mode</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-full">
            <!-- Header -->
            <header class="h-14 border-b border-[var(--border)] flex items-center justify-between px-4">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="p-2 rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors">
                        <i class="fas fa-bars"></i>
                    </button>
                    <span id="currentMoELabel" class="font-medium">ü§ñ Sahu 1 Agent</span>
                    <span id="expertCount" class="text-xs bg-[var(--accent)] text-white px-2 py-0.5 rounded-full">Auto</span>
                </div>
                
                <!-- Provider Menu -->
                <div class="relative">
                    <button onclick="toggleProviderMenu()" class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors">
                        <i class="fas fa-cloud"></i>
                        <span id="currentProvider" class="text-sm">HuggingFace</span>
                        <i class="fas fa-chevron-down text-xs"></i>
                    </button>
                    <div id="providerMenu" class="provider-menu absolute right-0 top-full mt-2 w-56 rounded-lg shadow-xl z-50 hidden">
                        <div class="p-2">
                            <div onclick="selectProvider('huggingface')" class="dropdown-item px-3 py-2 rounded-lg cursor-pointer flex items-center gap-3">
                                <i class="fas fa-fire text-orange-400"></i>
                                <span>HuggingFace</span>
                                <i class="fas fa-check ml-auto text-green-400 provider-check" data-provider="huggingface"></i>
                            </div>
                            <div onclick="selectProvider('openrouter')" class="dropdown-item px-3 py-2 rounded-lg cursor-pointer flex items-center gap-3">
                                <i class="fas fa-route text-blue-400"></i>
                                <span>OpenRouter</span>
                                <i class="fas fa-check ml-auto text-green-400 provider-check hidden" data-provider="openrouter"></i>
                            </div>
                            <div onclick="selectProvider('groq')" class="dropdown-item px-3 py-2 rounded-lg cursor-pointer flex items-center gap-3">
                                <i class="fas fa-bolt text-yellow-400"></i>
                                <span>Groq</span>
                                <i class="fas fa-check ml-auto text-green-400 provider-check hidden" data-provider="groq"></i>
                            </div>
                            <div onclick="selectProvider('togetherai')" class="dropdown-item px-3 py-2 rounded-lg cursor-pointer flex items-center gap-3">
                                <i class="fas fa-cubes text-purple-400"></i>
                                <span>TogetherAI</span>
                                <i class="fas fa-check ml-auto text-green-400 provider-check hidden" data-provider="togetherai"></i>
                            </div>
                            <div onclick="selectProvider('ollama')" class="dropdown-item px-3 py-2 rounded-lg cursor-pointer flex items-center gap-3">
                                <i class="fas fa-server text-green-400"></i>
                                <span>Ollama (Local)</span>
                                <i class="fas fa-check ml-auto text-green-400 provider-check hidden" data-provider="ollama"></i>
                            </div>
                            <hr class="my-2 border-[var(--border)]">
                            <div onclick="openProviderSettings()" class="dropdown-item px-3 py-2 rounded-lg cursor-pointer flex items-center gap-3">
                                <i class="fas fa-key text-[var(--text-secondary)]"></i>
                                <span>API Keys</span>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Chat Area -->
            <div id="chatArea" class="flex-1 overflow-y-auto scrollbar-thin p-4">
                <!-- Welcome Screen -->
                <div id="welcomeScreen" class="h-full flex flex-col items-center justify-center">
                    <div class="w-20 h-20 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center mb-6">
                        <i class="fas fa-brain text-3xl text-white"></i>
                    </div>
                    <h2 class="text-2xl font-bold mb-2">SAHU 1 MoE</h2>
                    <p class="text-[var(--text-secondary)] mb-8 text-center max-w-md">
                        Orchestrate multiple AI experts to get comprehensive, synthesized answers.
                    </p>
                    <div class="grid grid-cols-2 gap-3 max-w-lg">
                        <button onclick="quickPrompt('Explain quantum computing')" class="p-4 rounded-xl bg-[var(--bg-tertiary)] hover:bg-[var(--border)] text-left transition-colors">
                            <i class="fas fa-atom text-indigo-400 mb-2"></i>
                            <p class="text-sm">Explain quantum computing</p>
                        </button>
                        <button onclick="quickPrompt('Write a Python web scraper')" class="p-4 rounded-xl bg-[var(--bg-tertiary)] hover:bg-[var(--border)] text-left transition-colors">
                            <i class="fas fa-code text-green-400 mb-2"></i>
                            <p class="text-sm">Write a Python web scraper</p>
                        </button>
                        <button onclick="quickPrompt('Research latest AI developments')" class="p-4 rounded-xl bg-[var(--bg-tertiary)] hover:bg-[var(--border)] text-left transition-colors">
                            <i class="fas fa-search text-blue-400 mb-2"></i>
                            <p class="text-sm">Research latest AI developments</p>
                        </button>
                        <button onclick="quickPrompt('Create a business plan outline')" class="p-4 rounded-xl bg-[var(--bg-tertiary)] hover:bg-[var(--border)] text-left transition-colors">
                            <i class="fas fa-briefcase text-yellow-400 mb-2"></i>
                            <p class="text-sm">Create a business plan outline</p>
                        </button>
                    </div>
                </div>

                <!-- Messages Container -->
                <div id="messagesContainer" class="hidden space-y-6 max-w-5xl mx-auto">
                    <!-- Messages will be inserted here -->
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 border-t border-[var(--border)]">
                <div class="max-w-4xl mx-auto">
                    <div class="input-area rounded-2xl border p-3">
                        <div class="flex items-end gap-3">
                            <label class="cursor-pointer p-2 rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors">
                                <i class="fas fa-plus text-[var(--text-secondary)]"></i>
                                <input type="file" id="fileInput" class="hidden" multiple onchange="handleFileUpload(event)">
                            </label>
                            <div id="attachmentPreview" class="hidden flex gap-2 flex-wrap"></div>
                            <textarea 
                                id="userInput" 
                                placeholder="Message SAHU 1 MoE..." 
                                class="flex-1 bg-transparent resize-none outline-none max-h-40 text-sm"
                                rows="1"
                                onkeydown="handleKeyDown(event)"
                                oninput="autoResize(this)"
                            ></textarea>
                            <button onclick="sendMessage()" id="sendBtn" class="p-2.5 rounded-xl bg-[var(--accent)] hover:bg-[var(--accent-hover)] text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-center text-[var(--text-secondary)] mt-2">
                        SAHU 1 MoE orchestrates multiple AI experts. Responses may vary.
                    </p>
                </div>
            </div>
        </main>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-[var(--bg-secondary)] rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden shadow-2xl">
            <div class="flex items-center justify-between p-4 border-b border-[var(--border)] bg-[var(--bg-tertiary)]">
                <h2 class="text-lg font-bold flex items-center gap-2">
                    <i class="fas fa-cog text-[var(--accent)]"></i>
                    Settings
                </h2>
                <button onclick="closeSettings()" class="p-2 rounded-lg hover:bg-[var(--bg-secondary)] transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4 overflow-y-auto max-h-[65vh] scrollbar-thin">
                <div id="settingsContent">
                    <!-- API Keys Section -->
                    <div class="mb-6 bg-[var(--bg-tertiary)] rounded-xl p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-medium flex items-center gap-2">
                                <i class="fas fa-key text-[var(--accent)]"></i>
                                API Keys & Endpoints
                            </h3>
                            <button onclick="saveSettings()" class="px-3 py-1.5 text-sm rounded-lg bg-[var(--accent)] hover:bg-[var(--accent-hover)] text-white transition-colors flex items-center gap-2">
                                <i class="fas fa-save"></i>
                                Save
                            </button>
                        </div>
                        <div class="space-y-4">
                            <!-- HuggingFace -->
                            <div class="p-3 bg-[var(--bg-secondary)] rounded-lg">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fas fa-fire text-orange-400"></i>
                                    <span class="font-medium text-sm">HuggingFace</span>
                                </div>
                                <div class="space-y-2">
                                    <input type="password" id="hfApiKey" placeholder="API Key: hf_..." class="w-full p-2.5 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none">
                                    <input type="text" id="hfEndpoint" placeholder="Endpoint: https://router.huggingface.co/v1/chat/completions" class="w-full p-2.5 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none">
                                </div>
                            </div>
                            <!-- OpenRouter -->
                            <div class="p-3 bg-[var(--bg-secondary)] rounded-lg">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fas fa-route text-blue-400"></i>
                                    <span class="font-medium text-sm">OpenRouter</span>
                                </div>
                                <div class="space-y-2">
                                    <input type="password" id="orApiKey" placeholder="API Key: sk-or-..." class="w-full p-2.5 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none">
                                    <input type="text" id="orEndpoint" placeholder="Endpoint: https://openrouter.ai/api/v1/chat/completions" class="w-full p-2.5 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none">
                                </div>
                            </div>
                            <!-- Groq -->
                            <div class="p-3 bg-[var(--bg-secondary)] rounded-lg">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fas fa-bolt text-yellow-400"></i>
                                    <span class="font-medium text-sm">Groq</span>
                                </div>
                                <div class="space-y-2">
                                    <input type="password" id="groqApiKey" placeholder="API Key: gsk_..." class="w-full p-2.5 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none">
                                    <input type="text" id="groqEndpoint" placeholder="Endpoint: https://api.groq.com/openai/v1/chat/completions" class="w-full p-2.5 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none">
                                </div>
                            </div>
                            <!-- TogetherAI -->
                            <div class="p-3 bg-[var(--bg-secondary)] rounded-lg">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fas fa-cubes text-purple-400"></i>
                                    <span class="font-medium text-sm">TogetherAI</span>
                                </div>
                                <div class="space-y-2">
                                    <input type="password" id="togetherApiKey" placeholder="API Key..." class="w-full p-2.5 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none">
                                    <input type="text" id="togetherEndpoint" placeholder="Endpoint: https://api.together.xyz/v1/chat/completions" class="w-full p-2.5 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none">
                                </div>
                            </div>
                            <!-- Ollama -->
                            <div class="p-3 bg-[var(--bg-secondary)] rounded-lg">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fas fa-server text-green-400"></i>
                                    <span class="font-medium text-sm">Ollama (Local)</span>
                                </div>
                                <input type="text" id="ollamaEndpoint" placeholder="Endpoint: http://localhost:11434/api/chat" class="w-full p-2.5 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Advanced Settings -->
                    <div class="mb-6 bg-[var(--bg-tertiary)] rounded-xl p-4">
                        <h3 class="font-medium mb-4 flex items-center gap-2">
                            <i class="fas fa-sliders-h text-[var(--accent)]"></i>
                            Advanced Settings
                        </h3>
                        <div class="space-y-4">
                            <div class="flex items-center gap-4">
                                <div class="flex-1">
                                    <label class="text-sm text-[var(--text-secondary)] mb-1 block">Max Tokens</label>
                                    <input type="number" id="maxTokens" value="4096" class="w-full p-2.5 rounded-lg bg-[var(--bg-secondary)] border border-[var(--border)] text-sm focus:border-[var(--accent)] focus:outline-none">
                                </div>
                                <div class="flex-1">
                                    <label class="text-sm text-[var(--text-secondary)] mb-1 block">Temperature: <span id="tempValue">0.7</span></label>
                                    <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.7" class="w-full accent-[var(--accent)]">
                                </div>
                            </div>
                            <div class="flex items-center justify-between p-3 bg-[var(--bg-secondary)] rounded-lg">
                                <div>
                                    <span class="text-sm font-medium">Stream Responses</span>
                                    <p class="text-xs text-[var(--text-secondary)]">Show aggregator response word by word</p>
                                </div>
                                <input type="checkbox" id="streamResponses" checked class="w-5 h-5 accent-[var(--accent)]">
                            </div>
                            <div class="flex items-center justify-between p-3 bg-[var(--bg-secondary)] rounded-lg">
                                <div>
                                    <span class="text-sm font-medium">Show Expert Outputs</span>
                                    <p class="text-xs text-[var(--text-secondary)]">Display individual expert responses</p>
                                </div>
                                <input type="checkbox" id="showExperts" checked class="w-5 h-5 accent-[var(--accent)]">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t border-[var(--border)] bg-[var(--bg-tertiary)] flex justify-between items-center">
                <span class="text-xs text-[var(--text-secondary)]">
                    <i class="fas fa-info-circle mr-1"></i>
                    All settings are stored locally in your browser
                </span>
                <div class="flex gap-3">
                    <button onclick="closeSettings()" class="px-4 py-2.5 rounded-lg hover:bg-[var(--bg-secondary)] transition-colors">Cancel</button>
                    <button onclick="saveSettings()" class="px-6 py-2.5 rounded-lg bg-[var(--accent)] hover:bg-[var(--accent-hover)] text-white font-medium transition-colors flex items-center gap-2">
                        <i class="fas fa-save"></i>
                        Save Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // SAHU 1 MoE - Core Configuration
        // ==========================================

        // Model IDs (Verified)
        const MODELS = {
            'GLM-4.7': 'zai-org/GLM-4.7',
            'GLM-4.7-Flash': 'zai-org/GLM-4.7-Flash',
            'Phi-4-Reasoning': 'microsoft/Phi-4-reasoning-plus',
            'DeepSeek-V3.2': 'deepseek-ai/DeepSeek-V3.2',
            'DeepSeek-R1': 'deepseek-ai/DeepSeek-R1',
            'DeepSeek-Coder': 'deepseek-ai/DeepSeek-Coder-V2-Lite-Instruct',
            'DeepSeek-R1-Distill': 'deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B',
            'Qwen3-Coder': 'Qwen/Qwen3-Coder-480B-A35B-Instruct',
            'Qwen3-Thinking': 'Qwen/Qwen3-235B-A22B-Thinking-2507',
            'Devstral': 'mistralai/Devstral-2-123B-Instruct-2512',
            'Codestral': 'mistralai/Codestral-22B-v0.1',
            'Mistral-7B': 'mistralai/Mistral-7B-Instruct-v0.3',
            'Kimi-K2-Thinking': 'moonshotai/Kimi-K2-Thinking',
            'Kimi-K2': 'moonshotai/Kimi-K2-Instruct',
            'Kimi-K2.5': 'moonshotai/Kimi-K2.5',
            'gpt-oss-120b': 'openai/gpt-oss-120b',
            'gpt-oss-20b': 'openai/gpt-oss-20b',
            'MiMo-V2-Flash': 'XiaomiMiMo/MiMo-V2-Flash',
            'MiniMax-M2.1': 'MiniMaxAI/MiniMax-M2.1',
            'Olmo-3.1-Instruct': 'allenai/Olmo-3.1-32B-Instruct',
            'Olmo-3.1-Think': 'allenai/Olmo-3.1-32B-Think',
            'Llama-3.3-70B': 'meta-llama/Llama-3.3-70B-Instruct'
        };

        // MoE Configurations
        const MOE_CONFIGS = {
            deepthink: {
                name: 'Sahu 1 DeepThink',
                icon: 'üß†',
                tools: ['thinking'],
                experts: [
                    { id: 'DeepSeek-R1', name: 'DeepSeek R1' },
                    { id: 'gpt-oss-120b', name: 'GPT-OSS 120B' },
                    { id: 'DeepSeek-V3.2', name: 'DeepSeek V3.2' },
                    { id: 'Kimi-K2-Thinking', name: 'Kimi K2 Thinking' },
                    { id: 'Kimi-K2.5', name: 'Kimi K2.5' },
                    { id: 'Qwen3-Thinking', name: 'Qwen3 Thinking' },
                    { id: 'GLM-4.7', name: 'GLM 4.7' },
                    { id: 'Olmo-3.1-Think', name: 'Olmo Think' },
                    { id: 'Phi-4-Reasoning', name: 'Phi-4 Reasoning' },
                    { id: 'MiniMax-M2.1', name: 'MiniMax M2.1' }
                ],
                aggregator: 'Qwen3-Thinking',
                behavior: 'Extended reasoning with deep thought chains'
            },
            deepresearch: {
                name: 'Sahu 1 Deep Research',
                icon: 'üîç',
                tools: ['searching'],
                experts: [
                    { id: 'gpt-oss-20b', name: 'GPT-OSS 20B' },
                    { id: 'DeepSeek-V3.2', name: 'DeepSeek V3.2', tools: ['search'] },
                    { id: 'Kimi-K2', name: 'Kimi K2', tools: ['search'] },
                    { id: 'Kimi-K2.5', name: 'Kimi K2.5', tools: ['search'] },
                    { id: 'GLM-4.7', name: 'GLM 4.7', tools: ['search'] },
                    { id: 'Olmo-3.1-Instruct', name: 'Olmo Instruct' },
                    { id: 'MiniMax-M2.1', name: 'MiniMax M2.1' },
                    { id: 'MiMo-V2-Flash', name: 'MiMo V2 Flash' }
                ],
                aggregator: 'Kimi-K2.5',
                aggregatorTools: ['thinking', 'searching'],
                behavior: 'Delayed research with web search and synthesis'
            },
            code: {
                name: 'Sahu 1 Code',
                icon: 'üíª',
                tools: ['thinking', 'searching', 'planning'],
                experts: [
                    { id: 'gpt-oss-120b', name: 'GPT-OSS 120B' },
                    { id: 'DeepSeek-V3.2', name: 'DeepSeek V3.2' },
                    { id: 'Kimi-K2', name: 'Kimi K2' },
                    { id: 'Kimi-K2.5', name: 'Kimi K2.5' },
                    { id: 'Qwen3-Coder', name: 'Qwen3 Coder' },
                    { id: 'DeepSeek-Coder', name: 'DeepSeek Coder' },
                    { id: 'GLM-4.7', name: 'GLM 4.7' },
                    { id: 'Devstral', name: 'Devstral' },
                    { id: 'Codestral', name: 'Codestral' },
                    { id: 'MiniMax-M2.1', name: 'MiniMax M2.1' }
                ],
                aggregator: 'GLM-4.7',
                behavior: 'Multi-model code generation and review'
            },
            fast: {
                name: 'Sahu 1 Fast',
                icon: '‚ö°',
                tools: [],
                experts: [
                    { id: 'gpt-oss-20b', name: 'GPT-OSS 20B' },
                    { id: 'DeepSeek-V3.2', name: 'DeepSeek V3.2' },
                    { id: 'Kimi-K2', name: 'Kimi K2' },
                    { id: 'Kimi-K2.5', name: 'Kimi K2.5' },
                    { id: 'GLM-4.7-Flash', name: 'GLM Flash' },
                    { id: 'Llama-3.3-70B', name: 'Llama 3.3' },
                    { id: 'DeepSeek-R1-Distill', name: 'DeepSeek Distill' },
                    { id: 'MiMo-V2-Flash', name: 'MiMo Flash' }
                ],
                aggregator: 'MiMo-V2-Flash',
                behavior: 'Quick responses, no tools'
            },
            chat: {
                name: 'Sahu 1 Chat',
                icon: 'üí¨',
                tools: [],
                experts: [
                    { id: 'gpt-oss-20b', name: 'GPT-OSS 20B' },
                    { id: 'DeepSeek-V3.2', name: 'DeepSeek V3.2' },
                    { id: 'Kimi-K2', name: 'Kimi K2' },
                    { id: 'Kimi-K2.5', name: 'Kimi K2.5' },
                    { id: 'GLM-4.7', name: 'GLM 4.7' },
                    { id: 'Olmo-3.1-Instruct', name: 'Olmo Instruct' },
                    { id: 'MiniMax-M2.1', name: 'MiniMax M2.1' },
                    { id: 'MiMo-V2-Flash', name: 'MiMo Flash' }
                ],
                aggregator: 'gpt-oss-20b',
                behavior: 'Balanced conversational responses'
            },
            agent: {
                name: 'Sahu 1 Agent',
                icon: 'ü§ñ',
                tools: ['thinking', 'searching', 'planning'],
                experts: [],
                aggregator: null,
                behavior: 'Auto-routes to optimal MoE based on task'
            }
        };

        // Provider Configurations
        const PROVIDERS = {
            huggingface: {
                name: 'HuggingFace',
                keyName: 'sahu_api_huggingface_key',
                endpointName: 'sahu_api_huggingface_endpoint',
                defaultEndpoint: 'https://router.huggingface.co/v1/chat/completions'
            },
            openrouter: {
                name: 'OpenRouter',
                keyName: 'sahu_api_openrouter_key',
                endpointName: 'sahu_api_openrouter_endpoint',
                defaultEndpoint: 'https://openrouter.ai/api/v1/chat/completions'
            },
            groq: {
                name: 'Groq',
                keyName: 'sahu_api_groq_key',
                endpointName: 'sahu_api_groq_endpoint',
                defaultEndpoint: 'https://api.groq.com/openai/v1/chat/completions'
            },
            togetherai: {
                name: 'TogetherAI',
                keyName: 'sahu_api_together_key',
                endpointName: 'sahu_api_together_endpoint',
                defaultEndpoint: 'https://api.together.xyz/v1/chat/completions'
            },
            ollama: {
                name: 'Ollama',
                keyName: null,
                endpointName: 'sahu_api_ollama_endpoint',
                defaultEndpoint: 'http://localhost:11434/api/chat'
            }
        };

        // ==========================================
        // State Management
        // ==========================================
        let state = {
            currentProvider: 'huggingface',
            currentMoE: 'agent',
            messages: [],
            chatHistory: [],
            currentChatId: null,
            isProcessing: false,
            attachments: [],
            theme: 'dark'
        };

        // ==========================================
        // Initialization
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            loadChatHistory();
            initTheme();
            updateMoELabel();
        });

        function initTheme() {
            const savedTheme = localStorage.getItem('sahu_theme') || 'dark';
            state.theme = savedTheme;
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                document.getElementById('themeIcon').className = 'fas fa-sun text-[var(--text-secondary)]';
                document.getElementById('themeText').textContent = 'Light Mode';
            }
        }

        function toggleTheme() {
            state.theme = state.theme === 'dark' ? 'light' : 'dark';
            document.body.classList.toggle('light-mode');
            localStorage.setItem('sahu_theme', state.theme);
            
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');
            if (state.theme === 'light') {
                icon.className = 'fas fa-sun text-[var(--text-secondary)]';
                text.textContent = 'Light Mode';
            } else {
                icon.className = 'fas fa-moon text-[var(--text-secondary)]';
                text.textContent = 'Dark Mode';
            }
        }

        // ==========================================
        // Provider & Settings Management
        // ==========================================
        function loadSettings() {
            // Load API keys into form
            document.getElementById('hfApiKey').value = localStorage.getItem('sahu_api_huggingface_key') || '';
            document.getElementById('hfEndpoint').value = localStorage.getItem('sahu_api_huggingface_endpoint') || PROVIDERS.huggingface.defaultEndpoint;
            document.getElementById('orApiKey').value = localStorage.getItem('sahu_api_openrouter_key') || '';
            document.getElementById('orEndpoint').value = localStorage.getItem('sahu_api_openrouter_endpoint') || PROVIDERS.openrouter.defaultEndpoint;
            document.getElementById('groqApiKey').value = localStorage.getItem('sahu_api_groq_key') || '';
            document.getElementById('groqEndpoint').value = localStorage.getItem('sahu_api_groq_endpoint') || PROVIDERS.groq.defaultEndpoint;
            document.getElementById('togetherApiKey').value = localStorage.getItem('sahu_api_together_key') || '';
            document.getElementById('togetherEndpoint').value = localStorage.getItem('sahu_api_together_endpoint') || PROVIDERS.togetherai.defaultEndpoint;
            document.getElementById('ollamaEndpoint').value = localStorage.getItem('sahu_api_ollama_endpoint') || PROVIDERS.ollama.defaultEndpoint;
            
            // Load advanced settings
            document.getElementById('maxTokens').value = localStorage.getItem('sahu_max_tokens') || 4096;
            document.getElementById('temperature').value = localStorage.getItem('sahu_temperature') || 0.7;
            document.getElementById('tempValue').textContent = document.getElementById('temperature').value;
            document.getElementById('streamResponses').checked = localStorage.getItem('sahu_stream') !== 'false';
            document.getElementById('showExperts').checked = localStorage.getItem('sahu_show_experts') !== 'false';
            
            // Temperature slider update
            document.getElementById('temperature').addEventListener('input', (e) => {
                document.getElementById('tempValue').textContent = e.target.value;
            });
            
            // Load current provider
            state.currentProvider = localStorage.getItem('sahu_current_provider') || 'huggingface';
            updateProviderUI();
        }

        function saveSettings() {
            localStorage.setItem('sahu_api_huggingface_key', document.getElementById('hfApiKey').value);
            localStorage.setItem('sahu_api_huggingface_endpoint', document.getElementById('hfEndpoint').value);
            localStorage.setItem('sahu_api_openrouter_key', document.getElementById('orApiKey').value);
            localStorage.setItem('sahu_api_openrouter_endpoint', document.getElementById('orEndpoint').value);
            localStorage.setItem('sahu_api_groq_key', document.getElementById('groqApiKey').value);
            localStorage.setItem('sahu_api_groq_endpoint', document.getElementById('groqEndpoint').value);
            localStorage.setItem('sahu_api_together_key', document.getElementById('togetherApiKey').value);
            localStorage.setItem('sahu_api_together_endpoint', document.getElementById('togetherEndpoint').value);
            localStorage.setItem('sahu_api_ollama_endpoint', document.getElementById('ollamaEndpoint').value);
            localStorage.setItem('sahu_max_tokens', document.getElementById('maxTokens').value);
            localStorage.setItem('sahu_temperature', document.getElementById('temperature').value);
            localStorage.setItem('sahu_stream', document.getElementById('streamResponses').checked);
            localStorage.setItem('sahu_show_experts', document.getElementById('showExperts').checked);
            
            closeSettings();
            showNotification('Settings saved successfully!');
        }

        function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }

        function openProviderSettings() {
            toggleProviderMenu();
            openSettings();
        }

        function toggleProviderMenu() {
            document.getElementById('providerMenu').classList.toggle('hidden');
        }

        function selectProvider(provider) {
            state.currentProvider = provider;
            localStorage.setItem('sahu_current_provider', provider);
            updateProviderUI();
            toggleProviderMenu();
        }

        function updateProviderUI() {
            document.getElementById('currentProvider').textContent = PROVIDERS[state.currentProvider].name;
            document.querySelectorAll('.provider-check').forEach(el => {
                el.classList.toggle('hidden', el.dataset.provider !== state.currentProvider);
            });
        }

        // ==========================================
        // UI Helpers
        // ==========================================
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('-ml-64');
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 160) + 'px';
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification-toast fixed bottom-4 right-4 px-4 py-3 rounded-lg text-white z-50 flex items-center gap-2 shadow-lg ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function quickPrompt(text) {
            document.getElementById('userInput').value = text;
            sendMessage();
        }

        // ==========================================
        // File Upload
        // ==========================================
        function handleFileUpload(event) {
            const files = event.target.files;
            const preview = document.getElementById('attachmentPreview');
            preview.classList.remove('hidden');
            preview.innerHTML = '';
            
            state.attachments = [];
            
            for (let file of files) {
                state.attachments.push(file);
                const chip = document.createElement('div');
                chip.className = 'flex items-center gap-2 bg-[var(--bg-tertiary)] px-3 py-1 rounded-full text-sm';
                chip.innerHTML = `
                    <i class="fas fa-file text-[var(--accent)]"></i>
                    <span>${file.name}</span>
                    <button onclick="removeAttachment('${file.name}')" class="text-[var(--text-secondary)] hover:text-red-400">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                preview.appendChild(chip);
            }
        }

        function removeAttachment(fileName) {
            state.attachments = state.attachments.filter(f => f.name !== fileName);
            const preview = document.getElementById('attachmentPreview');
            if (state.attachments.length === 0) {
                preview.classList.add('hidden');
            } else {
                handleFileUpload({ target: { files: state.attachments } });
            }
        }

        // ==========================================
        // MoE Selection & Routing
        // ==========================================
        function changeMoE() {
            state.currentMoE = document.getElementById('moeSelector').value;
            updateMoELabel();
        }

        function updateMoELabel() {
            const config = MOE_CONFIGS[state.currentMoE];
            document.getElementById('currentMoELabel').textContent = `${config.icon} ${config.name}`;
            
            if (state.currentMoE === 'agent') {
                document.getElementById('expertCount').textContent = 'Auto';
            } else {
                document.getElementById('expertCount').textContent = `${config.experts.length} experts`;
            }
        }

        function classifyTask(prompt) {
            const lower = prompt.toLowerCase();
            
            // Code detection
            if (/\b(code|program|function|script|api|debug|implement|algorithm|syntax|compile|python|javascript|html|css|sql)\b/.test(lower)) {
                return 'code';
            }
            
            // Research detection
            if (/\b(research|find|search|latest|news|discover|investigate|analyze data|statistics|study)\b/.test(lower)) {
                return 'deepresearch';
            }
            
            // Deep thinking detection
            if (/\b(explain|why|how does|theory|philosophical|complex|reasoning|prove|derive|analyze)\b/.test(lower)) {
                return 'deepthink';
            }
            
            // Fast/Simple queries
            if (lower.length < 50 || /\b(what is|define|quick|simple|short)\b/.test(lower)) {
                return 'fast';
            }
            
            return 'chat';
        }

        // ==========================================
        // Chat History
        // ==========================================
        function loadChatHistory() {
            const saved = localStorage.getItem('sahu_chat_history');
            if (saved) {
                state.chatHistory = JSON.parse(saved);
                renderChatHistory();
            }
        }

        function saveChatHistory() {
            localStorage.setItem('sahu_chat_history', JSON.stringify(state.chatHistory));
        }

        function renderChatHistory() {
            const container = document.getElementById('chatHistory');
            container.innerHTML = state.chatHistory.map(chat => `
                <div onclick="loadChat('${chat.id}')" class="p-2 rounded-lg hover:bg-[var(--bg-tertiary)] cursor-pointer flex items-center gap-2 group">
                    <i class="fas fa-message text-[var(--text-secondary)] text-sm"></i>
                    <span class="text-sm truncate flex-1">${chat.title}</span>
                    <button onclick="event.stopPropagation(); deleteChat('${chat.id}')" class="opacity-0 group-hover:opacity-100 text-[var(--text-secondary)] hover:text-red-400">
                        <i class="fas fa-trash text-xs"></i>
                    </button>
                </div>
            `).join('');
        }

        function newChat() {
            state.currentChatId = Date.now().toString();
            state.messages = [];
            document.getElementById('welcomeScreen').classList.remove('hidden');
            document.getElementById('messagesContainer').classList.add('hidden');
            document.getElementById('messagesContainer').innerHTML = '';
            document.getElementById('userInput').value = '';
        }

        function loadChat(chatId) {
            const chat = state.chatHistory.find(c => c.id === chatId);
            if (chat) {
                state.currentChatId = chatId;
                state.messages = chat.messages;
                renderMessages();
            }
        }

        function deleteChat(chatId) {
            state.chatHistory = state.chatHistory.filter(c => c.id !== chatId);
            saveChatHistory();
            renderChatHistory();
            if (state.currentChatId === chatId) {
                newChat();
            }
        }

        function renderMessages() {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';
            document.getElementById('welcomeScreen').classList.add('hidden');
            container.classList.remove('hidden');
            
            state.messages.forEach(msg => {
                if (msg.role === 'user') {
                    appendUserMessage(msg.content);
                } else {
                    appendAssistantMessage(msg.content, msg.experts);
                }
            });
        }

        // ==========================================
        // Message Handling
        // ==========================================
        function appendUserMessage(content) {
            const container = document.getElementById('messagesContainer');
            const div = document.createElement('div');
            div.className = 'flex justify-end';
            div.innerHTML = `
                <div class="message-user px-4 py-3 rounded-2xl max-w-2xl">
                    <p class="text-white whitespace-pre-wrap">${escapeHtml(content)}</p>
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function createExpertGrid(experts) {
            const showExperts = localStorage.getItem('sahu_show_experts') !== 'false';
            if (!showExperts) return '';
            
            return `
                <div class="mb-4">
                    <div class="flex items-center gap-2 mb-3">
                        <i class="fas fa-users text-[var(--accent)]"></i>
                        <span class="font-medium">Expert Responses</span>
                        <button onclick="this.parentElement.nextElementSibling.classList.toggle('hidden')" class="text-xs text-[var(--text-secondary)] hover:text-[var(--text-primary)]">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        ${experts.map(exp => `
                            <div class="expert-card ${exp.status} rounded-xl p-3">
                                <div class="flex items-center gap-2 mb-2">
                                    <div class="w-6 h-6 rounded-full bg-[var(--accent)] flex items-center justify-center text-white text-xs">
                                        ${exp.name.charAt(0)}
                                    </div>
                                    <span class="font-medium text-sm">${exp.name}</span>
                                    ${exp.tools ? `<span class="text-xs bg-[var(--accent)]/20 text-[var(--accent)] px-2 py-0.5 rounded-full">${exp.tools.join(', ')}</span>` : ''}
                                    ${exp.status === 'thinking' ? `
                                        <div class="typing-indicator ml-auto flex gap-1">
                                            <span class="w-1.5 h-1.5 bg-[var(--accent)] rounded-full"></span>
                                            <span class="w-1.5 h-1.5 bg-[var(--accent)] rounded-full"></span>
                                            <span class="w-1.5 h-1.5 bg-[var(--accent)] rounded-full"></span>
                                        </div>
                                    ` : ''}
                                    ${exp.status === 'complete' ? '<i class="fas fa-check-circle text-green-400 ml-auto"></i>' : ''}
                                    ${exp.status === 'error' ? '<i class="fas fa-exclamation-circle text-red-400 ml-auto"></i>' : ''}
                                </div>
                                <div class="text-sm text-[var(--text-secondary)] max-h-32 overflow-y-auto scrollbar-thin">
                                    ${exp.response ? formatMarkdown(exp.response) : '<span class="italic">Processing...</span>'}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function createToolLog(tool, content) {
            return `
                <div class="tool-log rounded-lg p-3 my-2">
                    <div class="flex items-center gap-2 mb-1">
                        <i class="fas fa-${tool === 'thinking' ? 'brain' : tool === 'searching' ? 'search' : 'list-check'} text-[var(--accent)]"></i>
                        <span class="text-sm font-medium capitalize">${tool}</span>
                        <button onclick="this.parentElement.nextElementSibling.classList.toggle('hidden')" class="text-xs text-[var(--text-secondary)]">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                    <div class="text-xs text-[var(--text-secondary)] hidden">
                        ${escapeHtml(content)}
                    </div>
                </div>
            `;
        }

        function appendAssistantMessage(content, experts = [], toolLogs = []) {
            const container = document.getElementById('messagesContainer');
            const div = document.createElement('div');
            div.className = 'assistant-response';
            div.innerHTML = `
                ${experts.length > 0 ? createExpertGrid(experts) : ''}
                ${toolLogs.map(log => createToolLog(log.tool, log.content)).join('')}
                <div class="aggregator-response rounded-2xl p-4">
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                            <i class="fas fa-brain text-white text-sm"></i>
                        </div>
                        <span class="font-medium">SAHU 1 MoE</span>
                        <span class="text-xs text-[var(--text-secondary)]">Synthesized Response</span>
                    </div>
                    <div class="prose prose-invert max-w-none">
                        ${formatMarkdown(content)}
                    </div>
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function formatMarkdown(text) {
            if (!text) return '';
            
            // Code blocks
            text = text.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code class="language-$1">$2</code></pre>');
            
            // Inline code
            text = text.replace(/`([^`]+)`/g, '<code class="bg-[var(--bg-tertiary)] px-1 rounded">$1</code>');
            
            // Bold
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            
            // Italic
            text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
            
            // Links
            text = text.replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2" class="text-[var(--accent)] hover:underline" target="_blank">$1</a>');
            
            // Lists
            text = text.replace(/^\s*[-*]\s+(.+)$/gm, '<li>$1</li>');
            text = text.replace(/(<li>.*<\/li>\n?)+/g, '<ul class="list-disc pl-5 my-2">$&</ul>');
            
            // Paragraphs
            text = text.replace(/\n\n/g, '</p><p class="my-2">');
            text = '<p class="my-2">' + text + '</p>';
            
            return text;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==========================================
        // API Communication
        // ==========================================
        async function callModel(modelId, messages, tools = [], stream = false, onChunk = null) {
            const provider = PROVIDERS[state.currentProvider];
            const apiKey = localStorage.getItem(provider.keyName);
            const endpoint = localStorage.getItem(provider.endpointName) || provider.defaultEndpoint;
            
            if (!apiKey && state.currentProvider !== 'ollama') {
                throw new Error(`API key not configured for ${provider.name}`);
            }
            
            const fullModelId = MODELS[modelId] || modelId;
            
            let requestBody, requestUrl, headers;
            
            switch (state.currentProvider) {
                case 'huggingface':
                    requestUrl = endpoint;
                    headers = {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    };
                    requestBody = {
                        model: fullModelId,
                        messages: messages,
                        max_tokens: parseInt(localStorage.getItem('sahu_max_tokens')) || 4096,
                        temperature: parseFloat(localStorage.getItem('sahu_temperature')) || 0.7,
                        stream: stream
                    };
                    break;
                    
                case 'openrouter':
                case 'groq':
                case 'togetherai':
                    requestUrl = endpoint;
                    headers = {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    };
                    if (state.currentProvider === 'openrouter') {
                        headers['HTTP-Referer'] = window.location.origin;
                        headers['X-Title'] = 'SAHU 1 MoE';
                    }
                    requestBody = {
                        model: fullModelId,
                        messages: messages,
                        max_tokens: parseInt(localStorage.getItem('sahu_max_tokens')) || 4096,
                        temperature: parseFloat(localStorage.getItem('sahu_temperature')) || 0.7,
                        stream: stream
                    };
                    break;
                    
                case 'ollama':
                    requestUrl = endpoint;
                    headers = { 'Content-Type': 'application/json' };
                    requestBody = {
                        model: modelId.toLowerCase(),
                        messages: messages,
                        stream: stream
                    };
                    break;
            }
            
            try {
                const response = await fetch(requestUrl, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }
                
                // Handle streaming response
                if (stream && onChunk) {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let fullContent = '';
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                if (data === '[DONE]') continue;
                                
                                try {
                                    const parsed = JSON.parse(data);
                                    const content = parsed.choices?.[0]?.delta?.content || '';
                                    if (content) {
                                        fullContent += content;
                                        onChunk(content, fullContent);
                                    }
                                } catch (e) {
                                    // Skip malformed JSON
                                }
                            }
                        }
                    }
                    
                    return fullContent;
                }
                
                const data = await response.json();
                
                // Extract response based on provider
                switch (state.currentProvider) {
                    case 'huggingface':
                    case 'openrouter':
                    case 'groq':
                    case 'togetherai':
                        return data.choices?.[0]?.message?.content || JSON.stringify(data);
                    case 'ollama':
                        return data.message?.content || data.response || JSON.stringify(data);
                    default:
                        return JSON.stringify(data);
                }
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // ==========================================
        // Tool Execution
        // ==========================================
        async function executeThinking(prompt) {
            return {
                tool: 'thinking',
                content: `Analyzing: "${prompt.substring(0, 100)}..."\nBreaking down into sub-problems...\nConsidering multiple perspectives...`
            };
        }

        async function executeSearching(prompt) {
            return {
                tool: 'searching',
                content: `Searching for: "${prompt.substring(0, 50)}..."\nGathering relevant sources...\nSynthesizing information...`
            };
        }

        async function executePlanning(prompt) {
            return {
                tool: 'planning',
                content: `Creating plan for: "${prompt.substring(0, 50)}..."\nStep 1: Analyze requirements\nStep 2: Design solution\nStep 3: Implement\nStep 4: Validate`
            };
        }

        // ==========================================
        // Main Send Message
        // ==========================================
        async function sendMessage() {
            const input = document.getElementById('userInput');
            const content = input.value.trim();
            
            if (!content || state.isProcessing) return;
            
            state.isProcessing = true;
            document.getElementById('sendBtn').disabled = true;
            
            // Show messages container
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('messagesContainer').classList.remove('hidden');
            
            // Add user message
            appendUserMessage(content);
            state.messages.push({ role: 'user', content });
            input.value = '';
            input.style.height = 'auto';
            
            // Clear attachments
            state.attachments = [];
            document.getElementById('attachmentPreview').classList.add('hidden');
            
            try {
                // Determine which MoE to use
                let moeKey = state.currentMoE;
                if (moeKey === 'agent') {
                    moeKey = classifyTask(content);
                    showNotification(`Agent routed to: ${MOE_CONFIGS[moeKey].name}`, 'success');
                }
                
                const config = MOE_CONFIGS[moeKey];
                
                // Execute tools
                const toolLogs = [];
                for (const tool of config.tools) {
                    let result;
                    switch (tool) {
                        case 'thinking':
                            result = await executeThinking(content);
                            break;
                        case 'searching':
                            result = await executeSearching(content);
                            break;
                        case 'planning':
                            result = await executePlanning(content);
                            break;
                    }
                    if (result) toolLogs.push(result);
                }
                
                // Query all experts
                const expertResults = [];
                const container = document.getElementById('messagesContainer');
                
                // Create placeholder for expert grid
                const expertPlaceholder = document.createElement('div');
                expertPlaceholder.id = 'expertPlaceholder';
                container.appendChild(expertPlaceholder);
                
                // Initialize all experts with thinking status
                config.experts.forEach(expert => {
                    expertResults.push({
                        name: expert.name,
                        id: expert.id,
                        tools: expert.tools || [],
                        status: 'thinking',
                        response: null
                    });
                });
                updateExpertGrid(expertResults);
                
                // Process experts in parallel
                const expertPromises = config.experts.map(async (expert, index) => {
                    try {
                        const response = await callModel(expert.id, [
                            { role: 'system', content: `You are ${expert.name}, an expert AI assistant. Provide a focused, helpful response.` },
                            { role: 'user', content: content }
                        ], expert.tools);
                        
                        expertResults[index].response = response;
                        expertResults[index].status = 'complete';
                    } catch (error) {
                        expertResults[index].response = `Error: ${error.message}`;
                        expertResults[index].status = 'error';
                    }
                    
                    updateExpertGrid(expertResults);
                    return expertResults[index];
                });
                
                // Wait for ALL experts to complete before starting aggregation
                await Promise.allSettled(expertPromises);
                
                // All experts complete - now show aggregator section
                const successfulExperts = expertResults.filter(e => e.status === 'complete');
                const completedCount = successfulExperts.length;
                const totalCount = expertResults.length;
                
                // Create aggregator response container with phases
                const aggregatorDiv = document.createElement('div');
                aggregatorDiv.className = 'aggregator-response rounded-2xl p-4 mt-4';
                aggregatorDiv.innerHTML = `
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                            <i class="fas fa-brain text-white text-sm"></i>
                        </div>
                        <span class="font-medium">SAHU 1 MoE Aggregator</span>
                        <span class="text-xs text-[var(--text-secondary)]">(${config.aggregator})</span>
                    </div>
                    
                    <!-- Phase 1: Reading -->
                    <div id="aggregatorPhase1" class="mb-3 p-3 bg-[var(--bg-secondary)] rounded-lg">
                        <div class="flex items-center gap-2 text-blue-400">
                            <i class="fas fa-book-reader"></i>
                            <span class="font-medium text-sm">Reading ${completedCount}/${totalCount} expert responses...</span>
                            <div class="typing-indicator ml-2 flex gap-1">
                                <span class="w-1.5 h-1.5 bg-blue-400 rounded-full"></span>
                                <span class="w-1.5 h-1.5 bg-blue-400 rounded-full"></span>
                                <span class="w-1.5 h-1.5 bg-blue-400 rounded-full"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Phase 2: Thinking (hidden initially) -->
                    <div id="aggregatorPhase2" class="mb-3 p-3 bg-[var(--bg-secondary)] rounded-lg hidden">
                        <div class="flex items-center gap-2 text-yellow-400">
                            <i class="fas fa-lightbulb"></i>
                            <span class="font-medium text-sm">Thinking & analyzing...</span>
                            <div class="typing-indicator ml-2 flex gap-1">
                                <span class="w-1.5 h-1.5 bg-yellow-400 rounded-full"></span>
                                <span class="w-1.5 h-1.5 bg-yellow-400 rounded-full"></span>
                                <span class="w-1.5 h-1.5 bg-yellow-400 rounded-full"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Phase 3: Synthesizing (hidden initially) -->
                    <div id="aggregatorPhase3" class="mb-3 p-3 bg-[var(--bg-secondary)] rounded-lg hidden">
                        <div class="flex items-center gap-2 text-purple-400">
                            <i class="fas fa-project-diagram"></i>
                            <span class="font-medium text-sm">Synthesizing final answer...</span>
                            <div class="typing-indicator ml-2 flex gap-1">
                                <span class="w-1.5 h-1.5 bg-purple-400 rounded-full"></span>
                                <span class="w-1.5 h-1.5 bg-purple-400 rounded-full"></span>
                                <span class="w-1.5 h-1.5 bg-purple-400 rounded-full"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Final Response -->
                    <div id="aggregatorFinalResponse" class="prose prose-invert max-w-none hidden">
                        <div class="flex items-center gap-2 mb-2 text-green-400">
                            <i class="fas fa-check-circle"></i>
                            <span class="font-medium text-sm">Final Synthesized Response</span>
                        </div>
                        <div id="streamingContent" class="text-[var(--text-primary)]"></div>
                    </div>
                `;
                container.appendChild(aggregatorDiv);
                container.scrollTop = container.scrollHeight;
                
                // Animate through phases
                await sleep(800); // Reading phase
                document.getElementById('aggregatorPhase1').innerHTML = `
                    <div class="flex items-center gap-2 text-blue-400">
                        <i class="fas fa-check-circle"></i>
                        <span class="font-medium text-sm">Read ${completedCount} expert responses</span>
                    </div>
                `;
                document.getElementById('aggregatorPhase2').classList.remove('hidden');
                container.scrollTop = container.scrollHeight;
                
                await sleep(600); // Thinking phase
                document.getElementById('aggregatorPhase2').innerHTML = `
                    <div class="flex items-center gap-2 text-yellow-400">
                        <i class="fas fa-check-circle"></i>
                        <span class="font-medium text-sm">Analysis complete</span>
                    </div>
                `;
                document.getElementById('aggregatorPhase3').classList.remove('hidden');
                container.scrollTop = container.scrollHeight;
                
                await sleep(400); // Starting synthesis
                document.getElementById('aggregatorPhase3').innerHTML = `
                    <div class="flex items-center gap-2 text-purple-400">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span class="font-medium text-sm">Generating response...</span>
                    </div>
                `;
                document.getElementById('aggregatorFinalResponse').classList.remove('hidden');
                container.scrollTop = container.scrollHeight;
                
                // Build aggregator prompt
                const aggregatorPrompt = `You are the SAHU 1 MoE aggregator. Multiple AI experts have provided their responses to the user's query.

User Query: ${content}

Expert Responses:
${expertResults.map(exp => `### ${exp.name}:\n${exp.response || 'No response'}`).join('\n\n')}

Your task: 
1. Carefully read and understand all expert responses
2. Analyze the key insights, agreements, and differences between experts
3. Synthesize these expert responses into a comprehensive, well-structured final answer
4. Combine the best insights from each expert
5. Resolve any contradictions
6. Provide a clear, actionable response

Begin your synthesis now:`;

                let aggregatedResponse = '';
                const streamingDiv = document.getElementById('streamingContent');
                const shouldStream = localStorage.getItem('sahu_stream') !== 'false';
                
                try {
                    if (shouldStream) {
                        // Stream the aggregator response word by word
                        aggregatedResponse = await callModel(
                            config.aggregator, 
                            [
                                { role: 'system', content: 'You are the SAHU 1 MoE aggregator. Synthesize multiple expert responses into a coherent, comprehensive answer. Think step by step, analyze carefully, then provide your final synthesis.' },
                                { role: 'user', content: aggregatorPrompt }
                            ], 
                            config.aggregatorTools || [],
                            true, // streaming enabled
                            (chunk, fullText) => {
                                // Update streaming content
                                streamingDiv.innerHTML = formatMarkdown(fullText);
                                container.scrollTop = container.scrollHeight;
                            }
                        );
                    } else {
                        // Non-streaming fallback
                        aggregatedResponse = await callModel(config.aggregator, [
                            { role: 'system', content: 'You are the SAHU 1 MoE aggregator. Synthesize multiple expert responses into a coherent, comprehensive answer.' },
                            { role: 'user', content: aggregatorPrompt }
                        ], config.aggregatorTools || []);
                        
                        // Simulate word by word display
                        const words = aggregatedResponse.split(' ');
                        let displayedText = '';
                        for (let i = 0; i < words.length; i++) {
                            displayedText += (i > 0 ? ' ' : '') + words[i];
                            streamingDiv.innerHTML = formatMarkdown(displayedText);
                            container.scrollTop = container.scrollHeight;
                            await sleep(30); // 30ms per word
                        }
                    }
                } catch (error) {
                    // Fallback: use best expert response
                    if (successfulExperts.length > 0) {
                        aggregatedResponse = `**Synthesized from ${successfulExperts.length} experts:**\n\n${successfulExperts[0].response}`;
                    } else {
                        aggregatedResponse = 'Unable to generate a response. Please check your API configuration and try again.';
                    }
                    streamingDiv.innerHTML = formatMarkdown(aggregatedResponse);
                }
                
                // Update phase 3 to complete
                document.getElementById('aggregatorPhase3').innerHTML = `
                    <div class="flex items-center gap-2 text-green-400">
                        <i class="fas fa-check-circle"></i>
                        <span class="font-medium text-sm">Synthesis complete</span>
                    </div>
                `;
                
                // Remove cursor from streaming content
                streamingDiv.classList.add('complete');
                
                // Remove expert placeholder
                expertPlaceholder.remove();
                
                // Re-add expert grid before aggregator
                const expertGridDiv = document.createElement('div');
                expertGridDiv.innerHTML = createExpertGrid(expertResults);
                aggregatorDiv.parentNode.insertBefore(expertGridDiv, aggregatorDiv);
                
                // Add tool logs
                toolLogs.forEach(log => {
                    const logDiv = document.createElement('div');
                    logDiv.innerHTML = createToolLog(log.tool, log.content);
                    expertGridDiv.insertBefore(logDiv, expertGridDiv.firstChild);
                });
                
                // Save to history
                state.messages.push({ 
                    role: 'assistant', 
                    content: aggregatedResponse,
                    experts: expertResults
                });
                
                // Update chat history
                if (!state.currentChatId) {
                    state.currentChatId = Date.now().toString();
                }
                
                const existingChat = state.chatHistory.find(c => c.id === state.currentChatId);
                if (existingChat) {
                    existingChat.messages = state.messages;
                } else {
                    state.chatHistory.unshift({
                        id: state.currentChatId,
                        title: content.substring(0, 30) + '...',
                        messages: state.messages,
                        timestamp: Date.now()
                    });
                }
                saveChatHistory();
                renderChatHistory();
                
            } catch (error) {
                console.error('Error processing message:', error);
                appendAssistantMessage(`**Error:** ${error.message}\n\nPlease check your API configuration in Settings.`);
            } finally {
                state.isProcessing = false;
                document.getElementById('sendBtn').disabled = false;
            }
        }
        
        // Helper function for delays
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function updateExpertGrid(experts) {
            const placeholder = document.getElementById('expertPlaceholder');
            if (placeholder) {
                placeholder.innerHTML = createExpertGrid(experts);
            }
        }

        // Close provider menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('providerMenu');
            const button = e.target.closest('[onclick="toggleProviderMenu()"]');
            if (!button && !menu.contains(e.target)) {
                menu.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
