<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAHU 1 MoE - Mixture of Experts</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        
        /* Dark theme variables */
        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #a1a1a1;
            --accent: #7c3aed;
            --accent-hover: #8b5cf6;
            --border: #333333;
        }
        
        .light-theme {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e5e5e5;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --border: #d1d5db;
        }
        
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        .sidebar { background: var(--bg-secondary); border-color: var(--border); }
        .chat-area { background: var(--bg-primary); }
        .input-area { background: var(--bg-secondary); border-color: var(--border); }
        .expert-card { background: var(--bg-tertiary); border-color: var(--border); }
        .message-user { background: var(--accent); }
        .message-assistant { background: var(--bg-tertiary); }
        
        /* Typing animation */
        @keyframes blink { 50% { opacity: 0; } }
        .typing-cursor { animation: blink 1s infinite; }
        
        /* Expert card grid */
        .expert-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 12px;
        }
        
        /* Streaming text effect */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .stream-token { animation: fadeIn 0.1s ease-in; }
        
        /* Tool badge animations */
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .tool-active { animation: pulse 1.5s infinite; }
        
        /* Bounce animation for loading dots */
        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-6px); }
        }
        .animate-bounce { animation: bounce 1s infinite; }
        
        /* Thinking animation */
        @keyframes thinking-pulse {
            0%, 100% { opacity: 0.4; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }
        .thinking-active { animation: thinking-pulse 2s infinite ease-in-out; }
        
        /* Word appear animation */
        @keyframes wordAppear {
            from { opacity: 0; transform: translateY(2px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .word-animate { animation: wordAppear 0.1s ease-out; }
        
        /* Modal backdrop */
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }
        
        /* Code blocks */
        pre { background: #1e1e1e !important; border-radius: 8px; padding: 12px; overflow-x: auto; }
        code { font-family: 'Fira Code', monospace; font-size: 13px; }
        
        /* Hide scrollbar for sidebar */
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        /* Gradient text for logo */
        .gradient-text {
            background: linear-gradient(135deg, #7c3aed, #a855f7, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Provider badges */
        .badge-hf { background: #ff9d00; color: #000; }
        .badge-openrouter { background: #6366f1; }
        .badge-groq { background: #f97316; }
        .badge-together { background: #3b82f6; }
        .badge-ollama { background: #22c55e; }
        
        /* Smooth transitions */
        * { transition: background-color 0.2s, border-color 0.2s, color 0.2s; }
        
        /* Final answer highlight */
        .final-answer {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(168, 85, 247, 0.1));
            border: 1px solid rgba(124, 58, 237, 0.3);
        }
        
        /* Markdown rendering */
        .markdown-content h1 { font-size: 1.5rem; font-weight: 700; margin: 1rem 0 0.5rem; }
        .markdown-content h2 { font-size: 1.25rem; font-weight: 600; margin: 0.875rem 0 0.5rem; }
        .markdown-content h3 { font-size: 1.1rem; font-weight: 600; margin: 0.75rem 0 0.5rem; }
        .markdown-content p { margin: 0.5rem 0; line-height: 1.6; }
        .markdown-content ul, .markdown-content ol { margin: 0.5rem 0; padding-left: 1.5rem; }
        .markdown-content li { margin: 0.25rem 0; }
        .markdown-content code:not(pre code) { 
            background: rgba(124, 58, 237, 0.2); 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-size: 0.9em;
        }
        .markdown-content blockquote {
            border-left: 3px solid var(--accent);
            padding-left: 1rem;
            margin: 0.5rem 0;
            opacity: 0.8;
        }
    </style>
</head>
<body class="min-h-screen flex overflow-hidden">
    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar w-64 h-screen flex flex-col border-r fixed lg:relative z-40 transform -translate-x-full lg:translate-x-0 transition-transform">
        <!-- Logo -->
        <div class="p-4 border-b border-[var(--border)]">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-600 to-pink-500 flex items-center justify-center">
                    <i class="fas fa-brain text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg gradient-text">SAHU 1</h1>
                    <p class="text-xs text-[var(--text-secondary)]">Mixture of Experts</p>
                </div>
            </div>
        </div>
        
        <!-- New Chat Button -->
        <div class="p-3">
            <button onclick="startNewChat()" class="w-full py-2.5 px-4 rounded-lg border border-[var(--border)] hover:bg-[var(--bg-tertiary)] flex items-center gap-2 transition-colors">
                <i class="fas fa-plus"></i>
                <span>New Chat</span>
            </button>
        </div>
        
        <!-- Model Selector -->
        <div class="px-3 pb-3">
            <label class="text-xs text-[var(--text-secondary)] mb-1 block">MoE Mode</label>
            <select id="moeSelector" onchange="changeMoEMode()" class="w-full p-2.5 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] text-sm focus:outline-none focus:ring-2 focus:ring-purple-500">
                <option value="deepthink">ðŸ§  Sahu 1 DeepThink</option>
                <option value="research">ðŸ”¬ Sahu 1 Deep Research</option>
                <option value="code">ðŸ’» Sahu 1 Code</option>
                <option value="fast">âš¡ Sahu 1 Fast</option>
                <option value="chat" selected>ðŸ’¬ Sahu 1 Chat</option>
                <option value="agent">ðŸ¤– Sahu 1 Agent</option>
            </select>
        </div>
        
        <!-- Chat History -->
        <div class="flex-1 overflow-y-auto hide-scrollbar px-3">
            <p class="text-xs text-[var(--text-secondary)] mb-2">Recent Chats</p>
            <div id="chatHistory" class="space-y-1">
                <!-- Chat history items will be inserted here -->
            </div>
        </div>
        
        <!-- Settings Button -->
        <div class="p-3 border-t border-[var(--border)]">
            <button onclick="openSettings()" class="w-full py-2.5 px-4 rounded-lg hover:bg-[var(--bg-tertiary)] flex items-center gap-2 transition-colors">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </button>
        </div>
    </aside>
    
    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen lg:ml-0">
        <!-- Top Bar -->
        <header class="h-14 border-b border-[var(--border)] flex items-center justify-between px-4 bg-[var(--bg-secondary)]">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="lg:hidden p-2 rounded-lg hover:bg-[var(--bg-tertiary)]">
                    <i class="fas fa-bars"></i>
                </button>
                <div id="currentModeDisplay" class="flex items-center gap-2">
                    <span class="text-lg">ðŸ’¬</span>
                    <span class="font-medium">Sahu 1 Chat</span>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <!-- Provider Selector -->
                <select id="providerSelector" onchange="changeProvider()" class="px-3 py-1.5 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] text-sm focus:outline-none">
                    <option value="huggingface">HuggingFace</option>
                    <option value="openrouter">OpenRouter</option>
                    <option value="groq">Groq</option>
                    <option value="together">TogetherAI</option>
                    <option value="ollama">Ollama</option>
                </select>
                
                <!-- Theme Toggle -->
                <button onclick="toggleTheme()" class="p-2 rounded-lg hover:bg-[var(--bg-tertiary)]">
                    <i id="themeIcon" class="fas fa-moon"></i>
                </button>
            </div>
        </header>
        
        <!-- Chat Area -->
        <div id="chatArea" class="flex-1 overflow-y-auto p-4 chat-area">
            <!-- Welcome Screen -->
            <div id="welcomeScreen" class="h-full flex flex-col items-center justify-center text-center px-4">
                <div class="w-20 h-20 rounded-2xl bg-gradient-to-br from-purple-600 to-pink-500 flex items-center justify-center mb-6">
                    <i class="fas fa-brain text-white text-3xl"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2">Welcome to SAHU 1 MoE</h2>
                <p class="text-[var(--text-secondary)] max-w-md mb-8">
                    A powerful Mixture-of-Experts system that combines multiple AI models for superior responses.
                </p>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-3 max-w-2xl">
                    <button onclick="selectMode('deepthink')" class="p-4 rounded-xl bg-[var(--bg-tertiary)] hover:bg-[var(--border)] transition-colors text-left">
                        <span class="text-2xl mb-2 block">ðŸ§ </span>
                        <span class="font-medium block">DeepThink</span>
                        <span class="text-xs text-[var(--text-secondary)]">Extended reasoning</span>
                    </button>
                    <button onclick="selectMode('research')" class="p-4 rounded-xl bg-[var(--bg-tertiary)] hover:bg-[var(--border)] transition-colors text-left">
                        <span class="text-2xl mb-2 block">ðŸ”¬</span>
                        <span class="font-medium block">Deep Research</span>
                        <span class="text-xs text-[var(--text-secondary)]">Research-heavy</span>
                    </button>
                    <button onclick="selectMode('code')" class="p-4 rounded-xl bg-[var(--bg-tertiary)] hover:bg-[var(--border)] transition-colors text-left">
                        <span class="text-2xl mb-2 block">ðŸ’»</span>
                        <span class="font-medium block">Code</span>
                        <span class="text-xs text-[var(--text-secondary)]">Plan â†’ Code</span>
                    </button>
                    <button onclick="selectMode('fast')" class="p-4 rounded-xl bg-[var(--bg-tertiary)] hover:bg-[var(--border)] transition-colors text-left">
                        <span class="text-2xl mb-2 block">âš¡</span>
                        <span class="font-medium block">Fast</span>
                        <span class="text-xs text-[var(--text-secondary)]">Quick responses</span>
                    </button>
                    <button onclick="selectMode('chat')" class="p-4 rounded-xl bg-[var(--bg-tertiary)] hover:bg-[var(--border)] transition-colors text-left">
                        <span class="text-2xl mb-2 block">ðŸ’¬</span>
                        <span class="font-medium block">Chat</span>
                        <span class="text-xs text-[var(--text-secondary)]">General chat</span>
                    </button>
                    <button onclick="selectMode('agent')" class="p-4 rounded-xl bg-[var(--bg-tertiary)] hover:bg-[var(--border)] transition-colors text-left">
                        <span class="text-2xl mb-2 block">ðŸ¤–</span>
                        <span class="font-medium block">Agent</span>
                        <span class="text-xs text-[var(--text-secondary)]">Auto-routing</span>
                    </button>
                </div>
            </div>
            
            <!-- Messages Container -->
            <div id="messagesContainer" class="max-w-5xl mx-auto space-y-6 hidden">
                <!-- Messages will be inserted here -->
            </div>
        </div>
        
        <!-- Input Area -->
        <div class="p-4 border-t border-[var(--border)] bg-[var(--bg-secondary)]">
            <div class="max-w-4xl mx-auto">
                <!-- Tools Indicator -->
                <div id="toolsIndicator" class="mb-2 flex gap-2 hidden">
                    <!-- Active tools will show here -->
                </div>
                
                <div class="flex items-end gap-2">
                    <!-- File Upload Button -->
                    <button onclick="document.getElementById('fileInput').click()" class="p-3 rounded-xl bg-[var(--bg-tertiary)] hover:bg-[var(--border)] transition-colors">
                        <i class="fas fa-plus"></i>
                    </button>
                    <input type="file" id="fileInput" class="hidden" onchange="handleFileUpload(event)" accept="image/*,.pdf,.txt,.md,.json,.csv">
                    
                    <!-- Text Input -->
                    <div class="flex-1 relative">
                        <textarea 
                            id="userInput" 
                            placeholder="Message SAHU 1..." 
                            class="w-full p-3 pr-12 rounded-xl bg-[var(--bg-tertiary)] border border-[var(--border)] resize-none focus:outline-none focus:ring-2 focus:ring-purple-500 min-h-[48px] max-h-[200px]"
                            rows="1"
                            onkeydown="handleKeyDown(event)"
                            oninput="autoResize(this)"
                        ></textarea>
                        
                        <!-- Send Button -->
                        <button 
                            id="sendButton"
                            onclick="sendMessage()" 
                            class="absolute right-2 bottom-2 p-2 rounded-lg bg-purple-600 hover:bg-purple-700 text-white transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <i class="fas fa-arrow-up"></i>
                        </button>
                    </div>
                    
                    <!-- Stop Button (hidden by default) -->
                    <button id="stopButton" onclick="stopGeneration()" class="p-3 rounded-xl bg-red-600 hover:bg-red-700 text-white transition-colors hidden">
                        <i class="fas fa-stop"></i>
                    </button>
                </div>
                
                <p class="text-xs text-[var(--text-secondary)] text-center mt-2">
                    SAHU 1 MoE by Saksham Intelligence Â· All responses from open-source models
                </p>
            </div>
        </div>
    </main>
    
    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeSettings()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-lg bg-[var(--bg-secondary)] rounded-2xl shadow-2xl border border-[var(--border)] max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold">Settings</h2>
                    <button onclick="closeSettings()" class="p-2 rounded-lg hover:bg-[var(--bg-tertiary)]">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- API Keys Section -->
                <div class="space-y-4">
                    <h3 class="font-semibold text-sm text-[var(--text-secondary)] uppercase tracking-wider">API Keys</h3>
                    
                    <!-- HuggingFace -->
                    <div>
                        <label class="block text-sm mb-1">HuggingFace API Key</label>
                        <input type="password" id="hfApiKey" placeholder="hf_..." class="w-full p-2.5 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    
                    <!-- OpenRouter -->
                    <div>
                        <label class="block text-sm mb-1">OpenRouter API Key</label>
                        <input type="password" id="orApiKey" placeholder="sk-or-..." class="w-full p-2.5 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    
                    <!-- Groq -->
                    <div>
                        <label class="block text-sm mb-1">Groq API Key</label>
                        <input type="password" id="groqApiKey" placeholder="gsk_..." class="w-full p-2.5 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    
                    <!-- TogetherAI -->
                    <div>
                        <label class="block text-sm mb-1">TogetherAI API Key</label>
                        <input type="password" id="togetherApiKey" placeholder="..." class="w-full p-2.5 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    
                    <!-- Ollama -->
                    <div>
                        <label class="block text-sm mb-1">Ollama Endpoint</label>
                        <input type="text" id="ollamaEndpoint" placeholder="http://localhost:11434" class="w-full p-2.5 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>
                
                <!-- Advanced Settings -->
                <div class="mt-6 space-y-4">
                    <h3 class="font-semibold text-sm text-[var(--text-secondary)] uppercase tracking-wider">Advanced</h3>
                    
                    <div class="flex items-center justify-between">
                        <span>Show expert outputs</span>
                        <input type="checkbox" id="showExperts" checked class="w-5 h-5 accent-purple-600">
                    </div>
                    
                    <div class="flex items-center justify-between">
                        <span>Enable streaming</span>
                        <input type="checkbox" id="enableStreaming" checked class="w-5 h-5 accent-purple-600">
                    </div>
                    
                    <div>
                        <label class="block text-sm mb-1">Max tokens</label>
                        <input type="number" id="maxTokens" value="4096" class="w-full p-2.5 rounded-lg bg-[var(--bg-tertiary)] border border-[var(--border)] focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm mb-1">Temperature</label>
                        <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.7" class="w-full accent-purple-600">
                        <span id="tempValue" class="text-sm text-[var(--text-secondary)]">0.7</span>
                    </div>
                </div>
                
                <!-- Save Button -->
                <button onclick="saveSettings()" class="w-full mt-6 py-3 rounded-xl bg-purple-600 hover:bg-purple-700 text-white font-medium transition-colors">
                    Save Settings
                </button>
            </div>
        </div>
    </div>
    
    <!-- Overlay for mobile sidebar -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-30 hidden lg:hidden" onclick="toggleSidebar()"></div>

    <script>
        // ==========================================
        // SAHU 1 MoE - Configuration & State
        // ==========================================
        
        // Global State
        const state = {
            currentMode: 'chat',
            currentProvider: 'huggingface',
            isGenerating: false,
            abortController: null,
            chatHistory: [],
            currentChatId: null,
            theme: 'dark',
            uploadedFiles: [],
            toolBuffer: []
        };
        
        // MoE Mode Configurations
        const MOE_CONFIGS = {
            deepthink: {
                name: 'Sahu 1 DeepThink',
                icon: 'ðŸ§ ',
                tools: ['thinking'],
                behavior: 'Extended reasoning with deep analysis',
                experts: [
                    { id: 'deepseek-r1', name: 'DeepSeek-R1', model: 'deepseek-ai/DeepSeek-R1' },
                    { id: 'gpt-oss-120b', name: 'GPT-OSS-120B', model: 'openai/gpt-oss-120b' },
                    { id: 'deepseek-v3.2', name: 'DeepSeek-V3.2', model: 'deepseek-ai/DeepSeek-V3.2' },
                    { id: 'kimi-k2-think', name: 'Kimi-K2-Thinking', model: 'moonshotai/Kimi-K2-Thinking' },
                    { id: 'qwen3-235b', name: 'Qwen3-235B-Thinking', model: 'Qwen/Qwen3-235B-A22B-Thinking-2507-FP8' },
                    { id: 'glm-4.7', name: 'GLM-4.7', model: 'zai-org/GLM-4.7' },
                    { id: 'ministral-reasoning', name: 'Ministral-Reasoning', model: 'mistralai/Ministral-3-14B-Reasoning-2512' },
                    { id: 'phi4-reasoning', name: 'Phi-4-Reasoning+', model: 'microsoft/Phi-4-reasoning-plus' },
                    { id: 'gemma-3n', name: 'Gemma-3n-E4B', model: 'google/gemma-3n-E4B-it' },
                    { id: 'minimax-m2.1', name: 'MiniMax M2.1', model: 'minimax/m2.1-preview' }
                ],
                aggregator: { name: 'GLM-4.7', model: 'zai-org/GLM-4.7' }
            },
            research: {
                name: 'Sahu 1 Deep Research',
                icon: 'ðŸ”¬',
                tools: ['searching'],
                behavior: 'Research-heavy with web searching capabilities',
                experts: [
                    { id: 'gpt-oss-20b', name: 'GPT-OSS-120B', model: 'openai/gpt-oss-120b' tools: ['searching'] },
                    { id: 'deepseek-v3.2-search', name: 'DeepSeek-V3.2', model: 'deepseek-ai/DeepSeek-V3.2', tools: ['searching'] },
                    { id: 'kimi-k2-search', name: 'Kimi-K2-Thinking', model: 'moonshotai/Kimi-K2-Thinking', tools: ['searching'] },
                    { id: 'glm-4.7-search', name: 'GLM-4.7', model: 'zai-org/GLM-4.7', tools: ['searching'] },
                    { id: 'mistral-small', name: 'Mistral-Small-3.2', model: 'mistralai/Mistral-Small-3.2-24B-Instruct-2506' },
                    { id: 'mistral-7b', name: 'Mistral-7B', model: 'mistralai/Mistral-7B-Instruct-v0.3' },
                    { id: 'minimax-m2.1-r', name: 'MiniMax M2.1', model: 'minimax/m2.1-preview' tools: ['searching'] },
                    { id: 'mimo-v2-flash', name: 'MiMo-V2-Flash', model: 'XiaomiMiMo/MiMo-V2-Flash' tools: ['searching'] },
                    { id: 'gemma-3n-r', name: 'Gemma-3n-E4B', model: 'google/gemma-3n-E4B-it' }
                ],
                aggregator: { name: 'Kimi-K2-Thinking', model: 'moonshotai/Kimi-K2-Thinking' }
            },
            code: {
                name: 'Sahu 1 Code',
                icon: 'ðŸ’»',
                tools: ['thinking', 'searching', 'planning'],
                behavior: 'Plan â†’ Reason â†’ Code',
                experts: [
                    { id: 'gpt-oss-120b-c', name: 'GPT-OSS-120B', model: 'openai/gpt-oss-120b' },
                    { id: 'deepseek-v3.2-c', name: 'DeepSeek-V3.2', model: 'deepseek-ai/DeepSeek-V3.2' },
                    { id: 'kimi-k2-think-c', name: 'Kimi-K2-Thinking', model: 'moonshotai/Kimi-K2-Thinking' },
                    { id: 'qwen3-coder', name: 'Qwen3-Coder-480B', model: 'Qwen/Qwen3-Coder-480B-A35B-Instruct' },
                    { id: 'qwen3-235b-c', name: 'Qwen3-235B-Thinking', model: 'Qwen/Qwen3-235B-A22B-Thinking-2507-FP8' },
                    { id: 'deepseek-coder', name: 'DeepSeek-Coder-V2', model: 'deepseek-ai/DeepSeek-Coder-V2-Lite-Instruct' },
                    { id: 'glm-4.7-c', name: 'GLM-4.7', model: 'zai-org/GLM-4.7' },
                    { id: 'devstral', name: 'Devstral-2-123B', model: 'mistralai/Devstral-2-123B-Instruct-2512' },
                    { id: 'codestral', name: 'Codestral-22B', model: 'mistralai/Codestral-22B-v0.1' },
                    { id: 'minimax-m2.1-c', name: 'MiniMax M2.1', model: 'minimax/m2.1-preview' }
                ],
                aggregator: { name: 'GLM-4.7', model: 'zai-org/GLM-4.7' }
            },
            fast: {
                name: 'Sahu 1 Fast',
                icon: 'âš¡',
                tools: [],
                behavior: 'Fastest possible responses',
                experts: [
                    { id: 'gpt-oss-20b-f', name: 'GPT-OSS-20B', model: 'openai/gpt-oss-20b' },
                    { id: 'deepseek-v3.2-f', name: 'DeepSeek-V3.2', model: 'deepseek-ai/DeepSeek-V3.2' },
                    { id: 'kimi-k2-inst', name: 'Kimi-K2-Instruct', model: 'moonshotai/Kimi-K2-Instruct' },
                    { id: 'glm-4.7-flash', name: 'GLM-4.7-Flash', model: 'zai-org/GLM-4.7-Flash' },
                    { id: 'mistral-7b-f', name: 'Mistral-7B', model: 'mistralai/Mistral-7B-Instruct-v0.3' },
                    { id: 'deepseek-r1-distill', name: 'DeepSeek-R1-Distill', model: 'deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B' },
                    { id: 'mimo-v2-flash-f', name: 'MiMo-V2-Flash', model: 'XiaomiMiMo/MiMo-V2-Flash' },
                    { id: 'gemma-3n-f', name: 'Gemma-3n-E4B', model: 'google/gemma-3n-E4B-it' }
                ],
                aggregator: { name: 'MiMo-V2-Flash', model: 'XiaomiMiMo/MiMo-V2-Flash' }
            },
            chat: {
                name: 'Sahu 1 Chat',
                icon: 'ðŸ’¬',
                tools: [],
                behavior: 'General conversation',
                experts: [
                    { id: 'gpt-oss-20b-ch', name: 'GPT-OSS-20B', model: 'openai/gpt-oss-20b' },
                    { id: 'deepseek-v3.2-ch', name: 'DeepSeek-V3.2', model: 'deepseek-ai/DeepSeek-V3.2' },
                    { id: 'kimi-k2-inst-ch', name: 'Kimi-K2-Instruct', model: 'moonshotai/Kimi-K2-Instruct' },
                    { id: 'glm-4.7-ch', name: 'GLM-4.7', model: 'zai-org/GLM-4.7' },
                    { id: 'mistral-small-ch', name: 'Mistral-Small-3.2', model: 'mistralai/Mistral-Small-3.2-24B-Instruct-2506' },
                    { id: 'mistral-7b-ch', name: 'Mistral-7B', model: 'mistralai/Mistral-7B-Instruct-v0.3' },
                    { id: 'minimax-m2.1-ch', name: 'MiniMax M2.1', model: 'minimax/m2.1-preview' },
                    { id: 'mimo-v2-flash-ch', name: 'MiMo-V2-Flash', model: 'XiaomiMiMo/MiMo-V2-Flash' },
                    { id: 'gemma-3n-ch', name: 'Gemma-3n-E4B', model: 'google/gemma-3n-E4B-it' }
                ],
                aggregator: { name: 'GPT-OSS-20B', model: 'openai/gpt-oss-20b' }
            },
            agent: {
                name: 'Sahu 1 Agent',
                icon: 'ðŸ¤–',
                tools: [],
                behavior: 'Auto-detects intent and routes to appropriate MoE',
                experts: [], // Will be determined dynamically
                aggregator: null // Will be determined dynamically
            }
        };
        
        // Provider Configurations
        const PROVIDERS = {
            huggingface: {
                name: 'HuggingFace',
                baseUrl: 'https://router.huggingface.co/v1/chat/completions',
                headerKey: 'Authorization',
                headerPrefix: 'Bearer ',
                streamSupport: true,
                badge: 'badge-hf'
            },
            openrouter: {
                name: 'OpenRouter',
                baseUrl: 'https://openrouter.ai/api/v1/chat/completions',
                headerKey: 'Authorization',
                headerPrefix: 'Bearer ',
                streamSupport: true,
                badge: 'badge-openrouter'
            },
            groq: {
                name: 'Groq',
                baseUrl: 'https://api.groq.com/openai/v1/chat/completions',
                headerKey: 'Authorization',
                headerPrefix: 'Bearer ',
                streamSupport: true,
                badge: 'badge-groq'
            },
            together: {
                name: 'TogetherAI',
                baseUrl: 'https://api.together.xyz/v1/chat/completions',
                headerKey: 'Authorization',
                headerPrefix: 'Bearer ',
                streamSupport: true,
                badge: 'badge-together'
            },
            ollama: {
                name: 'Ollama',
                baseUrl: 'http://localhost:11434/api/chat',
                headerKey: null,
                streamSupport: true,
                badge: 'badge-ollama'
            }
        };
        
        // Model mappings for different providers
        const MODEL_MAPPINGS = {
            huggingface: {
                // HuggingFace Router - Use REAL model IDs directly
                'deepseek-ai/DeepSeek-R1': 'deepseek-ai/DeepSeek-R1',
                'deepseek-ai/DeepSeek-V3.2': 'deepseek-ai/DeepSeek-V3.2',
                'deepseek-ai/DeepSeek-V3': 'deepseek-ai/DeepSeek-V3',
                'openai/gpt-oss-120b': 'openai/gpt-oss-120b',
                'openai/gpt-oss-20b': 'openai/gpt-oss-20b',
                'moonshotai/Kimi-K2-Thinking': 'moonshotai/Kimi-K2-Thinking',
                'moonshotai/Kimi-K2-Instruct': 'moonshotai/Kimi-K2-Instruct',
                'Qwen/Qwen3-235B-A22B-Thinking-2507-FP8': 'Qwen/Qwen3-235B-A22B-Thinking-2507-FP8',
                'Qwen/Qwen3-Coder-480B-A35B-Instruct': 'Qwen/Qwen3-Coder-480B-A35B-Instruct',
                'zai-org/GLM-4.7': 'zai-org/GLM-4.7',
                'zai-org/GLM-4.7-Flash': 'zai-org/GLM-4.7-Flash',
                'mistralai/Mistral-7B-Instruct-v0.3': 'mistralai/Mistral-7B-Instruct-v0.3',
                'mistralai/Mistral-Small-3.2-24B-Instruct-2506': 'mistralai/Mistral-Small-3.2-24B-Instruct-2506',
                'mistralai/Ministral-3-14B-Reasoning-2512': 'mistralai/Ministral-3-14B-Reasoning-2512',
                'mistralai/Devstral-2-123B-Instruct-2512': 'mistralai/Devstral-2-123B-Instruct-2512',
                'mistralai/Codestral-22B-v0.1': 'mistralai/Codestral-22B-v0.1',
                'microsoft/Phi-4-reasoning-plus': 'microsoft/Phi-4-reasoning-plus',
                'google/gemma-3n-E4B-it': 'google/gemma-3n-E4B-it',
                'minimax/m2.1-preview': 'MiniMaxAI/MiniMax-M2.1',
                'XiaomiMiMo/MiMo-V2-Flash': 'XiaomiMiMo/MiMo-V2-Flash',
                'deepseek-ai/DeepSeek-Coder-V2-Lite-Instruct': 'deepseek-ai/DeepSeek-Coder-V2-Lite-Instruct',
                'deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B': 'deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B',
                'default': 'deepseek-ai/DeepSeek-V3'
            },
            openrouter: {
                // OpenRouter uses their own model naming convention
                'deepseek-ai/DeepSeek-R1': 'deepseek/deepseek-r1',
                'deepseek-ai/DeepSeek-V3.2': 'deepseek/deepseek-chat-v3-0324',
                'deepseek-ai/DeepSeek-V3': 'deepseek/deepseek-chat-v3-0324',
                'openai/gpt-oss-120b': 'qwen/qwen3-235b-a22b',
                'openai/gpt-oss-20b': 'qwen/qwen3-32b',
                'moonshotai/Kimi-K2-Thinking': 'moonshotai/kimi-k2',
                'moonshotai/Kimi-K2-Instruct': 'moonshotai/kimi-k2',
                'Qwen/Qwen3-235B-A22B-Thinking-2507-FP8': 'qwen/qwen3-235b-a22b',
                'Qwen/Qwen3-Coder-480B-A35B-Instruct': 'qwen/qwen3-coder-480b-a35b',
                'zai-org/GLM-4.7': 'thudm/glm-4-32b',
                'zai-org/GLM-4.7-Flash': 'thudm/glm-4-32b',
                'mistralai/Mistral-7B-Instruct-v0.3': 'mistralai/mistral-7b-instruct',
                'mistralai/Mistral-Small-3.2-24B-Instruct-2506': 'mistralai/mistral-small-3.1-24b-instruct',
                'mistralai/Codestral-22B-v0.1': 'mistralai/codestral-2501',
                'microsoft/Phi-4-reasoning-plus': 'microsoft/phi-4',
                'google/gemma-3n-E4B-it': 'google/gemma-3-27b-it',
                'XiaomiMiMo/MiMo-V2-Flash': 'qwen/qwen3-32b',
                'deepseek-ai/DeepSeek-Coder-V2-Lite-Instruct': 'deepseek/deepseek-coder',
                'deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B': 'deepseek/deepseek-r1-distill-qwen-32b',
                'default': 'deepseek/deepseek-chat-v3-0324'
            },
            groq: {
                // Groq has limited model selection
                'deepseek-ai/DeepSeek-R1': 'deepseek-r1-distill-llama-70b',
                'deepseek-ai/DeepSeek-V3.2': 'llama-3.3-70b-versatile',
                'mistralai/Mistral-7B-Instruct-v0.3': 'mistral-saba-24b',
                'deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B': 'deepseek-r1-distill-qwen-32b',
                'Qwen/Qwen3-235B-A22B-Thinking-2507-FP8': 'qwen-qwq-32b',
                'zai-org/GLM-4.7': 'llama-3.3-70b-versatile',
                'google/gemma-3n-E4B-it': 'gemma2-9b-it',
                'default': 'llama-3.3-70b-versatile'
            },
            together: {
                // Together AI model IDs
                'deepseek-ai/DeepSeek-R1': 'deepseek-ai/DeepSeek-R1',
                'deepseek-ai/DeepSeek-V3.2': 'deepseek-ai/DeepSeek-V3',
                'deepseek-ai/DeepSeek-V3': 'deepseek-ai/DeepSeek-V3',
                'Qwen/Qwen3-235B-A22B-Thinking-2507-FP8': 'Qwen/Qwen2.5-72B-Instruct-Turbo',
                'Qwen/Qwen3-Coder-480B-A35B-Instruct': 'Qwen/Qwen2.5-Coder-32B-Instruct',
                'mistralai/Mistral-7B-Instruct-v0.3': 'mistralai/Mistral-7B-Instruct-v0.3',
                'mistralai/Codestral-22B-v0.1': 'codellama/CodeLlama-34b-Instruct-hf',
                'google/gemma-3n-E4B-it': 'google/gemma-2-27b-it',
                'default': 'meta-llama/Llama-3.3-70B-Instruct-Turbo'
            },
            ollama: {
                // Ollama uses simple model names
                'deepseek-ai/DeepSeek-R1': 'deepseek-r1',
                'deepseek-ai/DeepSeek-V3': 'deepseek-v3',
                'mistralai/Mistral-7B-Instruct-v0.3': 'mistral',
                'mistralai/Codestral-22B-v0.1': 'codestral',
                'google/gemma-3n-E4B-it': 'gemma2',
                'Qwen/Qwen3-235B-A22B-Thinking-2507-FP8': 'qwen2.5',
                'default': 'llama3.2'
            }
        };
        
        // ==========================================
        // Utility Functions
        // ==========================================
        
        function generateId() {
            return 'id_' + Math.random().toString(36).substr(2, 9);
        }
        
        function formatTime(date) {
            return new Intl.DateTimeFormat('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            }).format(date);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Simple markdown parser
        function parseMarkdown(text) {
            if (!text) return '';
            
            // Code blocks
            text = text.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code class="language-$1">$2</code></pre>');
            
            // Inline code
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Bold
            text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // Italic
            text = text.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            
            // Headers
            text = text.replace(/^### (.+)$/gm, '<h3>$1</h3>');
            text = text.replace(/^## (.+)$/gm, '<h2>$1</h2>');
            text = text.replace(/^# (.+)$/gm, '<h1>$1</h1>');
            
            // Lists
            text = text.replace(/^\- (.+)$/gm, '<li>$1</li>');
            text = text.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
            
            // Blockquotes
            text = text.replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>');
            
            // Line breaks
            text = text.replace(/\n\n/g, '</p><p>');
            text = text.replace(/\n/g, '<br>');
            
            return `<p>${text}</p>`;
        }
        
        // ==========================================
        // Storage Functions
        // ==========================================
        
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('sahu_settings') || '{}');
            
            document.getElementById('hfApiKey').value = settings.hfApiKey || '';
            document.getElementById('orApiKey').value = settings.orApiKey || '';
            document.getElementById('groqApiKey').value = settings.groqApiKey || '';
            document.getElementById('togetherApiKey').value = settings.togetherApiKey || '';
            document.getElementById('ollamaEndpoint').value = settings.ollamaEndpoint || 'http://localhost:11434';
            document.getElementById('showExperts').checked = settings.showExperts !== false;
            document.getElementById('enableStreaming').checked = settings.enableStreaming !== false;
            document.getElementById('maxTokens').value = settings.maxTokens || 4096;
            document.getElementById('temperature').value = settings.temperature || 0.7;
            document.getElementById('tempValue').textContent = settings.temperature || 0.7;
            
            state.theme = settings.theme || 'dark';
            applyTheme();
            
            state.currentProvider = settings.provider || 'huggingface';
            document.getElementById('providerSelector').value = state.currentProvider;
        }
        
        function saveSettings() {
            const settings = {
                hfApiKey: document.getElementById('hfApiKey').value,
                orApiKey: document.getElementById('orApiKey').value,
                groqApiKey: document.getElementById('groqApiKey').value,
                togetherApiKey: document.getElementById('togetherApiKey').value,
                ollamaEndpoint: document.getElementById('ollamaEndpoint').value,
                showExperts: document.getElementById('showExperts').checked,
                enableStreaming: document.getElementById('enableStreaming').checked,
                maxTokens: parseInt(document.getElementById('maxTokens').value),
                temperature: parseFloat(document.getElementById('temperature').value),
                theme: state.theme,
                provider: state.currentProvider
            };
            
            localStorage.setItem('sahu_settings', JSON.stringify(settings));
            closeSettings();
            showToast('Settings saved successfully');
        }
        
        function getApiKey(provider) {
            const settings = JSON.parse(localStorage.getItem('sahu_settings') || '{}');
            const keyMap = {
                huggingface: settings.hfApiKey,
                openrouter: settings.orApiKey,
                groq: settings.groqApiKey,
                together: settings.togetherApiKey,
                ollama: null
            };
            return keyMap[provider] || '';
        }
        
        function getSettings() {
            return JSON.parse(localStorage.getItem('sahu_settings') || '{}');
        }
        
        // Chat History Storage
        function loadChatHistory() {
            state.chatHistory = JSON.parse(localStorage.getItem('sahu_chats') || '[]');
            renderChatHistory();
        }
        
        function saveChatHistory() {
            localStorage.setItem('sahu_chats', JSON.stringify(state.chatHistory));
            renderChatHistory();
        }
        
        function renderChatHistory() {
            const container = document.getElementById('chatHistory');
            container.innerHTML = state.chatHistory.map(chat => `
                <button onclick="loadChat('${chat.id}')" class="w-full p-2 rounded-lg hover:bg-[var(--bg-tertiary)] flex items-center gap-2 text-left text-sm truncate ${state.currentChatId === chat.id ? 'bg-[var(--bg-tertiary)]' : ''}">
                    <i class="fas fa-message text-xs text-[var(--text-secondary)]"></i>
                    <span class="truncate">${escapeHtml(chat.title)}</span>
                </button>
            `).join('');
        }
        
        // ==========================================
        // UI Functions
        // ==========================================
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }
        
        function toggleTheme() {
            state.theme = state.theme === 'dark' ? 'light' : 'dark';
            applyTheme();
            saveSettings();
        }
        
        function applyTheme() {
            document.body.classList.toggle('light-theme', state.theme === 'light');
            document.getElementById('themeIcon').className = state.theme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
        }
        
        function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
        }
        
        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-24 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg bg-purple-600 text-white shadow-lg z-50';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        function changeMoEMode() {
            state.currentMode = document.getElementById('moeSelector').value;
            updateModeDisplay();
            updateToolsIndicator();
        }
        
        function selectMode(mode) {
            state.currentMode = mode;
            document.getElementById('moeSelector').value = mode;
            updateModeDisplay();
            updateToolsIndicator();
        }
        
        function updateModeDisplay() {
            const config = MOE_CONFIGS[state.currentMode];
            document.getElementById('currentModeDisplay').innerHTML = `
                <span class="text-lg">${config.icon}</span>
                <span class="font-medium">${config.name}</span>
            `;
        }
        
        function updateToolsIndicator() {
            const config = MOE_CONFIGS[state.currentMode];
            const indicator = document.getElementById('toolsIndicator');
            
            if (config.tools && config.tools.length > 0) {
                indicator.classList.remove('hidden');
                indicator.innerHTML = config.tools.map(tool => `
                    <span class="px-2 py-1 rounded-full text-xs bg-purple-600/20 text-purple-400 flex items-center gap-1">
                        <i class="fas fa-${getToolIcon(tool)}"></i>
                        ${tool}
                    </span>
                `).join('');
            } else {
                indicator.classList.add('hidden');
            }
        }
        
        function getToolIcon(tool) {
            const icons = {
                thinking: 'brain',
                searching: 'search',
                planning: 'list-check'
            };
            return icons[tool] || 'cog';
        }
        
        function changeProvider() {
            state.currentProvider = document.getElementById('providerSelector').value;
        }
        
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
        }
        
        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                state.uploadedFiles.push(file);
                showToast(`File "${file.name}" attached`);
            }
        }
        
        // ==========================================
        // Chat Functions
        // ==========================================
        
        function startNewChat() {
            state.currentChatId = generateId();
            document.getElementById('welcomeScreen').classList.remove('hidden');
            document.getElementById('messagesContainer').classList.add('hidden');
            document.getElementById('messagesContainer').innerHTML = '';
            document.getElementById('userInput').value = '';
            state.uploadedFiles = [];
            state.toolBuffer = [];
        }
        
        function loadChat(chatId) {
            const chat = state.chatHistory.find(c => c.id === chatId);
            if (!chat) return;
            
            state.currentChatId = chatId;
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('messagesContainer').classList.remove('hidden');
            document.getElementById('messagesContainer').innerHTML = '';
            
            // Render all messages from this chat
            chat.messages.forEach(msg => {
                if (msg.role === 'user') {
                    appendUserMessage(msg.content);
                } else {
                    appendAssistantMessage(msg);
                }
            });
            
            renderChatHistory();
        }
        
        function appendUserMessage(content) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex justify-end';
            messageDiv.innerHTML = `
                <div class="message-user max-w-2xl px-4 py-3 rounded-2xl rounded-br-md text-white">
                    <p class="whitespace-pre-wrap">${escapeHtml(content)}</p>
                </div>
            `;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        function appendAssistantMessage(msg) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'space-y-4';
            
            let html = '';
            
            // Tools section
            if (msg.tools && msg.tools.length > 0) {
                html += `
                    <div class="flex items-center gap-2 text-sm text-[var(--text-secondary)]">
                        ${msg.tools.map(t => `<span class="px-2 py-1 rounded-full bg-purple-600/20 text-purple-400"><i class="fas fa-${getToolIcon(t)}"></i> ${t}</span>`).join('')}
                    </div>
                `;
            }
            
            // Expert outputs
            if (msg.experts && msg.experts.length > 0) {
                html += `
                    <div class="expert-grid">
                        ${msg.experts.map(exp => `
                            <div class="expert-card rounded-xl p-4 border">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="font-medium text-sm">${exp.name}</span>
                                    <span class="text-xs px-2 py-0.5 rounded-full bg-[var(--accent)]/20 text-[var(--accent)]">${exp.provider || 'Expert'}</span>
                                </div>
                                <div class="text-sm text-[var(--text-secondary)] markdown-content max-h-48 overflow-y-auto">
                                    ${parseMarkdown(exp.output)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Final answer
            if (msg.finalAnswer) {
                html += `
                    <div class="final-answer rounded-xl p-4">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-600 to-pink-500 flex items-center justify-center">
                                <i class="fas fa-star text-white text-sm"></i>
                            </div>
                            <div>
                                <span class="font-semibold">Final Expert</span>
                                <span class="text-sm text-[var(--text-secondary)]"> Â· ${msg.aggregator || 'Aggregator'}</span>
                            </div>
                        </div>
                        <div class="markdown-content">
                            ${parseMarkdown(msg.finalAnswer)}
                        </div>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = html;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }
        
        // ==========================================
        // Provider & API Functions
        // ==========================================
        
        function resolveModel(modelId, provider) {
            const mappings = MODEL_MAPPINGS[provider] || {};
            // First check if there's a specific mapping, otherwise use the model ID directly
            // This ensures real model IDs are passed through as-is
            if (mappings[modelId]) {
                return mappings[modelId];
            }
            // For HuggingFace, always try to use the original model ID first
            if (provider === 'huggingface') {
                return modelId;
            }
            // For other providers, fall back to default if no mapping exists
            return mappings['default'] || modelId;
        }
        
        function buildApiRequest(provider, model, messages, stream = true) {
            const settings = getSettings();
            const providerConfig = PROVIDERS[provider];
            
            const headers = {
                'Content-Type': 'application/json'
            };
            
            const apiKey = getApiKey(provider);
            if (providerConfig.headerKey && apiKey) {
                headers[providerConfig.headerKey] = (providerConfig.headerPrefix || '') + apiKey;
            }
            
            // Add OpenRouter specific headers
            if (provider === 'openrouter') {
                headers['HTTP-Referer'] = window.location.origin;
                headers['X-Title'] = 'SAHU 1 MoE';
            }
            
            let url = providerConfig.baseUrl;
            let body;
            
            if (provider === 'huggingface') {
                // Using HuggingFace Router - OpenAI compatible endpoint
                url = providerConfig.baseUrl;
                const resolvedModel = resolveModel(model, provider);
                body = {
                    model: resolvedModel,
                    messages: messages,
                    max_tokens: settings.maxTokens || 4096,
                    temperature: settings.temperature || 0.7,
                    stream: stream
                };
            } else if (provider === 'ollama') {
                url = settings.ollamaEndpoint ? `${settings.ollamaEndpoint}/api/chat` : url;
                body = {
                    model: resolveModel(model, provider),
                    messages: messages,
                    stream: stream
                };
            } else {
                // OpenAI-compatible API (OpenRouter, Groq, Together)
                body = {
                    model: resolveModel(model, provider),
                    messages: messages,
                    max_tokens: settings.maxTokens || 4096,
                    temperature: settings.temperature || 0.7,
                    stream: stream
                };
            }
            
            return { url, headers, body };
        }
        
        // ==========================================
        // Streaming Handler
        // ==========================================
        
        async function* streamResponse(response, provider) {
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            
            try {
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    
                    // Parse based on provider format
                    if (provider === 'ollama') {
                        // Ollama sends JSON per line
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || '';
                        
                        for (const line of lines) {
                            if (line.trim()) {
                                try {
                                    const json = JSON.parse(line);
                                    if (json.message?.content) {
                                        yield json.message.content;
                                    }
                                } catch (e) {}
                            }
                        }
                    } else if (provider === 'huggingface') {
                        // HuggingFace Router uses OpenAI-compatible SSE format
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || '';
                        
                        for (const line of lines) {
                            if (line.startsWith('data:')) {
                                const data = line.slice(5).trim();
                                if (data && data !== '[DONE]') {
                                    try {
                                        const json = JSON.parse(data);
                                        // OpenAI compatible format
                                        const content = json.choices?.[0]?.delta?.content;
                                        if (content) {
                                            yield content;
                                        }
                                    } catch (e) {}
                                }
                            }
                        }
                    } else {
                        // SSE format (OpenRouter, Groq, Together)
                        const lines = buffer.split('\n');
                        buffer = lines.pop() || '';
                        
                        for (const line of lines) {
                            if (line.startsWith('data:')) {
                                const data = line.slice(5).trim();
                                if (data && data !== '[DONE]') {
                                    try {
                                        const json = JSON.parse(data);
                                        const content = json.choices?.[0]?.delta?.content;
                                        if (content) {
                                            yield content;
                                        }
                                    } catch (e) {}
                                }
                            }
                        }
                    }
                }
            } finally {
                reader.releaseLock();
            }
        }
        
        // ==========================================
        // Expert Runner - With Word-by-Word Streaming
        // ==========================================
        
        async function runExpert(expert, userMessage, toolContext, cardElement) {
            const provider = state.currentProvider;
            const settings = getSettings();
            
            // Build messages with tool context
            let systemPrompt = `You are an AI expert named "${expert.name}" (Developed by Saksham Intelligence). You are part of the SAHU 1-series Mixture of Experts system. Provide your best analysis and response.`;
            
            if (toolContext && toolContext.length > 0) {
                systemPrompt += `\n\nTool Outputs:\n${toolContext.map(t => `[${t.tool}]: ${t.output}`).join('\n')}`;
            }
            
            const messages = [
                { role: 'system', content: systemPrompt },
                { role: 'user', content: userMessage }
            ];
            
            // Always try to stream for word-by-word effect
            const { url, headers, body } = buildApiRequest(provider, expert.model, messages, true);
            
            try {
                // Create a unique abort controller for each expert
                const expertAbortController = new AbortController();
                
                // Link to main abort controller
                if (state.abortController) {
                    state.abortController.signal.addEventListener('abort', () => {
                        expertAbortController.abort();
                    });
                }
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(body),
                    signal: expertAbortController.signal
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }
                
                const outputElement = cardElement.querySelector('.expert-output');
                let fullOutput = '';
                let lastRenderTime = Date.now();
                const minRenderInterval = 25; // Smooth word-by-word effect
                
                if (response.body) {
                    // Streaming response with word-by-word effect
                    for await (const token of streamResponse(response, provider)) {
                        if (expertAbortController.signal.aborted) break;
                        
                        fullOutput += token;
                        
                        // Render at intervals for smooth word-by-word effect
                        const now = Date.now();
                        if (now - lastRenderTime >= minRenderInterval || token.includes(' ') || token.includes('\n')) {
                            outputElement.innerHTML = parseMarkdown(fullOutput);
                            lastRenderTime = now;
                            
                            // Small delay for visual word-by-word effect
                            await new Promise(resolve => setTimeout(resolve, 8));
                        }
                    }
                    
                    // Final render
                    outputElement.innerHTML = parseMarkdown(fullOutput);
                } else {
                    // Non-streaming fallback with word-by-word display
                    const data = await response.json();
                    
                    if (provider === 'huggingface') {
                        fullOutput = data.choices?.[0]?.message?.content || '';
                    } else if (provider === 'ollama') {
                        fullOutput = data.message?.content || '';
                    } else {
                        fullOutput = data.choices?.[0]?.message?.content || '';
                    }
                    
                    // Display word by word
                    await displayWordByWord(outputElement, fullOutput, 15);
                }
                
                // Remove loading state
                cardElement.querySelector('.loading-indicator')?.remove();
                
                return fullOutput;
            } catch (error) {
                if (error.name === 'AbortError') {
                    return '[Stopped]';
                }
                console.error(`Expert ${expert.name} error:`, error);
                cardElement.querySelector('.loading-indicator')?.remove();
                cardElement.querySelector('.expert-output').innerHTML = `<span class="text-red-400"><i class="fas fa-exclamation-circle mr-1"></i>Error: ${error.message}</span>`;
                return `[Error: ${error.message}]`;
            }
        }
        
        // ==========================================
        // Word-by-Word Display Helper
        // ==========================================
        
        async function displayWordByWord(element, text, delayMs = 20) {
            const words = text.split(/(\s+)/);
            let displayed = '';
            
            for (const word of words) {
                if (state.abortController?.signal.aborted) break;
                displayed += word;
                element.innerHTML = parseMarkdown(displayed);
                element.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                await new Promise(resolve => setTimeout(resolve, delayMs));
            }
            
            return displayed;
        }
        
        // ==========================================
        // Aggregator Runner - Enhanced with Thinking & Analysis
        // ==========================================
        
        async function runAggregator(aggregator, userMessage, expertOutputs, toolContext, containerElement) {
            const provider = state.currentProvider;
            const settings = getSettings();
            
            // Get output element
            const outputElement = containerElement.querySelector('.aggregator-output');
            
            // Phase 1: Reading expert outputs (visual feedback)
            outputElement.innerHTML = '<div class="text-purple-400 mb-3"><i class="fas fa-book-reader mr-2"></i><em>Reading all expert outputs...</em></div>';
            await new Promise(resolve => setTimeout(resolve, 800));
            
            // Build comprehensive aggregator prompt with thinking instructions
            const systemPrompt = `You are the Final Expert Aggregator named "${aggregator.name}" (Developed by Saksham Intelligence) in the SAHU 1-series Mixture of Experts system.

You have received responses from ${expertOutputs.length} expert AI models. Your task is to:

1. **THINK**: First, internally analyze each expert's response - identify key insights, strengths, weaknesses, and unique perspectives.

2. **ANALYZE/COMPARE**: Compare the expert responses, noting agreements, disagreements, and complementary information.

3. **SYNTHESIZE**: Combine the best elements from all experts into a comprehensive, accurate, and well-structured final answer.

4. **VERIFY**: Ensure your final answer is consistent, factually accurate (based on expert consensus), and directly addresses the user's question.

=== EXPERT OUTPUTS ===
${expertOutputs.map((exp, i) => `
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
EXPERT ${i + 1}: ${exp.name}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
${exp.output}
`).join('\n')}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

${toolContext && toolContext.length > 0 ? `
=== TOOL OUTPUTS ===
${toolContext.map(t => `[${t.tool.toUpperCase()}]: ${t.output}`).join('\n')}
` : ''}

IMPORTANT INSTRUCTIONS:
- Structure your response with clear sections when appropriate
- If experts disagree, explain the different perspectives and provide the most accurate answer
- Credit specific insights to experts when relevant (e.g., "As noted by Expert 1...")
- Be comprehensive but concise
- Use markdown formatting for clarity`;

            const userPrompt = `Based on all the expert analyses provided above, please:

1. First, briefly share your thinking about what each expert contributed (2-3 sentences)
2. Then, provide your analysis of where experts agree/disagree (2-3 sentences)  
3. Finally, give your comprehensive FINAL ANSWER to the user's question:

"${userMessage}"

Begin your response now:`;
            
            const messages = [
                { role: 'system', content: systemPrompt },
                { role: 'user', content: userPrompt }
            ];
            
            // Phase 2: Thinking indicator
            outputElement.innerHTML = '<div class="text-purple-400 mb-3"><i class="fas fa-brain mr-2 fa-pulse"></i><em>Thinking and analyzing expert responses...</em></div>';
            await new Promise(resolve => setTimeout(resolve, 600));
            
            const { url, headers, body } = buildApiRequest(provider, aggregator.model, messages, true); // Always stream for aggregator
            
            try {
                state.abortController = new AbortController();
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(body),
                    signal: state.abortController.signal
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }
                
                // Clear the thinking indicator
                outputElement.innerHTML = '';
                
                let fullOutput = '';
                let tokenBuffer = '';
                let lastRenderTime = Date.now();
                const minRenderInterval = 30; // Minimum ms between renders for smooth word-by-word effect
                
                if (response.body) {
                    // Streaming response with word-by-word effect
                    for await (const token of streamResponse(response, provider)) {
                        if (state.abortController?.signal.aborted) break;
                        
                        tokenBuffer += token;
                        fullOutput += token;
                        
                        // Render at intervals for smooth word-by-word effect
                        const now = Date.now();
                        if (now - lastRenderTime >= minRenderInterval || token.includes(' ') || token.includes('\n')) {
                            outputElement.innerHTML = parseMarkdown(fullOutput);
                            containerElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            lastRenderTime = now;
                            tokenBuffer = '';
                            
                            // Small delay for word-by-word effect
                            await new Promise(resolve => setTimeout(resolve, 10));
                        }
                    }
                    
                    // Final render
                    outputElement.innerHTML = parseMarkdown(fullOutput);
                } else {
                    // Non-streaming fallback with word-by-word display
                    const data = await response.json();
                    
                    if (provider === 'huggingface') {
                        fullOutput = data.choices?.[0]?.message?.content || '';
                    } else if (provider === 'ollama') {
                        fullOutput = data.message?.content || '';
                    } else {
                        fullOutput = data.choices?.[0]?.message?.content || '';
                    }
                    
                    // Display word by word
                    await displayWordByWord(outputElement, fullOutput);
                }
                
                containerElement.querySelector('.loading-indicator')?.remove();
                
                return fullOutput;
            } catch (error) {
                if (error.name === 'AbortError') {
                    return '[Stopped]';
                }
                console.error('Aggregator error:', error);
                outputElement.innerHTML = `<span class="text-red-400"><i class="fas fa-exclamation-triangle mr-2"></i>Error: ${error.message}</span>`;
                return `[Error: ${error.message}]`;
            }
        }
        
        // ==========================================
        // Tool Execution
        // ==========================================
        
        async function executeTools(tools, userMessage) {
            const toolResults = [];
            
            for (const tool of tools) {
                if (tool === 'thinking') {
                    // Simulate thinking process
                    toolResults.push({
                        tool: 'thinking',
                        output: `Analyzing the query: "${userMessage.substring(0, 100)}..."\nIdentifying key concepts and reasoning steps.\nFormulating approach for comprehensive response.`
                    });
                } else if (tool === 'searching') {
                    // Simulate search (in production, this would call a search API)
                    await new Promise(resolve => setTimeout(resolve, 1500)); // Research mode delay
                    toolResults.push({
                        tool: 'searching',
                        output: `Searched for: "${userMessage.substring(0, 50)}..."\nGathering relevant information from knowledge base.\nNote: Real-time web search requires additional API integration.`
                    });
                } else if (tool === 'planning') {
                    toolResults.push({
                        tool: 'planning',
                        output: `Planning approach for: "${userMessage.substring(0, 50)}..."\nStep 1: Understand requirements\nStep 2: Design solution architecture\nStep 3: Implement with best practices\nStep 4: Review and optimize`
                    });
                }
            }
            
            return toolResults;
        }
        
        // ==========================================
        // Agent Mode - Intent Detection
        // ==========================================
        
        function detectIntent(message) {
            const msg = message.toLowerCase();
            
            // Code-related keywords
            if (/\b(code|program|function|class|api|debug|implement|develop|script|algorithm|syntax|compile|runtime|bug|error)\b/.test(msg)) {
                return 'code';
            }
            
            // Research keywords
            if (/\b(research|study|analyze|investigate|compare|review|explain in detail|comprehensive|in-depth|sources|evidence)\b/.test(msg)) {
                return 'research';
            }
            
            // Reasoning keywords
            if (/\b(think|reason|logic|deduce|infer|conclude|step by step|analyze|evaluate|consider|why|how does)\b/.test(msg)) {
                return 'deepthink';
            }
            
            // Quick/simple queries
            if (msg.length < 50 || /\b(quick|fast|briefly|short|simple|what is|who is|when|where)\b/.test(msg)) {
                return 'fast';
            }
            
            // Default to chat
            return 'chat';
        }
        
        // ==========================================
        // Main Send Message Function
        // ==========================================
        
        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (!message || state.isGenerating) return;
            
            // Check for API key
            const apiKey = getApiKey(state.currentProvider);
            if (!apiKey && state.currentProvider !== 'ollama') {
                showToast('Please configure your API key in Settings');
                openSettings();
                return;
            }
            
            // Start new chat if needed
            if (!state.currentChatId) {
                state.currentChatId = generateId();
            }
            
            // Hide welcome screen, show messages
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('messagesContainer').classList.remove('hidden');
            
            // Clear input
            input.value = '';
            input.style.height = 'auto';
            
            // Show user message
            appendUserMessage(message);
            
            // Update UI state
            state.isGenerating = true;
            document.getElementById('sendButton').classList.add('hidden');
            document.getElementById('stopButton').classList.remove('hidden');
            
            // Determine mode (handle Agent mode)
            let activeMode = state.currentMode;
            if (activeMode === 'agent') {
                activeMode = detectIntent(message);
                showToast(`Agent routed to: ${MOE_CONFIGS[activeMode].name}`);
            }
            
            const config = MOE_CONFIGS[activeMode];
            const container = document.getElementById('messagesContainer');
            
            // Create response container
            const responseDiv = document.createElement('div');
            responseDiv.className = 'space-y-4';
            container.appendChild(responseDiv);
            
            // Execute tools if any
            let toolContext = [];
            if (config.tools && config.tools.length > 0) {
                // Show tool execution status
                const toolDiv = document.createElement('div');
                toolDiv.className = 'flex items-center gap-2 text-sm text-purple-400';
                toolDiv.innerHTML = config.tools.map(t => `
                    <span class="px-2 py-1 rounded-full bg-purple-600/20 flex items-center gap-1 tool-active">
                        <i class="fas fa-${getToolIcon(t)} fa-spin"></i>
                        ${t}
                    </span>
                `).join('');
                responseDiv.appendChild(toolDiv);
                
                toolContext = await executeTools(config.tools, message);
                state.toolBuffer = toolContext;
                
                // Update tool display to complete
                toolDiv.innerHTML = config.tools.map(t => `
                    <span class="px-2 py-1 rounded-full bg-green-600/20 text-green-400 flex items-center gap-1">
                        <i class="fas fa-check"></i>
                        ${t}
                    </span>
                `).join('');
            }
            
            // Create expert grid
            const settings = getSettings();
            const expertOutputs = [];
            
            if (settings.showExperts !== false && config.experts.length > 0) {
                const expertGrid = document.createElement('div');
                expertGrid.className = 'expert-grid';
                
                // Create cards for each expert
                const expertCards = config.experts.map(expert => {
                    const card = document.createElement('div');
                    card.className = 'expert-card rounded-xl p-4 border';
                    card.id = `expert-${expert.id}`;
                    card.innerHTML = `
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-medium text-sm">${expert.name}</span>
                            <span class="text-xs px-2 py-0.5 rounded-full ${PROVIDERS[state.currentProvider].badge} text-white">${PROVIDERS[state.currentProvider].name}</span>
                        </div>
                        <div class="loading-indicator flex items-center gap-2 text-sm text-[var(--text-secondary)] mb-2">
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Generating...</span>
                        </div>
                        <div class="expert-output text-sm text-[var(--text-secondary)] markdown-content max-h-48 overflow-y-auto"></div>
                    `;
                    expertGrid.appendChild(card);
                    return { expert, card };
                });
                
                responseDiv.appendChild(expertGrid);
                
                // Run all experts in parallel
                const expertPromises = expertCards.map(async ({ expert, card }) => {
                    const output = await runExpert(expert, message, toolContext, card);
                    return { name: expert.name, output };
                });
                
                const results = await Promise.all(expertPromises);
                expertOutputs.push(...results);
            }
            
            // Run aggregator
            if (config.aggregator) {
                const aggregatorDiv = document.createElement('div');
                aggregatorDiv.className = 'final-answer rounded-xl p-4';
                aggregatorDiv.innerHTML = `
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-purple-600 to-pink-500 flex items-center justify-center">
                            <i class="fas fa-brain text-white text-lg"></i>
                        </div>
                        <div>
                            <span class="font-bold text-lg">Final Expert</span>
                            <span class="text-sm text-[var(--text-secondary)]"> Â· ${config.aggregator.name}</span>
                            <div class="text-xs text-purple-400">Analyzing ${expertOutputs.length} expert responses</div>
                        </div>
                    </div>
                    <div class="loading-indicator flex items-center gap-3 text-sm text-purple-400 mb-3 p-3 rounded-lg bg-purple-600/10">
                        <div class="flex gap-1">
                            <span class="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 0ms"></span>
                            <span class="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 150ms"></span>
                            <span class="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 300ms"></span>
                        </div>
                        <span>Reading expert outputs â†’ Thinking â†’ Analyzing â†’ Synthesizing final answer...</span>
                    </div>
                    <div class="aggregator-output markdown-content"></div>
                `;
                responseDiv.appendChild(aggregatorDiv);
                
                const finalAnswer = await runAggregator(config.aggregator, message, expertOutputs, toolContext, aggregatorDiv);
                
                // Save to chat history
                const chat = state.chatHistory.find(c => c.id === state.currentChatId);
                const messageData = {
                    role: 'assistant',
                    tools: config.tools,
                    experts: expertOutputs,
                    finalAnswer: finalAnswer,
                    aggregator: config.aggregator.name
                };
                
                if (chat) {
                    chat.messages.push({ role: 'user', content: message });
                    chat.messages.push(messageData);
                } else {
                    state.chatHistory.unshift({
                        id: state.currentChatId,
                        title: message.substring(0, 50) + (message.length > 50 ? '...' : ''),
                        messages: [
                            { role: 'user', content: message },
                            messageData
                        ],
                        createdAt: new Date().toISOString()
                    });
                }
                
                saveChatHistory();
            }
            
            // Reset UI state
            state.isGenerating = false;
            state.abortController = null;
            document.getElementById('sendButton').classList.remove('hidden');
            document.getElementById('stopButton').classList.add('hidden');
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }
        
        function stopGeneration() {
            if (state.abortController) {
                state.abortController.abort();
                state.abortController = null;
            }
            state.isGenerating = false;
            document.getElementById('sendButton').classList.remove('hidden');
            document.getElementById('stopButton').classList.add('hidden');
            showToast('Generation stopped');
        }
        
        // ==========================================
        // Initialization
        // ==========================================
        
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            loadChatHistory();
            updateModeDisplay();
            updateToolsIndicator();
            
            // Temperature slider
            document.getElementById('temperature').addEventListener('input', (e) => {
                document.getElementById('tempValue').textContent = e.target.value;
            });
            
            // Focus input on load
            document.getElementById('userInput').focus();
            
            console.log('%c SAHU 1 MoE System Initialized ', 'background: linear-gradient(135deg, #7c3aed, #ec4899); color: white; font-size: 14px; padding: 10px; border-radius: 5px;');
            console.log('Developed by Saksham Intelligence');
        });
        
        // Handle special queries about the system
        const originalSendMessage = sendMessage;
        sendMessage = async function() {
            const input = document.getElementById('userInput');
            const message = input.value.trim().toLowerCase();
            
            // Check for system queries
            if (message.includes('who made you') || message.includes('who created you') || message.includes('who developed you')) {
                input.value = '';
                appendUserMessage(message);
                
                const container = document.getElementById('messagesContainer');
                document.getElementById('welcomeScreen').classList.add('hidden');
                container.classList.remove('hidden');
                
                const responseDiv = document.createElement('div');
                responseDiv.className = 'final-answer rounded-xl p-4';
                responseDiv.innerHTML = `
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-600 to-pink-500 flex items-center justify-center">
                            <i class="fas fa-brain text-white text-sm"></i>
                        </div>
                        <div>
                            <span class="font-semibold">SAHU 1 MoE</span>
                        </div>
                    </div>
                    <div class="markdown-content">
                        <p>I am <strong>SAHU 1</strong>, a Mixture of Experts system. Each Expert in this system was <strong>Developed by Saksham Intelligence</strong>.</p>
                        <p>I combine multiple AI models to provide comprehensive, well-reasoned responses across different domains including reasoning, research, coding, and general conversation.</p>
                    </div>
                `;
                container.appendChild(responseDiv);
                return;
            }
            
            if (message.includes('what model') || message.includes('what moe') || message.includes('what system')) {
                input.value = '';
                appendUserMessage(message);
                
                const container = document.getElementById('messagesContainer');
                document.getElementById('welcomeScreen').classList.add('hidden');
                container.classList.remove('hidden');
                
                const config = MOE_CONFIGS[state.currentMode];
                const responseDiv = document.createElement('div');
                responseDiv.className = 'final-answer rounded-xl p-4';
                responseDiv.innerHTML = `
                    <div class="flex items-center gap-2 mb-3">
                        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-600 to-pink-500 flex items-center justify-center">
                            <i class="fas fa-brain text-white text-sm"></i>
                        </div>
                        <div>
                            <span class="font-semibold">SAHU 1 MoE</span>
                        </div>
                    </div>
                    <div class="markdown-content">
                        <p>I am the <strong>SAHU 1-series</strong> Mixture of Experts system.</p>
                        <p>Currently running in <strong>${config.name}</strong> mode with ${config.experts.length} expert models.</p>
                        <p><strong>Experts:</strong></p>
                        <ul>
                            ${config.experts.map(e => `<li>${e.name} (Developed by Saksham Intelligence)</li>`).join('')}
                        </ul>
                        ${config.aggregator ? `<p><strong>Aggregator:</strong> ${config.aggregator.name}</p>` : ''}
                    </div>
                `;
                container.appendChild(responseDiv);
                return;
            }
            
            return originalSendMessage();
        };
    </script>
</body>
</html>
